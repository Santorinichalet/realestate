<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تقرير المبنى</title>
<style>
  :root{--ink:#0f172a;--border:#334155;--muted:#475569;}
  body{margin:0;background:#f6f7fb;color:var(--ink);font-family:system-ui,-apple-system,"Noto Naskh Arabic",Tahoma}
  /* شريط علوي */
  .toolbar{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:99;background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08);display:flex;gap:8px}
  .btn{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  /* صفحة A4 مع الخلفية */
  #printRoot .page{position:relative;width:210mm;height:297mm;background:#fff;overflow:hidden}
  #printRoot .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none}
  /* الهيدر */
  .hdr{position:absolute;top:12mm;left:12mm;right:12mm;text-align:center;z-index:2}
  .hdr .logo{height:12mm;display:block;margin:0 auto}
  .hdr .row{display:flex;justify-content:space-between;gap:8px;color:#1f2937;font-weight:600;margin-top:6mm}
  .hdr .cell{border:1px solid var(--border);padding:6px 8px;border-radius:6px;flex:1;text-align:center;background:#fff}
  /* المحتوى */
  .content{position:absolute;inset:58mm 12mm 12mm 12mm;z-index:2}
  h3{margin:0 0 4mm}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border);background:#fff}
  th,td{border:1px solid var(--border);padding:4px 6px;font-size:12px}
  thead th{background:#f3f4f6}
  .c{text-align:center}
  .sum{color:#dc2626;font-weight:800}
  .section{margin-bottom:6mm}
</style>
</head>
<body>
<div class="toolbar">
  <button class="btn" onclick="history.back()">رجوع</button>
  <button class="btn primary" id="btnPDF">تصدير PDF</button>
</div>

<div id="printRoot"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  // روابط الخلفية والشعار (كما في نسختك)
  const ORN_BG = "https://i.ibb.co/W4jvtDdH/img-1759573008406.png";
  const LOGO   = "https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png";

  // قراءة الحمولة من localStorage (نفس المفتاح السابق)
  let payload = { buildingName:"—", year:new Date().getFullYear(), month:new Date().getMonth()+1,
                  apartments:[], shops:[], expenses:[], header: {contact:"", location:""} };
  try{
    const raw = localStorage.getItem("pm_report_payload");
    if(raw) payload = {...payload, ...JSON.parse(raw)};
  }catch{}

  const yyyy = +payload.year, mm = String(payload.month).padStart(2,"0");
  const fmt  = d => d ? new Date(d).toISOString().slice(0,10) : "";

  // المجاميع
  const totalApt   = payload.apartments.reduce((s,t)=>s+Number(t.rent||0),0);
  const totalShop  = payload.shops.reduce((s,t)=>s+Number(t.rent||0),0);
  const billsTotal = payload.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
  const grand      = totalApt + totalShop;
  const mgmt       = +(grand * 0.15).toFixed(2);
  const afterAll   = +(grand - mgmt - billsTotal).toFixed(2);

  const rowTenant = (t,i,isShop=false) => `<tr>
      <td class="c">${i+1}</td>
      <td class="c">${t.unitNumber||""}</td>
      <td>${t.tenantName||""}</td>
      <td class="c">${Number(t.rent||0).toFixed(2)}</td>
      <td class="c">${fmt(t.startDate)}</td>
      <td class="c">${fmt(t.endDate)}</td>
      <td class="c">${t.phone||""}</td>
      <td>${t.notes||""}</td>
    </tr>`;

  const apartmentsHTML = `
    <div class="section">
      <h3>الشقق</h3>
      <table>
        <thead>
          <tr>
            <th>#</th><th>شقة رقم</th><th>اسم المستأجر</th><th>الإيجار</th>
            <th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th>
          </tr>
        </thead>
        <tbody>
          ${payload.apartments.length ? payload.apartments.map(rowTenant).join("") : `<tr><td class="c" colspan="8">لا توجد بيانات</td></tr>`}
        </tbody>
        <tfoot><tr><td colspan="3" class="c">المجموع</td><td class="c sum">${totalApt.toFixed(2)}</td><td colspan="4"></td></tr></tfoot>
      </table>
    </div>`;

  const shopsHTML = `
    <div class="section">
      <h3>المحلات / المعارض</h3>
      <table>
        <thead>
          <tr>
            <th>#</th><th>رقم المحل/المعرض</th><th>المستأجر</th><th>الإيجار</th>
            <th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th>
          </tr>
        </thead>
        <tbody>
          ${payload.shops.length ? payload.shops.map(rowTenant).join("") : `<tr><td class="c" colspan="8">لا توجد بيانات</td></tr>`}
        </tbody>
        <tfoot><tr><td colspan="3" class="c">المجموع</td><td class="c sum">${totalShop.toFixed(2)}</td><td colspan="4"></td></tr></tfoot>
      </table>
    </div>`;

  const expensesHTML = `
    <div class="section">
      <h3>المصروفات</h3>
      <table>
        <thead><tr><th>الخدمة</th><th>قيمة الخدمة</th><th>رقم الفاتورة</th><th>رقم الشقة</th></tr></thead>
        <tbody>
          ${
            payload.expenses.length
              ? payload.expenses.map(e => `<tr>
                    <td>${e.type||""}</td>
                    <td class="c">${Number(e.amount||0).toFixed(2)}</td>
                    <td class="c">${e.billNo||""}</td>
                    <td class="c">${e.unitNo||""}</td>
                  </tr>`).join("")
              : `<tr><td class="c" colspan="4">لا توجد مصروفات</td></tr>`
          }
        </tbody>
        <tfoot><tr><td style="text-align:left">المجموع</td><td class="c sum">${billsTotal.toFixed(2)}</td><td colspan="2"></td></tr></tfoot>
      </table>
    </div>`;

  const totalsHTML = `
    <div class="section">
      <h3>الحسابات النهائية</h3>
      <table>
        <tbody>
          <tr><td>مجموع إيجار الشقق</td><td class="c">${totalApt.toFixed(2)}</td></tr>
          <tr><td>مجموع إيجار المحلات</td><td class="c">${totalShop.toFixed(2)}</td></tr>
          <tr><td>الإيجار الكلي</td><td class="c">${grand.toFixed(2)}</td></tr>
          <tr><td>نسبة رسوم الإدارة 15%</td><td class="c">${mgmt.toFixed(2)}</td></tr>
          <tr><td>الفواتير</td><td class="c">${billsTotal.toFixed(2)}</td></tr>
          <tr><td><b>مجموع الإيجار بعد خصم الفواتير و رسوم الإدارة</b></td><td class="c sum">${afterAll.toFixed(2)}</td></tr>
        </tbody>
      </table>
    </div>`;

  const headerHTML = `
    <div class="hdr">
      <img class="logo" src="${LOGO}" alt="logo" crossorigin="anonymous">
      <div class="row">
        <div class="cell">السنة: ${yyyy}</div>
        <div class="cell">الشهر: ${mm}</div>
        <div class="cell">رقم التواصل: ${payload.header?.contact || "—"}</div>
        <div class="cell">اسم المبنى: ${payload.buildingName || "—"}</div>
        <div class="cell">الموقع: ${payload.header?.location || "—"}</div>
      </div>
    </div>`;

  const pageHTML = `
    <div class="page">
      <img class="bg" src="${ORN_BG}" alt="" crossorigin="anonymous">
      ${headerHTML}
      <div class="content">
        ${apartmentsHTML}
        ${shopsHTML}
        ${expensesHTML}
        ${totalsHTML}
      </div>
    </div>`;

  document.getElementById("printRoot").innerHTML = pageHTML;

  // تصدير PDF
  document.getElementById("btnPDF").onclick = ()=>{
    const el=document.querySelector('#printRoot .page');
    const opt={margin:0,filename:`تقرير_${payload.buildingName||"مبنى"}_${yyyy}-${mm}.pdf`,
      image:{type:'jpeg',quality:0.98},
      html2canvas:{scale:2.2,useCORS:true,backgroundColor:null},
      jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
    window.html2pdf().set(opt).from(el).save();
  };
</script>
</body>
</html>

