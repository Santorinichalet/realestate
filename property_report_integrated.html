<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<title>تقرير المبنى — نسخة مدمجة</title>
<style>
  body{margin:0;font-family:"Noto Naskh Arabic",Arial,sans-serif;background:#f8fafc;color:#0f172a}
  #printRoot .page{position:relative;width:210mm;height:297mm;background:#fff;overflow:hidden;}
  /* الخلفية المزخرفة */
  #printRoot .page img.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;pointer-events:none;}
  /* الهيدر — شعار في الأعلى بالمنتصف ثم خط أزرق (موجود بالتصميم) ثم اسم المبنى و"تقرير شهر" */
  #printRoot .hdr{position:absolute;top:10mm;left:12mm;right:12mm;z-index:2;text-align:center}
  #printRoot .hdr .logo img{height:10mm;width:auto;display:block;margin:0 auto 2mm auto;} /* شعار صغير جدًا وتقليل المسافة */
  #printRoot .hdr .bname{font-size:16px;font-weight:700;color:#000;margin:16mm 0 2mm 0} /* تحت الخط الأزرق ~ 16mm (قابلة للتعديل) */
  #printRoot .hdr .period{font-size:13px;color:#111;margin:0}
  /* المحتوى */
  #printRoot .content{position:absolute;inset:32mm 12mm 12mm 12mm;z-index:3;}
  /* الجداول RTL */
  #printRoot table{width:100%;border-collapse:collapse;border:1px solid #334155;direction:rtl;text-align:right;background:#fff;}
  #printRoot th,#printRoot td{border:1px solid #334155;padding:4px 6px;font-size:12px;}
  #printRoot thead th{background:#f3f4f6;}
  #printRoot .c{text-align:center}
  #printRoot .sum{color:#dc2626;font-weight:800}
  /* شريط علوى بسيط */
  .toolbar{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:99;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;gap:10px}
  .btn{padding:8px 14px;border-radius:8px;border:1px solid #ccc;cursor:pointer;font-size:14px}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
</style>
</head>
<body>
<div class="toolbar">
  <button class="btn" onclick="history.back()">رجوع</button>
  <button class="btn primary" id="btnPDF">تصدير PDF</button>
</div>

<div id="printRoot"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  // روابط الخلفية والشعار الشفاف
  const ORN_BG='https://i.ibb.co/W4jvtDdH/img-1759573008406.png';
  const LOGO='https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png';

  // قراءة حمولة التقرير من localStorage
  let b={name:'—'}; let yyyy=new Date().getFullYear(); let mm=String(new Date().getMonth()+1).padStart(2,'0');
  let apts=[], shps=[], exps=[];
  (function(){
    try{
      const raw = localStorage.getItem('pm_report_payload');
      if(raw){
        const data = JSON.parse(raw);
        b = { name: data.buildingName || '—' };
        yyyy = +data.year || yyyy;
        mm = String(data.month || mm).padStart(2,'0');
        apts = Array.isArray(data.apartments)? data.apartments : [];
        shps = Array.isArray(data.shops)? data.shops : [];
        exps = Array.isArray(data.expenses)? data.expenses : [];
      }
    }catch(e){ console.warn('payload parse error', e); }
  })();

  const fmt = (d)=> d ? new Date(d).toISOString().slice(0,10) : '';
  const totalApt = apts.reduce((s,t)=>s+Number(t.rent||0),0);
  const totalShop = shps.reduce((s,t)=>s+Number(t.rent||0),0);
  const billsTotal = exps.reduce((s,e)=>s+Number(e.amount||0),0);
  const grand = totalApt + totalShop;
  const mgmt = +(grand * 0.15).toFixed(2);
  const after = +(grand - mgmt - billsTotal).toFixed(2);

  function row(t,i){ return `<tr>
    <td class='c'>${i+1}</td>
    <td class='c'>${t.unitNumber||''}</td>
    <td>${t.tenantName||''}</td>
    <td class='c'>${Number(t.rent||0).toFixed(2)}</td>
    <td class='c'>${fmt(t.startDate)}</td>
    <td class='c'>${fmt(t.endDate)}</td>
    <td class='c'>${t.phone||''}</td>
    <td>${t.notes||''}</td>
  </tr>`; }

  const apartmentsHTML = `
  <div style="margin-bottom:4mm"><b>الشقق</b></div>
  <table>
    <thead>
      <tr><th>#</th><th>شقة رقم</th><th>اسم المستأجر</th><th>الإيجار</th><th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th></tr>
    </thead>
    <tbody>${apts.length? apts.map(row).join('') : "<tr><td class='c' colspan='8'>لا توجد بيانات</td></tr>"}</tbody>
    <tfoot><tr><td colspan='3' class='c'>المجموع</td><td class='c sum'>${totalApt.toFixed(2)}</td><td colspan='4'></td></tr></tfoot>
  </table>`;

  const shopsHTML = `
  <div style="margin:6mm 0 4mm"><b>المحلات / المعارض</b></div>
  <table>
    <thead>
      <tr><th>#</th><th>رقم المحل/المعرض</th><th>المستأجر</th><th>الإيجار</th><th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th></tr>
    </thead>
    <tbody>${shps.length? shps.map(row).join('') : "<tr><td class='c' colspan='8'>لا توجد بيانات</td></tr>"}</tbody>
    <tfoot><tr><td colspan='3' class='c'>المجموع</td><td class='c sum'>${totalShop.toFixed(2)}</td><td colspan='4'></td></tr></tfoot>
  </table>`;

  const billsHTML = `
  <div style="margin:6mm 0 4mm"><b>المصروفات</b></div>
  <table>
    <thead><tr><th>النوع</th><th>المبلغ (ر.ع)</th><th>التاريخ</th><th>ملاحظات</th></tr></thead>
    <tbody>${
      exps.length? exps.map(e=>`<tr><td>${e.type||''}</td><td class='c'>${Number(e.amount||0).toFixed(2)}</td><td class='c'>${fmt(e.date)}</td><td>${e.notes||''}</td></tr>`).join('') : "<tr><td class='c' colspan='4'>لا توجد مصروفات</td></tr>"
    }</tbody>
    <tfoot><tr><td style='text-align:left'>المجموع</td><td class='c sum'>${billsTotal.toFixed(2)}</td><td colspan='2'></td></tr></tfoot>
  </table>`;

  const totalsHTML = `
  <div style="margin:6mm 0 2mm"><b>الحسابات النهائية</b></div>
  <table><tbody>
    <tr><td>مجموع إيجار الشقق</td><td class="c">${totalApt.toFixed(2)}</td></tr>
    <tr><td>مجموع إيجار المحلات</td><td class="c">${totalShop.toFixed(2)}</td></tr>
    <tr><td>الإيجار الكلي</td><td class="c">${grand.toFixed(2)}</td></tr>
    <tr><td>نسبة رسوم الإدارة 15%</td><td class="c">${mgmt.toFixed(2)}</td></tr>
    <tr><td>الفواتير</td><td class="c">${billsTotal.toFixed(2)}</td></tr>
    <tr><td><b>مجموع الإيجار بعد خصم الفواتير و رسوم الإدارة</b></td><td class="c sum">${after.toFixed(2)}</td></tr>
  </tbody></table>`;

  const headerHTML=`
  <div class="hdr">
    <div class="logo"><img src="${LOGO}" alt="logo" crossorigin="anonymous"></div>
    <div class="bname">${b.name}</div>
    <div class="period">تقرير شهر: ${mm} / ${yyyy}</div>
  </div>`;

  const pageHTML=`
  <div class="page">
    <img class="bg" src="${ORN_BG}" alt="" crossorigin="anonymous">
    ${headerHTML}
    <div class="content">${apartmentsHTML}${shopsHTML}${billsHTML}${totalsHTML}</div>
  </div>`;

  document.getElementById('printRoot').innerHTML=pageHTML;

  function exportPDFNow(){
    const el=document.querySelector('#printRoot .page');
    const imgs=el.querySelectorAll('img');
    return Promise.all(Array.from(imgs).map(img=>img.complete?Promise.resolve():new Promise(res=>{img.onload=img.onerror=res;})))
      .then(()=>{
        const opt={margin:0,filename:`تقرير_${b.name}_${yyyy}-${mm}.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true,backgroundColor:null},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
        return window.html2pdf().set(opt).from(el).save();
      });
  }
  window.exportPDF = exportPDFNow;

  document.getElementById('btnPDF').onclick=()=>exportPDFNow();

  // خيار التصدير التلقائي ?autopdf=1
  (function(){
    const q=new URLSearchParams(location.search);
    if(q.get('autopdf')==='1'){ window.addEventListener('load',()=>{ setTimeout(()=>{ exportPDFNow(); }, 350); }); }
  })();
</script>
</body>
</html>
