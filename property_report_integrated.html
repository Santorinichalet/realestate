

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تقرير المبنى — v37</title>
<style>
  :root{--ink:#0f172a;--border:#374151;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#eef2f7;color:var(--ink);font-family:system-ui,-apple-system,"Noto Naskh Arabic",Tahoma}
  .toolbar{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:99;background:#fff;padding:10px;border-radius:10px;
           box-shadow:0 6px 20px rgba(0,0,0,.08);display:flex;gap:8px}
  .btn{border:1px solid #cbd5e1;background:#2563eb;color:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}
  #printRoot{display:grid;place-items:center;padding:24px}
  .page{position:relative;width:210mm;height:297mm;background:#fff;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none;
      -webkit-print-color-adjust:exact; print-color-adjust:exact}
  .safe{position:absolute;inset:40mm 12mm 16mm 12mm; display:flex; flex-direction:column; gap:8mm}
  .infoTable{width:100%;border-collapse:collapse;border:1px solid var(--border);background:#fff}
  .infoTable td{border:1px solid var(--border);padding:6px 8px;font-weight:700}
  .label{color:#1f2937;opacity:.85}
  .content{display:flex;flex-direction:column;gap:6mm;min-height:0}
  h3{margin:0 0 4mm}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border);background:#fff}
  th,td{border:1px solid var(--border);padding:3px 5px;font-size:11px}
  thead th{background:#f3f4f6}
  .c{text-align:center}
  .sum{color:#dc2626;font-weight:800}
  .section{break-inside:avoid}
  @page{size:A4;margin:0}
  @media print{body{background:#fff}.toolbar{display:none}.page{box-shadow:none}}
</style>
</head>
<body>
<div class="toolbar">
  <button class="btn" id="btnPDF">تصدير PDF</button>
</div>

<div id="printRoot">
  <div class="page">
    <img class="bg" id="bg" alt="">
    <div class="safe">
      <!-- جدول معلومات المبنى (فوق الشقق مباشرة) -->
      <table class="infoTable" id="topInfo">
        <tr>
          <td style="width:28%"><span class="label">اسم المبنى:</span> <span id="infoBuilding">—</span></td>
          <td style="width:14%"><span class="label">السنة:</span> <span id="infoYear">—</span></td>
          <td style="width:14%"><span class="label">الشهر:</span> <span id="infoMonth">—</span></td>
          <td style="width:22%"><span class="label">الموقع:</span> <span id="infoLoc">—</span></td>
          <td style="width:22%"><span class="label">رقم التواصل:</span> <span id="infoPhone">—</span></td>
        </tr>
      </table>

      <div class="content" id="content"></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  const ORN_BG = "https://i.ibb.co/W4jvtDdH/img-1759573008406.png"; // خلفية مع الزخارف والشعار الكبير
  document.getElementById('bg').src = ORN_BG;

  // قراءة الحمولة
  let payload = { buildingName:"—", year:new Date().getFullYear(), month:new Date().getMonth()+1,
                  apartments:[], shops:[], expenses:[], header:{contact:"",location:""} };
  try{
    const raw = localStorage.getItem("pm_report_payload");
    if(raw) payload = Object.assign(payload, JSON.parse(raw));
  }catch{}

  const yyyy = +payload.year, mm = String(payload.month).padStart(2,"0");
  const fmt  = d => d ? new Date(d).toISOString().slice(0,10) : "";

  // تعبئة جدول المعلومات
  document.getElementById('infoBuilding').textContent = payload.buildingName || "—";
  document.getElementById('infoYear').textContent     = yyyy;
  document.getElementById('infoMonth').textContent    = mm;
  document.getElementById('infoLoc').textContent      = (payload.header?.location||"—");
  document.getElementById('infoPhone').textContent    = (payload.header?.contact||"—");

  // المجاميع
  const totalApt   = payload.apartments.reduce((s,t)=>s+Number(t.rent||0),0);
  const totalShop  = payload.shops.reduce((s,t)=>s+Number(t.rent||0),0);
  const billsTotal = payload.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
  const grand      = totalApt + totalShop;
  const mgmt       = +(grand * 0.15).toFixed(2);
  const afterAll   = +(grand - mgmt - billsTotal).toFixed(2);

  const rowTenant = (t,i)=> `<tr>
      <td class="c">${i+1}</td>
      <td class="c">${t.unitNumber||""}</td>
      <td>${t.tenantName||""}</td>
      <td class="c">${Number(t.rent||0).toFixed(2)}</td>
      <td class="c">${fmt(t.startDate)}</td>
      <td class="c">${fmt(t.endDate)}</td>
      <td class="c">${t.phone||""}</td>
      <td>${t.notes||""}</td>
    </tr>`;

  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="section">
      <h3>الشقق</h3>
      <table>
        <thead>
          <tr><th>#</th><th>شقة رقم</th><th>اسم المستأجر</th><th>الإيجار</th><th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th></tr>
        </thead>
        <tbody>
          ${ payload.apartments.length ? payload.apartments.map(rowTenant).join("") : `<tr><td class="c" colspan="8">لا توجد بيانات</td></tr>` }
        </tbody>
        <tfoot><tr><td colspan="3" class="c">المجموع</td><td class="c sum">${totalApt.toFixed(2)}</td><td colspan="4"></td></tr></tfoot>
      </table>
    </div>
    <div class="section">
      <h3>المحلات / المعارض</h3>
      <table>
        <thead>
          <tr><th>#</th><th>رقم المحل/المعرض</th><th>المستأجر</th><th>الإيجار</th><th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th></tr>
        </thead>
        <tbody>
          ${ payload.shops.length ? payload.shops.map(rowTenant).join("") : `<tr><td class="c" colspan="8">لا توجد بيانات</td></tr>` }
        </tbody>
        <tfoot><tr><td colspan="3" class="c">المجموع</td><td class="c sum">${totalShop.toFixed(2)}</td><td colspan="4"></td></tr></tfoot>
      </table>
    </div>
    <div class="section">
      <h3>المصروفات</h3>
      <table>
        <thead><tr><th>الخدمة</th><th>قيمة الخدمة</th><th>رقم الفاتورة</th><th>رقم الشقة</th></tr></thead>
        <tbody>
          ${ payload.expenses.length ? payload.expenses.map(e=>`
            <tr><td>${e.type||""}</td><td class="c">${Number(e.amount||0).toFixed(2)}</td><td class="c">${e.billNo||""}</td><td class="c">${e.unitNo||""}</td></tr>
          `).join("") : `<tr><td class="c" colspan="4">لا توجد مصروفات</td></tr>` }
        </tbody>
        <tfoot><tr><td style="text-align:left">المجموع</td><td class="c sum">${billsTotal.toFixed(2)}</td><td colspan="2"></td></tr></tfoot>
      </table>
    </div>
    <div class="section">
      <h3>الحسابات النهائية</h3>
      <table>
        <tbody>
          <tr><td>مجموع إيجار الشقق</td><td class="c">${totalApt.toFixed(2)}</td></tr>
          <tr><td>مجموع إيجار المحلات</td><td class="c">${totalShop.toFixed(2)}</td></tr>
          <tr><td>الإيجار الكلي</td><td class="c">${grand.toFixed(2)}</td></tr>
          <tr><td>نسبة رسوم الإدارة 15%</td><td class="c">${mgmt.toFixed(2)}</td></tr>
          <tr><td>الفواتير</td><td class="c">${billsTotal.toFixed(2)}</td></tr>
          <tr><td><b>مجموع الإيجار بعد خصم الفواتير و رسوم الإدارة</b></td><td class="c sum">${afterAll.toFixed(2)}</td></tr>
        </tbody>
      </table>
    </div>
  `;

  document.getElementById('btnPDF').onclick = ()=>{
    const page = document.querySelector('.page');
    const opt = {
      margin:       0,
      filename:     `تقرير_${payload.buildingName||"مبنى"}_${yyyy}-${mm}.pdf`,
      image:        { type:'jpeg', quality:0.98 },
      html2canvas:  { scale: 2.0, useCORS:true, backgroundColor:null, letterRendering:true, scrollY: 0 },
      pagebreak:    { mode: ['avoid-all','css','legacy'] },
      jsPDF:        { unit:'mm', format:'a4', orientation:'portrait' }
    };
    window.html2pdf().set(opt).from(page).save();
  };
</script>
</body>
</html>


