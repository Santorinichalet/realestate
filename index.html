

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>إدارة الممتلكات — v34 (fix)</title>
<style>
  :root{ --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --fg:#0f172a; --accent:#2563eb; --danger:#ef4444; --success:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(#f8fafc,#eef2f7);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic","Tahoma",sans-serif;color:var(--fg)}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
  .container{max-width:1200px;margin:0 auto;padding:14px}
  .brand{display:flex;gap:8px;align-items:center;font-weight:700}
  .brand img{height:42px;width:auto;border-radius:6px;object-fit:contain}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb; background:#1f6fff;color:#fff;border-color:#1f6fff}
  .btn.icon{padding:8px 12px;border-radius:14px}
  .btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
  main{padding:14px}
  .grid{display:grid;gap:12px}
  @media(min-width:960px){.grid.cols-3{grid-template-columns:repeat(3,1fr)}}
  @media(min-width:640px){.grid.cols-2{grid-template-columns:repeat(2,1fr)}}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card-h{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .card-c{padding:10px 12px}
  .muted{color:#6b7280}
  .icon-card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border:1px solid var(--border);border-radius:16px;background:#fff;cursor:pointer;transition:transform .1s ease, box-shadow .2s ease}
  .icon-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .circle{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;background:#e0e7ff;border:1px solid #c7d2fe;font-size:24px}
  .stat{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:8px}
  .hidden{display:none !important}
  .badge{font-size:12px;border-radius:999px;padding:4px 8px;display:inline-block}
  .badge.success{background:#dcfce7;color:#166534}
  .badge.gray{background:#f3f4f6;color:#374151}
  table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb}
  th,td{border:1px solid #e5e7eb;padding:6px}
  thead{background:#f8fafc}
  .ymbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .ymbar select{min-width:110px}
  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
  .modal-wrap.show{display:flex}
  .modal-wrap .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25)}
  .modal-wrap .modal{position:relative;background:#fff;border-radius:16px;border:1px solid var(--border);width:min(820px,94vw);max-height:88vh;overflow:auto}
  .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
  .modal .body{padding:12px}
  .row{display:grid;gap:10px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:repeat(3,1fr)}
  label{display:block;font-size:12px;color:#374151;margin-bottom:4px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  .kv{display:flex;gap:12px;flex-wrap:wrap;color:#374151}
  .kv div{display:flex;align-items:center;gap:6px}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{border:1px solid var(--border);padding:6px 10px;border-radius:14px;cursor:pointer}
  .chip.active{background:#e0e7ff;border-color:#c7d2fe}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
<style>

:root{
  --bg:#f7f9fb;
  --fg:#0f172a;
  --muted:#6b7280;
  --card:#ffffff;
  --border:#e5e7eb;
  --accent:#2563eb;
  --accent-2:#1d4ed8;
  --success:#16a34a;
  --danger:#ef4444;
  --warning:#f59e0b;
  --kpi-bg:#f8fafc;
  --chip:#eef2ff;
}

html,body{background:linear-gradient(180deg,#fbfcfe 0%,#f2f5f9 100%);}
body{
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  font-family: "Tajawal","Noto Naskh Arabic", system-ui, -apple-system, "Segoe UI", Roboto, "Tahoma", sans-serif;
  color:var(--fg);
}

/* Header */
header{
  position: sticky; top:0; z-index:50;
  background: rgba(255,255,255,.85);
  backdrop-filter: blur(8px);
  border-bottom:1px solid var(--border);
}
.brand span{letter-spacing:.2px}

/* Buttons */
.btn{ 
  border:1px solid var(--border);
  background:var(--card);
  border-radius:12px;
  padding:10px 14px;
  cursor:pointer;
  transition: all .15s ease;
}
.btn:hover{transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.06)}
.btn:active{transform:translateY(0)}
.btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) ; background:#1f6fff;color:#fff;border-color:#1f6fff}
.btn.primary:hover{ background:var(--accent-2); border-color:var(--accent-2) }
.btn.danger{ background:var(--danger); color:#fff; border-color:var(--danger) }
.btn.icon{ display:inline-flex; align-items:center; gap:8px }

/* Cards */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:0 1px 2px rgba(0,0,0,.04);
}
.card-h{ padding:12px 14px; border-bottom:1px solid var(--border) }
.card-c{ padding:12px 14px }

/* KPI tiles */
.stat{
  background:var(--kpi-bg);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px 14px;
  display:flex; align-items:center; gap:10px;
}
.stat i{ font-style:normal; font-size:18px; opacity:.8 }

/* Icon cards (buildings) */
.icon-card{
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  background:var(--card);
  transition:transform .12s ease, box-shadow .18s ease;
}
.icon-card:hover{ transform:translateY(-2px); box-shadow:0 10px 28px rgba(0,0,0,.07) }
.circle{ width:54px;height:54px;border-radius:50%;display:grid;place-items:center;
  background:#e0e7ff;border:1px solid #c7d2fe;font-size:22px }

/* Chips & filters */
.filters{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
.chip{
  border:1px solid var(--border); padding:6px 12px; border-radius:999px; cursor:pointer;
  background:#fff; transition:all .15s;
}
.chip:hover{ background:#f3f4f6 }
.chip.active{ background:var(--chip); border-color:#c7d2fe }

/* Inputs */
input,select,textarea{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
  transition:border-color .15s, box-shadow .15s;
  background:#fff;
}
input:focus,select:focus,textarea:focus{ outline:none; border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15) }
label{ color:#374151; font-size:12px; margin-bottom:6px; display:block }

/* Tables */
table{ width:100%; border-collapse:collapse; border:1px solid var(--border); background:#fff }
th,td{ border:1px solid var(--border); padding:8px 10px }
thead{ background:#f8fafc }
tbody tr:nth-child(odd){ background:#fcfdff }
tbody tr:hover{ background:#f6faff }

/* Modals */
.modal-wrap .modal{ border-radius:18px }
.modal .head{ padding:14px; border-bottom:1px solid var(--border) }
.modal .body{ padding:14px }

/* Grids */
.grid{ display:grid; gap:12px }
@media(min-width:960px){ .grid.cols-3{ grid-template-columns:repeat(3,1fr) } }
@media(min-width:640px){ .grid.cols-2{ grid-template-columns:repeat(2,1fr) } }

/* Badges */
.badge{ font-size:12px; border-radius:999px; padding:4px 8px; display:inline-block }
.badge.success{ background:#dcfce7; color:#166534 }
.badge.gray{ background:#f3f4f6; color:#374151 }

/* Helpers */
.muted{ color:var(--muted) }
.kv{ display:flex; flex-wrap:wrap; gap:12px }
.container{ max-width:1200px; margin:0 auto; padding:14px }
.ymbar{ display:flex; gap:10px; align-items:center; margin-bottom:8px }
.hidden{ display:none !important }

/* Report: print-friendly */
@page{ size: A4; margin: 14mm }
@media print{
  header, .toolbar, .filters, .modal-wrap{ display:none !important }
  .card, .stat{ box-shadow:none }
  thead{ background:#fff !important }
  a[href]:after{ content:'' !important }
  .page-break{ page-break-before:always }
}

</style>

<style>
  #saveB{background:#1f6fff !important;color:#fff !important;border:1px solid #1f6fff !important}
  #saveB:hover{background:#1558d6 !important;border-color:#1558d6 !important}
</style>


<style>
  .topbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .topbar input[type="search"]{flex:1;min-width:220px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
</style>
<script>
(function(){
  // Hook after dashboard render to attach filtering
  function attachBuildingSearch(){
    var input = document.getElementById('buildingSearch');
    var grid  = document.getElementById('buildingsGrid') || document.getElementById('buildingsList') || document.querySelector('[data-buildings-grid]');
    if(!input || !grid) return;
    input.oninput = function(){
      var q = (input.value||'').trim().toLowerCase();
      var cards = grid.querySelectorAll('[data-building-card]');
      cards.forEach(function(card){
        var txt = card.getAttribute('data-search') || card.textContent || '';
        txt = txt.toLowerCase();
        card.style.display = (q==='' || txt.indexOf(q) !== -1) ? '' : 'none';
      });
    };
  }
  window.__attachBuildingSearch = attachBuildingSearch;
})();
</script>


<style>
  .btn.primary{background:#1f6fff;color:#fff;border:1px solid #1f6fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.primary:hover{background:#1558d6;border-color:#1558d6}
  .btn{display:inline-flex;align-items:center;gap:4px;font-size:14px}
</style>


<style>
  /* Unified blue style for modal buttons + primary buttons everywhere */
  .btn.primary{
    background:#1f6fff !important;
    color:#fff !important;
    border:1px solid #1f6fff !important;
    border-radius:8px !important;
    box-shadow:0 2px 6px rgba(31,111,255,0.25);
    transition:all .2s ease-in-out;
  }
  .btn.primary:hover{
    background:#1558d6 !important;
    border-color:#1558d6 !important;
    box-shadow:0 3px 8px rgba(21,88,214,0.35);
  }
  /* Make ALL modal buttons blue even if not marked as primary */
  .modal button.btn{
    background:#1f6fff !important;
    color:#fff !important;
    border:1px solid #1f6fff !important;
    border-radius:8px !important;
    box-shadow:0 2px 6px rgba(31,111,255,0.25);
    transition:all .2s ease-in-out;
  }
  .modal button.btn:hover{
    background:#1558d6 !important;
    border-color:#1558d6 !important;
    box-shadow:0 3px 8px rgba(21,88,214,0.35);
  }
</style>


<style>
  /* Expenses modal buttons: unified look */
  .btn.primary{background:#1f6fff !important;color:#fff !important;border:1px solid #1f6fff !important;border-radius:8px !important;box-shadow:0 2px 6px rgba(31,111,255,0.25);transition:all .2s ease-in-out}
  .btn.primary:hover{background:#1558d6 !important;border-color:#1558d6 !important;box-shadow:0 3px 8px rgba(21,88,214,0.35)}
  .btn.danger{background:#ef4444 !important;color:#fff !important;border:1px solid #ef4444 !important;border-radius:8px !important;box-shadow:0 2px 6px rgba(239,68,68,0.25);transition:all .2s ease-in-out}
  .btn.danger:hover{background:#dc2626 !important;border-color:#dc2626 !important;box-shadow:0 3px 8px rgba(220,38,38,0.35)}
  /* keep buttons inline & aligned */
  .modal .actions, .modal .footer, .modal .buttons-row {display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>


<style>
  .btn.danger{background:#ef4444 !important;color:#fff !important;border:1px solid #ef4444 !important;border-radius:8px !important;box-shadow:0 2px 6px rgba(239,68,68,0.25);transition:all .2s ease-in-out}
  .btn.danger:hover{background:#dc2626 !important;border-color:#dc2626 !important;box-shadow:0 3px 8px rgba(220,38,38,0.35)}
  /* Ensure tenants action buttons are inline to the right */
  #tenantsList .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
</style>

<style>
/* --- injected: pay modal buttons row + sizing --- */
.modal .buttons-row{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:10px}
.modal .buttons-row .btn{width:auto !important;min-width:auto !important;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:10px 14px;font-size:14px}
.modal .buttons-row .btn.btn--sm{padding:8px 12px;font-size:13px}
/* --- end injected --- */
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img src="https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png" alt="Logo" onerror="this.style.display='none'">
      <span>إدارة الممتلكات</span>
    </div>
    <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap">
      <button type="button" class="btn  primary" onclick="openAddBuildingModal()">➕ مبنى</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="ymbar">
    <div>السنة</div>
    <select id="yearSel"></select>
    <div>الشهر</div>
    <select id="monthSel"></select>
  </div>

  <!-- KPI عام -->
  <section class="grid cols-3" id="kpis">
    <div class="stat">إجمالي الإيراد (الشهر المحدد): <i>﷼</i> <b id="kpiIncome">0</b> ر.ع</div>
    <div class="stat">المصروفات (الشهر المحدد): <i>−</i> <b id="kpiExpenses">0</b> ر.ع</div>
    <div class="stat">الصافي: <i>✓</i> <b id="kpiNet">0</b> ر.ع</div>
  </section>

  <section id="view-dashboard" style="margin-top:10px">
    <h2>المباني</h2>
    <div id="buildingsIcons" class="grid cols-3" id="buildingsGrid" data-buildings-grid></div>
    <div id="emptyBuildings" class="card" style="display:none">
      <div class="card-c muted" style="text-align:center;padding:24px">لا يوجد مبانٍ — أضف مبنى من أيقونة (➕ مبنى) بالأعلى.</div>
    </div>
  </section>

  <section id="view-building" class="hidden">
    <div class="card">
      <div class="card-h">
        <div>
          <h2 id="buildingTitle" style="margin:0 0 4px"></h2>
          <div id="buildingMeta" class="kv muted" style="font-size:13px"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button type="button" class="btn" onclick="renderDashboard()">الرجوع</button>
          <button type="button" class="btn" onclick="openEditBuildingModal()">✏️ تعديل المبنى</button>
          <button type="button" class="btn" onclick="openImportCSV()">📥 استيراد مستأجرين (CSV)</button>
<button type="button" class="btn primary" onclick="openAddTenantModal()">➕ إضافة مستأجر</button>
          <button type="button" class="btn" onclick="openExpensesModal()">💰 المصروفات</button>
          <button type="button" class="btn" onclick="renderReport()">📊 تقرير</button>
        </div>
      </div>

      <!-- KPI خاص بالمبنى للشهر المحدد -->
      <div class="card-c">
        <div class="grid cols-3" id="bldgKPI" style="margin-bottom:8px">
          <div class="stat">إيراد المبنى (الشهر): <i>﷼</i> <b id="bkIncome">0</b> ر.ع</div>
          <div class="stat">مصروفات المبنى (الشهر): <i>−</i> <b id="bkExpenses">0</b> ر.ع</div>
          <div class="stat">الصافي (الشهر): <i>✓</i> <b id="bkNet">0</b> ر.ع</div>
        </div>

        <div class="grid cols-3">
          <div class="stat">إجمالي الوحدات: <b id="stTotal">0</b></div>
          <div class="stat">شقق: <b id="stApt">0</b></div>
          <div class="stat">محلات/معارض: <b id="stShop">0</b></div>
          <div class="stat">مشغولة: <b id="stOcc">0</b></div>
          <div class="stat">شاغرة: <b id="stVac">0</b></div>
          <div class="stat">تنتهي قريباً (≤30 يوم): <b id="stExpSoon">0</b></div>
        </div>

        <!-- فلاتر وبحث -->
        <div class="filters" style="margin:12px 0">
          <input id="searchBox" placeholder="بحث بالاسم/الوحدة/الهاتف/البطاقة" style="max-width:260px">
          <div class="chip" data-ft="all">الكل</div>
          <div class="chip" data-ft="apartment">شقق</div>
          <div class="chip" data-ft="shop">محلات</div>
          <div class="chip" data-ft="showroom">معارض</div>
          <div class="chip" data-ft="basement">قبو</div>
          <div class="chip" data-status="occupied">مشغولة</div>
          <div class="chip" data-status="vacant">شاغرة</div>
        </div>

        <div class="grid cols-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><b>قائمة الوحدات</b></div>
            <div class="card-c" id="unitsList"><span class="muted">—</span></div>
          </div>
          <div class="card">
            <div class="card-h"><b>المستأجرون</b></div>
            <div class="card-c" id="tenantsList"><span class="muted">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modalWrap" class="modal-wrap" aria-hidden="true">
  <div class="backdrop" onclick="closeModal()"></div>
  <div class="modal" role="dialog" aria-modal="true">
    <div class="head">
      <h3 id="modalTitle">عنوان</h3>
      <button type="button" class="btn" onclick="closeModal()">✕</button>
    </div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// ===================== Firebase =====================
const firebaseConfig={apiKey:"AIzaSyDE5ko6yQW5npxKWn0GUiz2NryqdOJUhOo",authDomain:"realestate-6b48f.firebaseapp.com",projectId:"realestate-6b48f",storageBucket:"realestate-6b48f.firebasestorage.app",messagingSenderId:"807500202227",appId:"1:807500202227:web:8333a119554122a36db786"};
try{firebase.initializeApp(firebaseConfig);}catch(e){}
const db=firebase.firestore();

// ===================== Helpers =====================
const $=(s,p=document)=>p.querySelector(s);
const todayIso=()=>new Date().toISOString().slice(0,10);
const fmtDate=d=>d?new Date(d).toLocaleDateString('ar-OM'):'';
const startOfMonth=(y,m)=>new Date(Date.UTC(y,m-1,1));
const endOfMonth=(y,m)=>new Date(Date.UTC(y,m,0,23,59,59));
const prevMonthEnd=(y,m)=>(m===1?endOfMonth(y-1,12):endOfMonth(y,m-1));
const isActiveDuring=(s,e,ms,me)=>new Date(s)<=me&&new Date(e)>=ms;
const num=v=>Number(v||0);

let activeBuildingId=null, selYear=new Date().getFullYear(), selMonth=new Date().getMonth()+1, chipsState={kind:'all',status:null}, cachedBuildings=[];

function populateYM(){
  const ys=$('#yearSel'),ms=$('#monthSel'); ys.innerHTML=''; ms.innerHTML='';
  for(let y=2018;y<=2036;y++){const o=document.createElement('option');o.value=y;o.textContent=y;if(y===selYear)o.selected=true;ys.appendChild(o)}
  const months=['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
  months.forEach((nm,i)=>{const o=document.createElement('option');o.value=i+1;o.textContent=nm;if(i+1===selMonth)o.selected=true;ms.appendChild(o)});
  ys.onchange=()=>{selYear=Number(ys.value);renderDashboard();

;(function(){
  var __orig = window.renderReport;
  window.renderReport = async function(){
    if(typeof __orig === 'function'){ await __orig(); }
    try{
      const ref = await db.collection('buildings').doc(activeBuildingId).get();
      const b = Object.assign({id: ref.id}, ref.data()||{});
      var root = document.getElementById('r_content');
      if(!root) return;
      var section = document.createElement('div');
      section.className = 'section';
      section.innerHTML = `
        <h3 style="margin:6px 0">بيانات الخدمات</h3>
        <table class="zebra">
          <thead><tr><th>الوصف</th><th>الرقم</th></tr></thead>
          <tbody>
            <tr><td>رقم حساب الكهرباء</td><td>${b.electricAccount||'—'}</td></tr>
            <tr><td>رقم انترنت البناية</td><td>${b.internetNumber||'—'}</td></tr>
            <tr><td>رقم حارس البناية</td><td>${b.guardPhone||'—'}</td></tr>
            <tr><td>رقم سائق ناقلة المجاري</td><td>${b.sewageTruckPhone||'—'}</td></tr>
          </tbody>
        </table>`;
      root.appendChild(section);
      if(typeof window.openReport === 'function'){ window.openReport(); }
    }catch(e){ console.warn('utilities section failed', e); }
  };
})();if(activeBuildingId)renderBuilding();};
  ms.onchange=()=>{selMonth=Number(ms.value);renderDashboard();if(activeBuildingId)renderBuilding();};
}

// ===================== Firestore wrappers =====================
async function listBuildings(){const snap=await db.collection('buildings').get();return snap.docs.map(d=>({id:d.id,...d.data()}));}
async function createBuilding(data){const ref=await db.collection('buildings').add(data);return ref.id;}
async function removeBuilding(id){await db.collection('buildings').doc(id).delete();}
async function listTenants(bid){const snap=await db.collection('buildings').doc(bid).collection('tenants').get();return snap.docs.map(d=>({id:d.id,...d.data()}));}
async function addTenantFS(bid,data){const ref=await db.collection('buildings').doc(bid).collection('tenants').add(data);return ref.id;}
async function updateTenantFS(bid,id,patch){await db.collection('buildings').doc(bid).collection('tenants').doc(id).update(patch);} 
async function deleteTenantFS(bid,id){await db.collection('buildings').doc(bid).collection('tenants').doc(id).delete();}
async function listExpenses(bid){const snap=await db.collection('buildings').doc(bid).collection('expenses').get();return snap.docs.map(d=>({id:d.id,...d.data()}));}
async function addExpenseFS(bid,data){const ref=await db.collection('buildings').doc(bid).collection('expenses').add(data);return ref.id;}
async function deleteExpenseFS(bid,id){await db.collection('buildings').doc(bid).collection('expenses').doc(id).delete();}
async function updateExpenseFS(bid,id,data){await db.collection('buildings').doc(bid).collection('expenses').doc(id).update(data);}
window.deleteExpenseRow=async function(id){await deleteExpenseFS(activeBuildingId,id);await renderExpensesTable();};
window.editExpenseRow = async function(id){
  try{
    const doc = await db.collection('buildings').doc(activeBuildingId).collection('expenses').doc(id).get();
    if(!doc.exists){ alert('السجل غير موجود'); return; }
    const e = Object.assign({id: doc.id}, doc.data()||{});
    openModal('تعديل مصروف', `
      <div class="row cols-2">
        <div><label>نوع المصروف</label><input id="edType" value="${e.type||''}"></div>
        <div><label>المبلغ (ر.ع)</label><input id="edAmount" type="number" step="0.001" value="${Number(e.amount||0)}"></div>
        <div><label>التاريخ</label><input id="edDate" type="date" value="${(e.date||'').slice(0,10)}"></div>
        <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="edNotes" rows="2">${e.notes||''}</textarea></div>
      </div>
      <div class="row" style="grid-template-columns:1fr auto"><div></div><button type="button" class="btn primary" id="edSave">حفظ</button></div>
    `);
    document.getElementById('edSave').onclick = async ()=>{
      const patch = {
        type: document.getElementById('edType').value.trim(),
        amount: Number(document.getElementById('edAmount').value||0),
        date: document.getElementById('edDate').value,
        notes: document.getElementById('edNotes').value.trim()
      };
      await updateExpenseFS(activeBuildingId, id, patch);
      closeModal();
      await renderExpensesTable();
    };
  }catch(err){ console.error(err); alert('تعذر فتح التعديل'); }
};
function editExpense(index){
  const e = currentBuilding.expenses[index];
  openModal('تعديل المصروف', `
    <div><label>الخدمة</label><input id="exType" value="${e.type||''}"></div>
    <div><label>القيمة</label><input id="exAmount" type="number" value="${e.amount||0}"></div>
    <div><label>التاريخ</label><input id="exDate" type="date" value="${e.date||''}"></div>
    <div><label>ملاحظات</label><textarea id="exNotes">${e.notes||''}</textarea></div>
    <button class="btn primary" onclick="saveExpense(${index})">💾 حفظ</button>
  `);
}

async function saveExpense(index){
  const patch = {
    type: $('#exType').value.trim(),
    amount: Number($('#exAmount').value||0),
    date: $('#exDate').value,
    notes: $('#exNotes').value.trim()
  };
  currentBuilding.expenses[index] = patch;
  await db.collection('buildings').doc(activeBuildingId).update({ expenses: currentBuilding.expenses });
  closeModal();
  renderBuilding();
}


// ===================== Dashboard =====================
async function renderDashboard(){
  $('#view-dashboard').classList.remove('hidden');$('#view-building').classList.add('hidden');
  const el=document.getElementById('buildingsIcons');el.innerHTML='';
  try{
    const buildings=await listBuildings();cachedBuildings=buildings;
    document.getElementById('emptyBuildings').style.display=buildings.length?'none':'block';
    buildings.forEach(b=>{
      const card=document.createElement('div');card.className='icon-card';card.setAttribute('data-building-card','');card.setAttribute('data-bid', b.id);
      const counts=b.counts||{};
      card.innerHTML=`
        <div class="circle">🏢</div>
        <div style="font-weight:700">${b.name||''}</div>
        <div class="muted" style="font-size:12px">${b.owner? '👤 المالك: '+b.owner : ''}</div>
        <div class="muted" style="font-size:12px">${b.location? '📍 '+b.location : ''}</div>
        <div class="muted" style="font-size:12px">${b.contact? '☎️ '+b.contact : ''}</div>
        ${b.notes? `<div class="muted" style="font-size:12px">${b.notes}</div>`:''}
        <div class="muted" style="font-size:12px">الوحدات: ${num(counts.apartments)+num(counts.shops)+num(counts.showrooms)+num(counts.basements) || 0}</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button type="button" class="btn" data-act="open">فتح</button>
          <button type="button" class="btn" data-act="add">إضافة مستأجر</button>
          <button type="button" class="btn" data-act="edit">✏️ تعديل</button>
          <button type="button" class="btn  danger" data-act="del">حذف</button>
        </div>`;
      card.querySelector('[data-act="open"]').onclick=async()=>{activeBuildingId=b.id;await renderBuilding();};
      card.querySelector('[data-act="add"]').onclick=async()=>{activeBuildingId=b.id;openAddTenantModal();};
      card.querySelector('[data-act="del"]').onclick=async()=>{if(confirm('حذف المبنى؟')){await removeBuilding(b.id);renderDashboard();}};
      card.setAttribute('data-building-card','');try{card.setAttribute('data-search',(b.name||'')+' '+(b.location||'')+' '+(b.contact||''));}catch(_){}
el.appendChild(card);
    });
    // KPI عام
    let income=0,expenses=0;
    for(const b of buildings){
      const tenants=await listTenants(b.id);
      const ms=startOfMonth(selYear,selMonth),me=endOfMonth(selYear,selMonth);
      income+=tenants.filter(t=>isActiveDuring(t.startDate,t.endDate,ms,me)).reduce((s,t)=>s+num(t.rent),0);
      const exps=await listExpenses(b.id);
      expenses+=exps.filter(e=>isActiveDuring(e.date,e.date,ms,me)).reduce((s,e)=>s+num(e.amount),0);
    }
    $('#kpiIncome').textContent=income.toFixed(2);
    $('#kpiExpenses').textContent=expenses.toFixed(2);
    $('#kpiNet').textContent=(income-expenses).toFixed(2);
  }catch(err){console.error(err);document.getElementById('emptyBuildings').style.display='block';document.querySelector('#emptyBuildings .card-c').textContent='تعذر تحميل المباني.';}
}
function ymKey(y,m){return String(y).padStart(4,'0')+'-'+String(m).padStart(2,'0');}
window.renderDashboard=renderDashboard;

// Delegate clicks for building card actions to avoid missing handlers
(function(){
  var grid = document.getElementById('buildingsIcons');
  if(grid && !grid.__actionsDelegated){
    grid.addEventListener('click', async function(e){
      var btn = e.target.closest('[data-act]');
      if(!btn) return;
      var card = btn.closest('[data-building-card]');
      var bid = card && card.getAttribute('data-bid');
      if(!bid) return;
      if(btn.matches('[data-act="edit"]')){
        try{
          activeBuildingId = bid;
          const ref = await db.collection('buildings').doc(bid).get();
          const b = Object.assign({id: ref.id}, ref.data()||{});
          openEditBuildingModal(b);
        }catch(err){ console.error(err); alert('تعذر فتح التعديل'); }
      }
    }, false);
    grid.__actionsDelegated = true;
  }
})();


function openUpsertBuildingModal(mode, existing){
  const isEdit = mode === 'edit';
  const b = existing || {};
  const counts = b.counts || {apartments:0,shops:0,showrooms:0,basements:0};
  const bizType = b.bizType || 'إدارة مباني';
  const feeType = b.feeType || 'percentage';
  const feeValue = (b.feeValue!=null ? b.feeValue : '');
  const electricAccount = b.electricAccount || '';
  const internetNumber = b.internetNumber || '';
  const guardPhone = b.guardPhone || '';
  const sewageTruckPhone = b.sewageTruckPhone || '';

  openModal(isEdit ? 'تعديل المبنى' : 'إضافة مبنى', `
    <div class="row">
      <div class="row cols-2">
        <div>
          <label>نوع العمل</label>
          <select id="mbBizType">
            <option value="إدارة مباني" ${bizType==='إدارة مباني'?'selected':''}>إدارة مباني</option>
            <option value="جمعية الملاك" ${bizType==='جمعية الملاك'?'selected':''}>جمعية الملاك</option>
          </select>
        </div>
        <div>
          <label>طريقة الأجرة</label>
          <select id="mbFeeType">
            <option value="percentage" ${feeType==='percentage'?'selected':''}>نسبة</option>
            <option value="salary" ${feeType==='salary'?'selected':''}>راتب</option>
          </select>
        </div>
      </div>
      <div>
        <label id="mbFeeLabel">${feeType==='salary'?'الراتب الشهري (ر.ع)':'النسبة (%)'}</label>
        <input id="mbFeeValue" type="number" inputmode="decimal" step="0.01" value="${feeValue}" placeholder="${feeType==='salary'?'مثال: 150 (ر.ع)':'مثال: 15 (٪)'}">
        <small style="display:block;color:#6b7280;margin-top:4px">إن اخترت "نسبة" تُحسَب من إجمالي الإيجار الشهري. وإن اخترت "راتب" تُخصم القيمة مباشرة.</small>
      </div>

      <div><label>اسم المبنى</label><input id="mbName" value="${b.name||''}" placeholder="مثال: مبنى السيفة"></div>
      <div class="row cols-2">
        <div><label>الموقع</label><input id="mbLocation" value="${b.location||''}" placeholder="مثال: ولاية صور - السيفة"></div>
        <div><label>رقم التواصل</label><input id="mbContact" inputmode="tel" value="${b.contact||''}" placeholder="9xxxxxxx"></div>
      </div>
      <div><label>المالك</label><input id="mbOwner" value="${b.owner||''}" placeholder="اسم المالك"></div>
      <div><label>ملاحظات</label><textarea id="mbNotes" rows="2" placeholder="تفاصيل إضافية">${b.notes||''}</textarea></div>

      <div class="row cols-2">
        <div><label>عدد الشقق</label><input id="mbApt" type="number" min="0" value="${Number(counts.apartments||0)}"></div>
        <div><label>عدد المحلات</label><input id="mbShop" type="number" min="0" value="${Number(counts.shops||0)}"></div>
        <div><label>عدد المعارض</label><input id="mbShow" type="number" min="0" value="${Number(counts.showrooms||0)}"></div>
        <div><label>عدد القبو</label><input id="mbBase" type="number" min="0" value="${Number(counts.basements||0)}"></div>
      </div>

      <div class="row cols-2">
        <div><label>رقم حساب الكهرباء</label><input id="mbElectric" value="${electricAccount}" placeholder="رقم الحساب"></div>
        <div><label>رقم انترنت البناية</label><input id="mbInternet" value="${internetNumber}" placeholder="رقم الاشتراك/الحساب"></div>
        <div><label>رقم حارس البناية</label><input id="mbGuard" value="${guardPhone}" placeholder="هاتف الحارس"></div>
        <div><label>رقم سائق ناقلة المجاري</label><input id="mbSewage" value="${sewageTruckPhone}" placeholder="هاتف السائق"></div>
      </div>
    </div>
    <div class="row" style="grid-template-columns:auto auto;justify-content:flex-end">
      <button type="button" class="btn primary" id="saveB">${isEdit?'💾 حفظ التعديل':'حفظ المبنى'}</button>
    </div>`);

  const feeSel = document.getElementById('mbFeeType');
  if(feeSel){
    feeSel.onchange = function(){
      const isSalary = this.value==='salary';
      document.getElementById('mbFeeLabel').textContent = isSalary ? 'الراتب الشهري (ر.ع)' : 'النسبة (%)';
      const iv = document.getElementById('mbFeeValue');
      if(iv){ iv.placeholder = isSalary ? 'مثال: 150 (ر.ع)' : 'مثال: 15 (٪)'; }
    };
  }

  const saveBtn = document.getElementById('saveB');
  if(saveBtn){
    saveBtn.onclick = async ()=>{
      const payload = {
        bizType: document.getElementById('mbBizType').value,
        feeType: document.getElementById('mbFeeType').value,
        feeValue: Number(document.getElementById('mbFeeValue').value||0),
        name: (document.getElementById('mbName').value||'').trim(),
        location: (document.getElementById('mbLocation').value||'').trim(),
        contact: (document.getElementById('mbContact').value||'').trim(),
        owner: (document.getElementById('mbOwner').value||'').trim(),
        notes: (document.getElementById('mbNotes').value||'').trim(),
        counts: {
          apartments: Number(document.getElementById('mbApt').value||0),
          shops: Number(document.getElementById('mbShop').value||0),
          showrooms: Number(document.getElementById('mbShow').value||0),
          basements: Number(document.getElementById('mbBase').value||0),
        },
        electricAccount: (document.getElementById('mbElectric').value||'').trim(),
        internetNumber: (document.getElementById('mbInternet').value||'').trim(),
        guardPhone: (document.getElementById('mbGuard').value||'').trim(),
        sewageTruckPhone: (document.getElementById('mbSewage').value||'').trim(),
      };
      if(!payload.name){ alert('أدخل اسم المبنى'); return; }

      if(isEdit){
        const id = (b && b.id) || activeBuildingId;
        await db.collection('buildings').doc(id).update(payload);
      }else{
        await createBuilding(Object.assign({createdAt:new Date().toISOString()}, payload));
      }
      closeModal();
      renderDashboard();
      if(activeBuildingId) renderBuilding();
    };
  }
}



// ===================== Building view =====================
function unitKindLabel(kind){return kind==='apartment'?'شقة':(kind==='shop'?'محل':(kind==='showroom'?'معرض':'قبو'));}

// Add building modal — يتضمن خانة "المالك"
function openAddBuildingModal(){ openUpsertBuildingModal("add"); }
window.openAddBuildingModal = openAddBuildingModal;
function openEditBuildingModal(bData){ openUpsertBuildingModal('edit', bData); }
window.openEditBuildingModal = openEditBuildingModal;


async function renderBuilding(){
  $('#view-dashboard').classList.add('hidden');const wrap=$('#view-building');wrap.classList.remove('hidden');
  const bRef=await db.collection('buildings').doc(activeBuildingId).get();const b={id:bRef.id,...bRef.data()};
  $('#buildingTitle').textContent=b.name||'';
  $('#buildingMeta').innerHTML=`${b.owner?`<div>👤 <span>${b.owner}</span></div>`:''}${b.location?`<div>📍 <span>${b.location}</span></div>`:''}${b.contact?`<div>☎️ <span>${b.contact}</span></div>`:''}${b.notes?`<div>📝 <span>${b.notes}</span></div>`:''}${b.electricAccount?`<div>⚡ <span>${b.electricAccount}</span></div>`:''}${b.internetNumber?`<div>🌐 <span>${b.internetNumber}</span></div>`:''}${b.guardPhone?`<div>👮 <span>${b.guardPhone}</span></div>`:''}${b.sewageTruckPhone?`<div>🚛 <span>${b.sewageTruckPhone}</span></div>`:''}`;

  const ms=startOfMonth(selYear,selMonth),me=endOfMonth(selYear,selMonth);
  const tenantsAll=await listTenants(b.id); const tenants=tenantsAll.filter(t=>isActiveDuring(t.startDate,t.endDate,ms,me));
  const tenantsSorted = (window.sortUnitsByKindAndNumber? window.sortUnitsByKindAndNumber(tenants) : tenants);
const expensesAll=await listExpenses(b.id); const expenses=expensesAll.filter(e=>isActiveDuring(e.date,e.date,ms,me));
  const inc=tenants.reduce((s,t)=>s+num(t.rent),0), ex=expenses.reduce((s,e)=>s+num(e.amount),0);
  $('#bkIncome').textContent=inc.toFixed(2);
  $('#bkExpenses').textContent=ex.toFixed(2);
  $('#bkNet').textContent=(inc-ex).toFixed(2);

  const counts=b.counts||{apartments:0,shops:0,showrooms:0,basements:0};
  const totalUnits=num(counts.apartments)+num(counts.shops)+num(counts.showrooms)+num(counts.basements);
  $('#stTotal').textContent=totalUnits; $('#stApt').textContent=num(counts.apartments); $('#stShop').textContent=num(counts.shops)+num(counts.showrooms);
  $('#stOcc').textContent=tenants.length; $('#stVac').textContent=Math.max(0,totalUnits-tenants.length);
  $('#stExpSoon').textContent=tenants.filter(t=>new Date(t.endDate)<=endOfMonth(selYear,selMonth+1)).length;

  // Filters & search
  const searchBox=$('#searchBox'); const chips=document.querySelectorAll('.chip');
  chips.forEach(ch=>{ ch.onclick=()=>{
      if(ch.dataset.ft) chipsState.kind=ch.dataset.ft;
      if(ch.dataset.status) chipsState.status=(chipsState.status===ch.dataset.status?null:ch.dataset.status);
      chips.forEach(x=>x.classList.remove('active'));
      document.querySelectorAll(`.chip[data-ft="${chipsState.kind}"]`).forEach(x=>x.classList.add('active'));
      if(chipsState.status){ document.querySelectorAll(`.chip[data-status="${chipsState.status}"]`).forEach(x=>x.classList.add('active')); }
      renderLists();
  };});
  searchBox.oninput=()=>renderLists();

  function renderLists(){
    const q=(searchBox.value||'').trim().toLowerCase();
    const filtered=tenants.filter(t=>{ 
      if(chipsState.kind!=='all'){ if(chipsState.kind==='shop'){ if(!(t.kind==='shop'||t.kind==='showroom')) return false; } else if(t.kind!==chipsState.kind) return false; }
      const bag=`${t.unitNumber||''} ${t.tenantName||''} ${t.phone||''} ${t.nationalId||''}`.toLowerCase();
      return !q || bag.includes(q);
    });
    
    // --- sort by kind then unitNumber ascending ---
    (function(){
      const kindOrder = { apartment:1, shop:2, showroom:3, basement:4 };
      function numLike(v){
        if(v==null) return Number.POSITIVE_INFINITY;
        const m = String(v).match(/\d+/);
        return m ? parseInt(m[0],10) : Number.POSITIVE_INFINITY;
      }
      filtered.sort((a,b)=>{
        const pa = kindOrder[a && a.kind] || 99;
        const pb = kindOrder[b && b.kind] || 99;
        if(pa!==pb) return pa - pb;
        const na = numLike(a && a.unitNumber);
        const nb = numLike(b && b.unitNumber);
        if(na!==nb) return na - nb;
        const ta = (a && a.tenantName || '').toString();
        const tb = (b && b.tenantName || '').toString();
        return ta.localeCompare(tb, 'ar');
      });
    })();
    const tenantsBox=$('#tenantsList'); tenantsBox.innerHTML=''; if(!filtered.length) tenantsBox.innerHTML='<div class="muted">لا يوجد مستأجرون حسب التصفية.</div>';
    filtered.forEach(t=>{ const row=document.createElement('div'); row.style.cssText='border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;background:#ecfdf5';
      const natPart = t.nationalId ? (' • البطاقة: '+t.nationalId) : '';
      row.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <div><div style="font-weight:600">${t.tenantName} ${(t.payments && t.payments[ymKey(selYear, selMonth)]) ? '<span style="color:#22bb33;font-weight:bold;font-size:16px">✔️</span>' : ''} <span class="muted">(${t.unitNumber||'—'})</span> <span class="badge success">مشغولة</span></div>
          <div class="muted" style="font-size:12px">${unitKindLabel(t.kind)} • إيجار: ${t.rent} • هاتف: ${t.phone||'—'}${natPart}</div>
          <div class="muted" style="font-size:12px">من ${fmtDate(t.startDate)} إلى ${fmtDate(t.endDate)}</div></div>
          <div style="display:flex;gap:6px;justify-content:flex-end;align-items:flex-start">
  <div class="tenant-actions" style="display:flex;flex-direction:column;gap:6px">
    <button type="button" class="primary exp-edit btn" data-edit>✏️ تعديل</button>
    <button type="button" class="btn" data-act="pay-tenant" data-tenant-id="${t.id}" data-bid="${b.id}">💳 دفع</button>
  </div>
  <button type="button" class="danger exp-delete btn danger" data-del>🗑️ حذف</button>
</div></div>${t.notes? `<div class="muted" style="font-size:12px;margin-top:4px">ملاحظات: ${t.notes}</div>`:''}`;
      row.querySelector('[data-del]').onclick=async()=>{ if(!confirm('هل أنت متأكد من حذف هذا المستأجر؟')){return;} const mStart=startOfMonth(selYear,selMonth);const pEnd=prevMonthEnd(selYear,selMonth);
        if(new Date(t.startDate)<mStart){await updateTenantFS(b.id,t.id,{endDate:pEnd.toISOString().slice(0,10)});}else{await deleteTenantFS(b.id,t.id);} renderBuilding();
      };

var __payBtn=row.querySelector('[data-act="pay-tenant"]'); if(__payBtn) __payBtn.onclick=async()=>{
  try{
    const bid = b.id;
    const tid = t.id;
    const ym = (typeof selYear!=='undefined' && typeof selMonth!=='undefined') ? ymKey(selYear, selMonth) : (new Date().toISOString().slice(0,7));
    openModal('تسجيل دفع', `
      <div class="row">
        <div style="grid-column:1/-1">
          <label>ملاحظة/قيمة الدفع (${ym})</label>
          <textarea id="payNote" rows="3" placeholder="مثال: 280 مقدّم أو 200 مؤخر"></textarea>
        </div>
      </div>
      <div class="row" style="grid-template-columns:1fr auto">
        <div></div><button type="button" class="btn primary" id="savePay">حفظ</button>
      </div>`);
    // Prefill last note if exists
    try{
      const tdoc = await db.collection('buildings').doc(bid).collection('tenants').doc(tid).get();
      const tdata = tdoc.exists ? tdoc.data() : {};
      const prev = tdata && tdata.payments && tdata.payments[ym];
      if(prev) document.getElementById('payNote').value = prev;
    }catch(e){}
    document.getElementById('savePay').onclick = async ()=>{
      const note = (document.getElementById('payNote').value||'').trim();
      const field = {}; field['payments.'+ym] = note || null;
      await updateTenantFS(bid, tid, field);
      // إبقاء النافذة مفتوحة وإظهار زر إصدار إيصال
      const hostRow = document.getElementById('savePay').closest('.row') || document.getElementById('savePay').parentElement;
      if(hostRow){
        let btn = document.getElementById('issueReceiptBtn');
        if(!btn){
          btn = document.createElement('button');
          btn.id = 'issueReceiptBtn';
          btn.className = 'btn';
          btn.textContent = '🧾 إصدار إيصال';
          btn.style.marginInlineStart = '8px';
          hostRow.appendChild(btn);
        }
        btn.onclick = async ()=>{
          try{
            const tdoc2 = await db.collection('buildings').doc(bid).collection('tenants').doc(tid).get();
            const t2 = tdoc2.exists ? tdoc2.data() : {};
            const bdoc = await db.collection('buildings').doc(bid).get();
            const bdata = bdoc.exists ? bdoc.data() : {};
            const unitLabel = (t2 && t2.unit? (t2.unit.number? ('وحدة '+t2.unit.number) : (t2.unit||'')) : (t2.unit||''));
            const amtStr = ((note||'').match(/\d+(?:[\.,]\d+)?/)||[])[0]||'';
            const amt = amtStr? Number(String(amtStr).replace(',','.')): null;
            if(typeof openReceiptWindow==='function'){
              openReceiptWindow({ buildingName: (bdata&&bdata.name), tenantName: (t2&&(t2.name||t2.tenantName)), unitLabel: unitLabel||'', ym: ym, note: note, amount: amt });
            }
          }catch(e){ console.warn('issue receipt failed', e); }
        };
      }
      if(typeof renderBuilding==='function') renderBuilding();
    };
  }catch(err){ console.error(err); alert('تعذر حفظ الدفع'); }
};

      row.querySelector('[data-edit]').onclick=()=>{openModal('تعديل المستأجر (ساري من هذا الشهر)',`
          <div class="row cols-2">
            <div><label>نوع الوحدة</label><select id="etKind">
              <option value="apartment" ${t.kind==='apartment'?'selected':''}>شقة</option>
              <option value="shop" ${t.kind==='shop'?'selected':''}>محل</option>
              <option value="showroom" ${t.kind==='showroom'?'selected':''}>معرض</option>
              <option value="basement" ${t.kind==='basement'?'selected':''}>قبو</option>
            </select></div>
            <div><label>رقم الشقة/المحل</label><input id="etUnit" value="${t.unitNumber||''}"></div>
            <div><label>اسم المستأجر</label><input id="etName" value="${t.tenantName||''}"></div>
            <div><label>الإيجار الشهري (ر.ع)</label><input id="etRent" type="number" step="0.001" value="${t.rent||0}"></div>
            <div><label>الهاتف</label><input id="etPhone" type="tel" value="${t.phone||''}"></div>
            <div><label>البطاقة الشخصية</label><input id="etNatId" value="${t.nationalId||''}" placeholder="رقم البطاقة"></div>
            <div><label>تاريخ الانتهاء</label><input id="etEnd" type="date" value="${t.endDate||''}"></div>
            <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="etNotes" rows="3">${t.notes||''}</textarea></div>
          </div>
          <div class="row" style="grid-template-columns:1fr auto"><div></div><button type="button" class="btn primary" id="etSave">حفظ</button></div>`);
        $('#etSave').onclick=async()=>{const patch={kind:$('#etKind').value,unitNumber:$('#etUnit').value.trim(),tenantName:$('#etName').value.trim(),rent:Number($('#etRent').value||0),phone:$('#etPhone').value.trim(),nationalId:$('#etNatId').value.trim(),notes:$('#etNotes').value.trim(),endDate:$('#etEnd').value, rentPayTiming: (document.getElementById('etPayTiming') ? document.getElementById('etPayTiming').value : (t.rentPayTiming||''))};
          if(new Date(t.startDate)<startOfMonth(selYear,selMonth)){await updateTenantFS(b.id,t.id,{endDate:prevMonthEnd(selYear,selMonth).toISOString().slice(0,10)});await addTenantFS(b.id,{...patch,startDate:startOfMonth(selYear,selMonth).toISOString().slice(0,10)});}else{await updateTenantFS(b.id,t.id,{...patch});}
          closeModal();renderBuilding();};
      };
      tenantsBox.appendChild(row);
    });
    const unitsBox=$('#unitsList');unitsBox.innerHTML=''; tenantsSorted.forEach(t=>{const li=document.createElement('div');li.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:8px';
      li.innerHTML=`<div>الوحدة <b>${t.unitNumber||'—'}</b> — ${unitKindLabel(t.kind)}</div><div><span class="badge success">مشغولة</span></div>`; unitsBox.appendChild(li);
    });
    const vacant=Math.max(0,totalUnits-tenants.length); const liVac=document.createElement('div'); liVac.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--border);border-radius:10px;padding:8px;margin-bottom:8px;background:#fff';
    liVac.innerHTML=`<div>وحدات شاغرة</div><div><span class="badge gray">${vacant}</span></div>`; unitsBox.appendChild(liVac);
  }
  renderLists();
}

// ===================== Tenants (Add) =====================
function openAddTenantModal(){ 
  openModal('إضافة مستأجر', `
    <div class="row cols-2">
      <div><label>نوع الوحدة</label>
        <select id="tKind">
          <option value="apartment">شقة</option>
          <option value="shop">محل</option>
          <option value="showroom">معرض</option>
          <option value="basement">قبو</option>
        </select>
      </div>
      <div><label>رقم الشقة/المحل</label><input id="tUnit" placeholder="مثال: 203"></div>
      <div><label>اسم المستأجر</label><input id="tName" placeholder="مثال: علي السعدي"></div>
      <div><label>الإيجار الشهري (ر.ع)</label><input id="tRent" type="number" step="0.001" placeholder="مثال: 180"></div>
      <div><label>الهاتف</label><input id="tPhone" type="tel" placeholder="9xxxxxxx"></div>
      <div><label>البطاقة الشخصية</label><input id="tNatId" inputmode="numeric" placeholder="رقم البطاقة"></div>
      <div><label>تاريخ التسجيل</label><input id="tStart" type="date" value="${todayIso()}"></div>
      <div><label>تاريخ الانتهاء</label><input id="tEnd" type="date" value="${todayIso()}"></div>
      <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="tNotes" rows="3" placeholder="تفاصيل إضافية"></textarea></div>
    
<div class="row cols-2" style="margin-top:8px">
  <div><label>تاريخ دفع الأجار</label>
    <select id="tPayTiming"><option value="advance">مقدم</option><option value="arrears">مؤخر</option></select>
  </div>
</div>
</div>
    <div class="row" style="grid-template-columns:1fr auto"><div></div>
      <button type="button" class="btn primary" id="saveT">حفظ المستأجر</button>
    </div>`);
  document.getElementById('saveT').onclick = async ()=>{ if(!activeBuildingId) return alert('اختر مبنى أولاً من الشبكة');
    const data={ kind:$('#tKind').value, unitNumber:($('#tUnit').value||'').trim(), tenantName:($('#tName').value||'').trim(), rent:Number(($('#tRent').value||0)), phone:($('#tPhone').value||'').trim(), nationalId:($('#tNatId').value||'').trim(), startDate:$('#tStart').value, endDate:$('#tEnd').value, notes:($('#tNotes').value||'').trim() };
    if(!data.unitNumber || !data.tenantName) return alert('أكمل الحقول المطلوبة');
    await addTenantFS(activeBuildingId, data); closeModal(); renderBuilding();
  };
}
window.openAddTenantModal = openAddTenantModal;

// ===================== Expenses =====================
function numberFromInputLocal(v){ if(!v) return NaN; v=String(v).replace(/[٠-٩]/g,ch=>'٠١٢٣٤٥٦٧٨٩'.indexOf(ch)).replace(/,/g,'.').replace(/[^\d.]/g,''); return Number(v); }
async function openExpensesModal(){ 
  if(!activeBuildingId) return alert('افتح مبنى أولاً');
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()};
  openModal(`مصروفات — ${b.name}`, `
    <div class="row cols-3">
      <div id="typeList"><label>نوع المصروف</label>
        <select id="exType" onchange="if(this.value==='أخرى'){document.getElementById('typeList').style.display='none';document.getElementById('typeCustom').style.display='block';document.getElementById('exTypeCustom').focus();}">
          <option value="">اختر</option>
          <option>كهرباء</option><option>ماء</option><option>رواتب</option><option>تنظيف</option><option>انترنت</option><option>صيانة</option><option>أخرى</option>
        </select>
      </div>
      <div id="typeCustom" style="display:none"><label>نوع المصروف</label>
        <div style="display:flex;gap:8px"><input id="exTypeCustom" placeholder="اكتب نوعًا"> <button type="button" class="btn" onclick="document.getElementById('typeCustom').style.display='none';document.getElementById('typeList').style.display='block';">رجوع</button></div>
      </div>
      <div><label>المبلغ (ر.ع)</label><input id="exAmount" inputmode="decimal" placeholder="مثال: 20"></div>
      <div><label>التاريخ</label><input id="exDate" type="date" value="${selYear}-${String(selMonth).padStart(2,'0')}-01"></div>
      <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="exNotes" rows="2" placeholder="تفاصيل إضافية"></textarea></div>
    </div>
    <div id="exError" class="muted" style="color:#b91c1c;margin-top:4px"></div>
    <div class="row" style="grid-template-columns:1fr auto auto">
      <div></div>
      <button type="button" class="btn primary" id="exSave">حفظ</button>
      <button type="button" class="btn danger" id="exClear">تفريغ</button>
    </div>
    <div style="height:1px;background:#e5e7eb;margin:12px 0"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>النوع</th><th>المبلغ (ر.ع)</th><th>التاريخ</th><th>ملاحظات</th><th>إجراء</th></tr></thead>
        <tbody id="expensesTbody"></tbody>
        <tfoot><tr><td style="text-align:left">المجموع:</td><td id="expensesTotalCell" style="font-weight:700"></td><td colspan="3"></td></tr></tfoot>
      </table>
    </div>`);
  document.getElementById('exClear').onclick = ()=>{ ['exType','exTypeCustom','exAmount','exNotes'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';}); const d=document.getElementById('exDate'); if(d) d.value=`${selYear}-${String(selMonth).padStart(2,'0')}-01`; document.getElementById('exError').textContent=''; };
  document.getElementById('exSave').onclick = async ()=>{ 
    let type=''; const custom=document.getElementById('typeCustom');
    if(custom && custom.style.display==='block') type = (document.getElementById('exTypeCustom')?.value||'').trim(); else { type = (document.getElementById('exType')?.value||'').trim(); if(type==='أخرى') type=''; }
    const amount = numberFromInputLocal(document.getElementById('exAmount')?.value); const date = (document.getElementById('exDate')?.value)||`${selYear}-${String(selMonth).padStart(2,'0')}-01`; const notes = (document.getElementById('exNotes')?.value)||'';
    if(!type || !isFinite(amount) || amount<=0) return document.getElementById('exError').textContent='أكمل نوع المصروف والمبلغ';
    const y = Number(date.slice(0,4)); const m = Number(date.slice(5,7)); const period = `${y}-${String(m).padStart(2,'0')}`;
    await addExpenseFS(activeBuildingId, {type, amount, date, notes, year:y, month:m, period});
    document.getElementById('exError').textContent='تم الحفظ ✓'; document.getElementById('exDate').value = `${selYear}-${String(selMonth).padStart(2,'0')}-01`; renderExpensesTable();
  };
  await renderExpensesTable();
}
window.openExpensesModal = openExpensesModal;

async function renderExpensesTable(){ 
  const rowsAll = await listExpenses(activeBuildingId); const tbody=document.getElementById('expensesTbody'); const totalCell=document.getElementById('expensesTotalCell'); if(!tbody) return;
  const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const rows = rowsAll.filter(r=> isActiveDuring(r.date,r.date, ms, me) );
  if(rows.length===0){ tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:10px">لا توجد مصروفات في هذا الشهر.</td></tr>`; if(totalCell) totalCell.textContent='0.00 ر.ع'; return; }
  tbody.innerHTML = rows.map(r=>`<tr><td>${r.type}</td><td>${Number(r.amount).toFixed(2)}</td><td>${fmtDate(r.date)}</td><td>${r.notes||''}</td><td style="white-space:nowrap"><button type="button" class="btn" onclick="editExpenseRow('${r.id}')">✏️ تعديل</button> <button type="button" class="btn danger" onclick="deleteExpenseRow('${r.id}')">🗑️ حذف</button></td></tr>`).join('');
  const total = rows.reduce((s,r)=>s+Number(r.amount||0),0); if(totalCell) totalCell.textContent = total.toFixed(2)+' ر.ع';
}

// ===================== Report =====================
async function renderReport_legacy(){ 
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()};
  const tenantsAll = await listTenants(b.id); const expensesAll = await listExpenses(b.id);
  const yyyy = selYear; const mm = String(selMonth).padStart(2,'0'); const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const tenants = tenantsAll.filter(t=> isActiveDuring(t.startDate,t.endDate, ms, me) );
  const apartments = tenants.filter(t=>t.kind==='apartment');
  const shops = tenants.filter(t=>t.kind==='shop' || t.kind==='showroom');
  const expenses = expensesAll.filter(e=> isActiveDuring(e.date,e.date, ms, me) );
  const payload = {
    buildingName: b.name || '',
    location: b.location || '',
    contact: b.contact || '',
    owner: b.owner || '',
    year: yyyy,
    month: mm,
    header: { location: b.location || '', contact: b.contact || '' },
    apartments: apartments.map(t=>({unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', nationalId:t.nationalId||'', notes:t.notes||''})),
    shops: shops.map(t=>({unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', nationalId:t.nationalId||'', notes:t.notes||''})),
    expenses: expenses.map(e=>({type:e.type||'', amount:+(e.amount||0), date:e.date||'', notes:e.notes||''}))
  };
  try{ localStorage.setItem('pm_report_payload', JSON.stringify(payload)); }catch(e){ console.warn('localStorage error', e); }
  const reportURL = new URL('property_report_pdffix.html', location.href).href;
  try{
    const html = await fetch(reportURL).then(r=>r.text());
    const w = window.open('', '_blank');
    w.document.open(); w.document.write(html); w.document.close();
  }catch(e){
    window.open(reportURL, '_blank');
  }
}

// ===================== CSV Importer =====================
function toEN(numStr){ if(!numStr) return ''; return String(numStr).replace(/[٠-٩]/g, d=>'٠١٢٣٤٥٦٧٨٩'.indexOf(d)); }
function parseDateFlex(s){
  if(!s) return '';
  s = s.trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = toEN(s).match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
  if(m){ const d=String(m[1]).padStart(2,'0'); const mo=String(m[2]).padStart(2,'0'); const y=m[3]; return `${y}-${mo}-${d}`; }
  return s;
}
function csvParseLine(raw){
  const out=[]; let cur='', q=false;
  for(let i=0;i<raw.length;i++){ const ch=raw[i];
    if(ch==='"'){ if(raw[i+1]=='"'){ cur+='"'; i++; } else { q=!q; } continue; }
    if(ch===',' && !q){ out.push(cur); cur=''; continue; }
    cur+=ch;
  }
  out.push(cur); return out;
}
function headerMap(cols){
  const map = {};
  const norm = (s)=> (s||'').trim().toLowerCase();
  cols.forEach((c,i)=>{
    const n=norm(c);
    if(['unitnumber','unit','رقم','رقم الوحدة'].includes(n)) map.unitNumber=i;
    else if(['tenantname','name','الاسم','المستأجر'].includes(n)) map.tenantName=i;
    else if(['rent','rentamount','الإيجار','الايجار','المبلغ'].includes(n)) map.rent=i;
    else if(['startdate','start','تاريخ البداية','تاريخ التسجيل'].includes(n)) map.startDate=i;
    else if(['enddate','end','تاريخ الانتهاء'].includes(n)) map.endDate=i;
    else if(['phone','phonenumber','الهاتف','الجوال','رقم الهاتف'].includes(n)) map.phone=i;
    else if(['note','notes','ملاحظة','ملاحظات'].includes(n)) map.notes=i;
    else if(['kind','type','نوع'].includes(n)) map.kind=i;
    else if(['nationalid','id','civilid','رقم البطاقة','البطاقة الشخصية'].includes(n)) map.nationalId=i; // اختياري
  });
  return map;
}
async function openImportCSV(){
  if(!activeBuildingId){ alert('اختر مبنى أولاً'); return; }
  openModal('استيراد مستأجرين (CSV)', `
    <div class="row">
      <input type="file" id="csvFile" accept=".csv,text/csv">
      <div id="csvWarn" class="muted" style="margin-top:6px"></div>
      <div style="max-height:40vh;overflow:auto;border:1px solid var(--border);border-radius:8px;margin-top:8px">
        <table id="csvPreview"><thead></thead><tbody></tbody></table>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn" onclick="closeModal()">إلغاء</button>
        <button class="btn primary" id="csvImportBtn" disabled>استيراد</button>
      </div>
    </div>`);
  const fileInput = document.getElementById('csvFile');
  const warn = document.getElementById('csvWarn');
  const btn = document.getElementById('csvImportBtn');
  const th = document.querySelector('#csvPreview thead');
  const tb = document.querySelector('#csvPreview tbody');
  let parsedRows = [];

  fileInput.onchange = ()=>{
    const f=fileInput.files&&fileInput.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const lines=String(fr.result).split(/\r?\n/).filter(l=>l.trim().length);
        if(lines.length<2){ warn.textContent='الملف فارغ.'; return; }
        const cols=csvParseLine(lines[0]);
        const map=headerMap(cols);
        const need=['unitNumber','tenantName','rent','startDate','endDate','phone'];
        const missing = need.filter(k=> !(k in map));
        if(missing.length){
          warn.textContent='الأعمدة الناقصة: '+missing.join(', ');
          btn.disabled=true;
        }else{
          warn.textContent='تم التعرف على الأعمدة ✓'+(map.nationalId!=null?' (سيتم استيراد رقم البطاقة إن وُجد)':'');
          btn.disabled=false;
        }
        th.innerHTML = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
        tb.innerHTML='';
        parsedRows=[];
        for(let i=1;i<lines.length;i++){
          const row=csvParseLine(lines[i]);
          if(row.every(c=>!c.trim())) continue;
          const unit = row[map.unitNumber]||'';
          const name = row[map.tenantName]||'';
          const rent = Number(toEN(row[map.rent]||'0'));
          const start = parseDateFlex(row[map.startDate]||'');
          const end   = parseDateFlex(row[map.endDate]||'');
          const phone = toEN(row[map.phone]||'').trim();
          const notes = (map.notes!=null? row[map.notes] : '') || '';
          let kind = (map.kind!=null? (row[map.kind]||'') : '');
          const nationalId = map.nationalId!=null ? toEN(row[map.nationalId]||'').trim() : '';
          kind = String(kind).trim().toLowerCase();
          if(/(شقة|apartment)/.test(kind)) kind='apartment';
          else if(/(محل|shop)/.test(kind)) kind='shop';
          else if(/(معرض|showroom)/.test(kind)) kind='showroom';
          else if(/(قبو|basement)/.test(kind)) kind='basement';
          else kind='apartment';
          parsedRows.push({unitNumber:unit, tenantName:name, rent, startDate:start, endDate:end, phone, nationalId, notes, kind});
          tb.innerHTML += '<tr>'+row.map(c=>`<td>${c}</td>`).join('')+'</tr>';
        }
      }catch(e){ console.error(e); warn.textContent='تعذر قراءة CSV'; }
    };
    fr.readAsText(f,'utf-8');
  };

  btn.onclick = async ()=>{
    if(!parsedRows.length) return;
    let added=0, failed=0;
    for(const r of parsedRows){
      try{ await addTenantFS(activeBuildingId, r); added++; }catch(e){ failed++; }
    }
    alert(`تم الاستيراد: ${added} • فشل: ${failed}`);
    closeModal(); renderBuilding();
  };
}
window.openImportCSV = openImportCSV;

// ===================== Modal helpers =====================
function openModal(title, html){
  document.getElementById('modalTitle').textContent=title;
  document.getElementById('modalBody').innerHTML=html;
  document.getElementById('modalWrap').classList.add('show');
  document.getElementById('modalWrap').setAttribute('aria-hidden','false');
}
function closeModal(){
  document.getElementById('modalWrap').classList.remove('show');
  document.getElementById('modalWrap').setAttribute('aria-hidden','true');
  document.getElementById('modalBody').innerHTML='';
}

// ===================== Boot =====================
populateYM();
renderDashboard();

</script>

<!-- Report Modal (Injected) -->
<style>
  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999}
  .modal-wrap.show{display:flex}
  .modal-wrap .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
  .modal-wrap .modal{position:relative;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:min(900px,94vw);max-height:90vh;overflow:auto}
  .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #e5e7eb}
  .modal .body{padding:16px}
  .modal .btn{padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer}
  .modal .btn.icon{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center}
  .report-header{padding:12px;margin:10px 0;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
  .report-header .row{display:flex;gap:16px;flex-wrap:wrap}
  .section{margin:18px 0}
  table.zebra{width:100%;border-collapse:collapse;font-size:14px}
  table.zebra th,table.zebra td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
  table.zebra thead th{background:#f5f7fb}
  table.zebra .c{text-align:center}
  table.zebra .sum{font-weight:600}
  @media print{
    .modal .head{display:none}
    .modal{box-shadow:none;border:none}
    .modal-wrap{position:static;display:block}
    .modal .body{padding:0}
  }
</style>

<div id="reportModal" class="modal-wrap" aria-hidden="true">
  <div class="backdrop" onclick="closeReport()"></div>
  <div class="modal" role="dialog" aria-modal="true">
    <div class="head">
      <h3 style="margin:0">التقرير</h3>
      <div style="display:flex;gap:8px">
        <button type="button" class="btn" onclick="exportReportPDF()">تصدير PDF</button>
        <button type="button" class="btn" onclick="closeReport()">✕</button>
      </div>
    </div>
    <div class="body">
      <div id="reportRoot">
        <div class="report-header">
          <div class="row">
            <div><b>اسم المبنى:</b> <span id="r_name">—</span></div>
            <div><b>السنة:</b> <span id="r_year">—</span></div>
            <div><b>الشهر:</b> <span id="r_month">—</span></div>
            <div><b>الموقع:</b> <span id="r_loc">—</span></div>
            <div><b>رقم التواصل:</b> <span id="r_phone">—</span></div>
          </div>
        </div>
        <div id="r_content"></div>
      </div>
    </div>
  </div>
</div>
<!-- End Report Modal (Injected) -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
(function(){
  function openReport(){ var m=document.getElementById('reportModal'); if(m){ m.classList.add('show'); m.style.display='flex'; } }
  function closeReport(){ var m=document.getElementById('reportModal'); if(m){ m.classList.remove('show'); m.style.display='none'; } }
  window.openReport = openReport;
  window.closeReport = closeReport;

  window.exportReportPDF = function(){
    var root = document.getElementById('reportRoot');
    if(!root || !window.html2pdf){ return; }
    var opt = {
      margin: 10,
      filename: 'report.pdf',
      image: { type:'jpeg', quality:0.98 },
      html2canvas: { scale: 2.0, backgroundColor:'#ffffff', letterRendering:true, scrollY: 0 },
      jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
    };
    window.html2pdf().set(opt).from(root).save();
  };

  // Helper format date safely
  function fmt(d){
    try{
      if(!d) return '';
      var dt = new Date(d);
      if(!isNaN(dt.getTime())) return dt.toISOString().slice(0,10);
      // if it's already yyyy-mm-dd
      if(typeof d === 'string' && /^\d{4}-\d{2}-\d{2}/.test(d)) return d.slice(0,10);
      return String(d);
    }catch(e){ return String(d||''); }
  }

  // Expose a safe replace for renderReport; if existed, we override.
  window.renderReport = async function(){
    try{
      function numLike(v){ try{ if(v==null) return Number.POSITIVE_INFINITY; var m = String(v).match(/\d+/); return m? parseInt(m[0],10) : Number.POSITIVE_INFINITY; }catch(e){ return Number.POSITIVE_INFINITY; } }
// Expect globals: db, activeBuildingId, selYear, selMonth, startOfMonth, endOfMonth, listTenants, listExpenses
      if(typeof db === 'undefined'){ alert('Database not initialized'); return; }
      if(typeof activeBuildingId === 'undefined' || !activeBuildingId){ alert('اختر مبنى أولاً'); return; }

      var bRef = await db.collection('buildings').doc(activeBuildingId).get();
      var b = Object.assign({id:bRef.id}, bRef.data()||{});

      var tenantsAll = (typeof listTenants === 'function') ? await listTenants(b.id) : [];
      var expensesAll = (typeof listExpenses === 'function') ? await listExpenses(b.id) : [];

      var yyyy = (typeof selYear !== 'undefined') ? selYear : new Date().getFullYear();
      var monthIndex = (typeof selMonth !== 'undefined') ? selMonth : (new Date().getMonth()+1);
      var mm = String(monthIndex).padStart(2,'0');

      var ms = (typeof startOfMonth==='function') ? startOfMonth(yyyy, monthIndex) : new Date(yyyy, monthIndex-1, 1).toISOString();
      var me = (typeof endOfMonth==='function') ? endOfMonth(yyyy, monthIndex) : new Date(yyyy, monthIndex, 0).toISOString();

      function activeDuring(s,e,from,to){
        var sd = new Date(s||from).getTime();
        var ed = new Date(e||to).getTime();
        var fd = new Date(from).getTime();
        var td = new Date(to).getTime();
        return !(ed < fd || sd > td);
      }

      var tenants = tenantsAll.filter(function(t){ return activeDuring(t.startDate, t.endDate, ms, me); });
      var apartments = tenants.filter(function(t){ return t.kind==='apartment'; });
      apartments.sort(function(a,b){return numLike(a.unitNumber)-numLike(b.unitNumber);});
      var shops = tenants.filter(function(t){ return (t.kind==='shop' || t.kind==='showroom'); });
      shops.sort(function(a,b){return numLike(a.unitNumber)-numLike(b.unitNumber);});
      var expenses = expensesAll.filter(function(e){ return activeDuring(e.date, e.date, ms, me); });

      var payload = {
        buildingName: b.name||'',
        header: { location: b.location||'', contact: b.contact||'' },
        year: yyyy, month: mm,
        apartments: apartments.map(function(t){ return {unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', notes:t.notes||''}; }),
        shops: shops.map(function(t){ return {unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', notes:t.notes||''}; }),
        expenses: expenses.map(function(e){ return {type:e.type||'', amount:+(e.amount||0), date:e.date||'', notes:e.notes||''}; })
      };

      // Fill header
      var setText = function(id, v){ var el = document.getElementById(id); if(el) el.textContent = v; };
      setText('r_name',  payload.buildingName || '—');
      setText('r_year',  String(payload.year));
      setText('r_month', String(payload.month).padStart(2,'0'));
      setText('r_loc',   payload.header.location || '—');
      setText('r_phone', payload.header.contact || '—');

      // Totals
      var totalApt = payload.apartments.reduce(function(s,t){return s + Number(t.rent||0)},0);
      var totalShop = payload.shops.reduce(function(s,t){return s + Number(t.rent||0)},0);
      var billsTotal = payload.expenses.reduce(function(s,e){return s + Number(e.amount||0)},0);
      var grand = totalApt + totalShop;
      var mgmt = 0; var feeType = (b.feeType||'percentage'); var feeValue = Number(b.feeValue||0);
      if(feeType==='salary'){ mgmt = +feeValue; } else { mgmt = +(grand * (feeValue/100)).toFixed(2); }
      var afterAll = +(grand - mgmt - billsTotal).toFixed(2);

      function rowTenant(t,i){
        return '<tr>'
          + '<td class="c">'+(i+1)+'</td>'
          + '<td class="c">'+(t.unitNumber||'')+'</td>'
          + '<td>'+(t.tenantName||'')+'</td>'
          + '<td class="c">'+Number(t.rent||0).toFixed(2)+'</td>'
          + '<td class="c">'+fmt(t.startDate)+'</td>'
          + '<td class="c">'+fmt(t.endDate)+'</td>'
          + '<td class="c">'+(t.phone||'')+'</td>'
          + '<td>'+(t.notes||'')+'</td>'
        + '</tr>';
      }

      var r = document.getElementById('r_content');
      if(!r){ alert('لم يتم العثور على حاوية التقرير'); return; }
      r.innerHTML = ''
        + '<div class="section">'
        + '  <h3>الشقق</h3>'
        + '  <table class="zebra">'
        + '    <thead><tr><th>#</th><th>شقة رقم</th><th>اسم المستأجر</th><th>الإيجار</th><th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th></tr></thead>'
        + '    <tbody>'+(payload.apartments.length ? payload.apartments.map(rowTenant).join('') : '<tr><td class="c" colspan="8">لا توجد بيانات</td></tr>')+'</tbody>'
        + '    <tfoot><tr><td colspan="3" class="c">المجموع</td><td class="c sum">'+totalApt.toFixed(2)+'</td><td colspan="4"></td></tr></tfoot>'
        + '  </table>'
        + '</div>'

        + '<div class="section">'
        + '  <h3>المحلات / المعارض</h3>'
        + '  <table class="zebra">'
        + '    <thead><tr><th>#</th><th>رقم المحل/المعرض</th><th>المستأجر</th><th>الإيجار</th><th>بداية العقد</th><th>نهاية العقد</th><th>رقم التواصل</th><th>ملاحظة</th></tr></thead>'
        + '    <tbody>'+(payload.shops.length ? payload.shops.map(rowTenant).join('') : '<tr><td class="c" colspan="8">لا توجد بيانات</td></tr>')+'</tbody>'
        + '    <tfoot><tr><td colspan="3" class="c">المجموع</td><td class="c sum">'+totalShop.toFixed(2)+'</td><td colspan="4"></td></tr></tfoot>'
        + '  </table>'
        + '</div>'

        + '<div class="section">'
        + '  <h3>المصروفات</h3>'
        + '  <table class="zebra">'
        + '    <thead><tr><th>الخدمة</th><th>قيمة الخدمة</th><th>التاريخ</th><th>ملاحظات</th></tr></thead>'
        + '    <tbody>' + (payload.expenses.length ? payload.expenses.map(function(e, i){ return `<tr><td>${e.type||''}</td><td class="c">${Number(e.amount||0).toFixed(2)}</td><td class="c">${fmt(e.date)}</td><td>${e.notes||''}</td><td class="c" style="white-space:nowrap"><button type="button" class="btn" onclick="editExpense(${i})">✏️ تعديل</button> <button type="button" class="btn danger" onclick="deleteExpense(${i})">🗑️ حذف</button></td></tr>`; }).join('') : '<tr><td class="c" colspan="5">لا توجد مصروفات</td></tr>')+'</tbody>'
        + '    <tfoot><tr><td style="text-align:left">المجموع</td><td class="c sum">'+billsTotal.toFixed(2)+'</td><td colspan="2"></td></tr></tfoot>'
        + '  </table>'
        + '</div>'

        + '<div class="section">'
        + '  <h3>الحسابات النهائية</h3>'
        + '  <table class="zebra">'
        + '    <tbody>'
        + '      <tr><td>مجموع إيجار الشقق</td><td class="c">'+totalApt.toFixed(2)+'</td></tr>'
        + '      <tr><td>مجموع إيجار المحلات</td><td class="c">'+totalShop.toFixed(2)+'</td></tr>'
        + '      <tr><td>الإيجار الكلي</td><td class="c">'+grand.toFixed(2)+'</td></tr>'
        + '      ' + ( (b.feeType||'percentage')==='salary' ? "<tr><td>راتب الإدارة</td><td class=\"c\">"+mgmt.toFixed(2)+"</td></tr>" : ("<tr><td>نسبة رسوم الإدارة "+Number(b.feeValue||0)+"%</td><td class=\"c\">"+mgmt.toFixed(2)+"</td></tr>") ) + ''
        + '      <tr><td>الفواتير</td><td class="c">'+billsTotal.toFixed(2)+'</td></tr>'
        + '      <tr><td><b>مجموع الإيجار بعد خصم الفواتير و رسوم الإدارة</b></td><td class="c sum">'+afterAll.toFixed(2)+'</td></tr>'
        + '    </tbody>'
        + '  </table>'
        + '</div>';

      openReport();
    }catch(err){
      console.error(err);
      alert('تعذر إنشاء التقرير داخل الصفحة.');
    }
  };
})();
</script>


<script>
(function(){
  var _origAdd = window.addTenantFS;
  var _origUpd = window.updateTenantFS;

  async function hasDuplicate(bid, kind, unitNumber, excludeId){
    try{
      if(!window.listTenants) return false;
      var all = await window.listTenants(bid);
      unitNumber = (unitNumber||'').toString().trim();
      kind = (kind||'').toString().trim();
      return all.some(function(t){
        if(excludeId && t.id===excludeId) return false;
        var u = (t.unitNumber||'').toString().trim();
        var k = (t.kind||'').toString().trim();
        return u && k && u===unitNumber && k===kind;
      });
    }catch(e){ return false; }
  }

  if(typeof _origAdd === 'function'){
    window.addTenantFS = async function(bid, data){
      var dup = await hasDuplicate(bid, data && data.kind, data && data.unitNumber, null);
      if(dup){
        alert('رقم الوحدة مسجّل مسبقًا لهذا النوع في نفس المبنى. لا يمكن التكرار.');
        throw new Error('duplicate-unit');
      }
      return _origAdd(bid, data);
    };
  }

  if(typeof _origUpd === 'function'){
    window.updateTenantFS = async function(bid, id, patch){
      try{
        var kind = patch && patch.kind;
        var unitNumber = patch && patch.unitNumber;
        if((!kind || !unitNumber) && window.listTenants){
          var all = await window.listTenants(bid);
          var cur = all.find(function(t){return t.id===id;});
          kind = kind || (cur && cur.kind);
          unitNumber = unitNumber || (cur && cur.unitNumber);
        }
        var dup = await hasDuplicate(bid, kind, unitNumber, id);
        if(dup){
          alert('لا يمكن حفظ التعديل: هذه الوحدة موجودة بالفعل.');
          throw new Error('duplicate-unit');
        }
      }catch(e){ if(e && e.message==='duplicate-unit') throw e; }
      return _origUpd(bid, id, patch);
    };
  }
})();
</script>


<script>
(function(){
  window.__unitPriority = function(kind){
    // Arabic mapping: شقة=apartment, محل=shop, معرض=showroom, القبو=basement (we store in English kinds)
    switch((kind||'').toLowerCase()){
      case 'apartment': return 1;
      case 'shop': return 2;
      case 'showroom': return 3;
      case 'basement': return 4;
      default: return 99;
    }
  };
  window.__numLike = function(v){
    if(v==null) return Number.POSITIVE_INFINITY;
    var m = String(v).match(/\d+/);
    return m ? parseInt(m[0],10) : Number.POSITIVE_INFINITY;
  };
  window.sortUnitsByKindAndNumber = function(arr){
    try{
      return (arr||[]).slice().sort(function(a,b){
        var pa = __unitPriority(a && a.kind);
        var pb = __unitPriority(b && b.kind);
        if(pa!==pb) return pa - pb;
        // same kind -> by unit number ascending
        var na = __numLike(a && a.unitNumber);
        var nb = __numLike(b && b.unitNumber);
        if(na!==nb) return na - nb;
        // fallback: by tenant name to stabilize
        var ta = (a && a.tenantName || '').toString();
        var tb = (b && b.tenantName || '').toString();
        return ta.localeCompare(tb, 'ar');
      });
    }catch(e){ return arr||[]; }
  };
})();
</script>


<script>
(function(){
  function isDeleteButton(btn){
    if(!btn) return false;
    var txt = (btn.textContent||'').trim();
    return /حذف/.test(txt);
  }
  document.addEventListener('click', function(e){
    var btn = e.target.closest('button');
    if(!btn) return;
    if(!btn.closest('.modal')) return; // only inside modals
    if(isDeleteButton(btn)){
      if(!confirm('هل أنت متأكد من حذف هذا السجل؟')){
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
    }
  }, true);
})();
</script>


<script>
(function(){
  function fixExpenseButtonsLayout(){
    document.querySelectorAll('.modal').forEach(function(m){
      var editBtn = Array.from(m.querySelectorAll('button')).find(b => (b.textContent||'').indexOf('تعديل')!==-1);
      var delBtn  = Array.from(m.querySelectorAll('button')).find(b => (b.textContent||'').indexOf('حذف')!==-1);
      if(editBtn && delBtn){
        var parent = editBtn.parentElement;
        if(parent && parent === delBtn.parentElement){
          parent.style.display = 'flex';
          parent.style.gap = '10px';
          parent.style.flexWrap = 'wrap';
          parent.style.alignItems = 'center';
        }
      }
    });
  }
  // Patch renderBuilding to call layout fix
  if(typeof window.renderBuilding==='function' && !window.__expLayoutPatched){
    var _old = window.renderBuilding;
    window.renderBuilding = async function(){
      var r = await _old.apply(this, arguments);
      try{ fixExpenseButtonsLayout(); }catch(e){}
      return r;
    };
    window.__expLayoutPatched = true;
  }
  window.addEventListener('load', fixExpenseButtonsLayout);
})();
</script>


<script>
(function(){
  function adjustTenantButtons(){
    var list = document.getElementById('tenantsList');
    if(!list) return;
    Array.from(list.children).forEach(function(row){
      var text = (row.textContent||'').trim();
      var actions = row.querySelector('[data-edit]') && row.querySelector('[data-del]');
      // Hide for vacant
      if(/شاغر/.test(text)){
        var actionsBox = row.querySelector('[data-edit]') && row.querySelector('[data-edit]').parentElement;
        if(actionsBox){ actionsBox.style.display = 'none'; }
      }else{
        // ensure visible for occupied
        var actionsBox = row.querySelector('[data-edit]') && row.querySelector('[data-edit]').parentElement;
        if(actionsBox){ actionsBox.style.display = 'flex'; actionsBox.style.gap='8px'; }
      }
    });
  }

  // Confirm delete on tenants list (Arabic message)
  document.addEventListener('click', function(e){
    var btn = e.target.closest('[data-del]');
    if(!btn) return;
    if(!btn.closest('#tenantsList')) return;
    var ok = confirm('هل أنت متأكد من حذف هذا المستأجر؟');
    if(!ok){ e.preventDefault(); e.stopImmediatePropagation(); }
  }, true);

  // Patch renderBuilding to run adjust after rendering
  if(typeof window.renderBuilding==='function' && !window.__tenantBtnsPatched){
    var _old = window.renderBuilding;
    window.renderBuilding = async function(){
      var r = await _old.apply(this, arguments);
      try{ adjustTenantButtons(); }catch(e){}
      return r;
    };
    window.__tenantBtnsPatched = true;
  }
  window.addEventListener('load', adjustTenantButtons);
})();
</script>


<script>
(function(){
  window.__hideVacantActions = function(){
    var list = document.getElementById('tenantsList');
    if(!list) return;
    Array.from(list.children).forEach(function(row){
      var txt = (row.textContent||'').trim();
      var bar = row.querySelector('div[style*="display:flex"][style*="gap"]');
      if(!bar) return;
      if(/شاغر|شاغرة/.test(txt)){ bar.style.display='none'; } else { bar.style.display='flex'; }
    });
  };
  if(typeof window.renderLists==='function' && !window.__vacantPatch){
    var _oldRL = window.renderLists;
    window.renderLists = function(){
      var r = _oldRL.apply(this, arguments);
      try{ window.__hideVacantActions(); }catch(e){} 
      return r;
    };
    window.__vacantPatch = true;
  }
  window.addEventListener('load', window.__hideVacantActions);
})();
</script>


<script>
// ===== injected: universal pay modal override (v2) =====
(function(){
  function ensureStyles(){
    if(document.getElementById('pay-modal-style-injected')) return;
    const css = document.createElement('style');
    css.id = 'pay-modal-style-injected';
    css.textContent = `
      .modal .buttons-row{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
      .modal .btn{border:none;border-radius:8px;padding:10px 18px;cursor:pointer;font-size:15px;transition:.2s}
      .modal .btn.primary{background:#0066cc;color:#fff}
      .modal .btn.primary:hover{background:#004c99}
      .hidden{display:none}
    `;
    document.head.appendChild(css);
  }

  function bindHandlers(){
    const saveBtn = document.getElementById('savePay');
    const receiptBtn = document.getElementById('issueReceiptBtn');
    if(!saveBtn || !receiptBtn) return;

    const prev = saveBtn.onclick;
    saveBtn.onclick = async function(ev){
      if(prev){
        try{
          const p = prev.call(this, ev);
          if(p && typeof p.then==='function') await p;
        }catch(e){ /* ignore */ }
      }else{
        const note = (document.getElementById('payNote')?.value||'').trim();
        if(!note){ alert('أدخل المبلغ أو الملاحظة أولاً'); return; }
      }
      receiptBtn.classList.remove('hidden');
    };

    receiptBtn.onclick = function(){
      const note = (document.getElementById('payNote')?.value||'').trim();
      try{
        if(typeof openReceiptWindow==='function'){
          openReceiptWindow({ note });
        }else{
          alert('🧾 تم إصدار إيصال' + (note? (' بقيمة: '+note):''));
        }
      }catch(e){ console.warn(e); alert('تعذر إصدار الإيصال'); }
    };
  }

  function payTemplate(){
    return `
      <div class="row">
        <div style="grid-column:1/-1">
          <label>ملاحظة / قيمة الدفع</label>
          <textarea id="payNote" rows="3" placeholder="مثال: 280 مقدّم أو 200 مؤخر"></textarea>
        </div>
      </div>
      <div class="row buttons-row">
        <button type="button" class="btn primary" id="savePay">💾 حفظ</button>
        <button type="button" class="btn primary hidden" id="issueReceiptBtn">🧾 إصدار إيصال</button>
      </div>
    `;
  }

  function overrideOpenModal(){
    if(!window.openModal || window.__openModalOverridden) return;
    const original = window.openModal;
    window.__openModalOverridden = true;
    window.openModal = function(title, html){
      try{
        const t = (title||'').toString();
        // Match Arabic/English for 'Pay'
        if(/\bدفع\b/i.test(t) || /\bpay\b/i.test(t)){
          ensureStyles();
          html = payTemplate();
          // call original
          original.call(this, title, html);
          // defer to ensure DOM exists
          setTimeout(bindHandlers, 0);
          return;
        }
      }catch(e){ /* fallthrough */ }
      // default
      return original.apply(this, arguments);
    };
  }

  // Wait DOM and then override
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', overrideOpenModal);
  }else{
    overrideOpenModal();
  }
})();
// ===== end injected =====
</script>


<script>
// --- injected: openReceiptWindow -> printable receipt voucher (blob) ---

window.openReceiptWindow = function(payload){
  try {
    const d = payload || {};
    const name = encodeURIComponent(d.tenantName || d.name || '');
    const amount = encodeURIComponent(d.amount || '');
    const date = encodeURIComponent(d.date || new Date().toLocaleDateString('ar-OM'));
    const being = encodeURIComponent(d.note || d.being || (d.unitLabel ? 'إيجار ' + d.unitLabel : ''));
    const bank = encodeURIComponent(d.bank || '');
    const cheque = encodeURIComponent(d.cheque || '');
    const receiver = encodeURIComponent('إدارة العقار'); // اختياري
    const sign = encodeURIComponent(d.buildingName || '');

    const url = `receipt_voucher_template_auto.html?`
      + `name=${name}&amount=${amount}&date=${date}`
      + `&being=${being}&bank=${bank}&cheque=${cheque}`
      + `&receiver=${receiver}&sign=${sign}&print=1`;

    window.open(url, "_blank", "noopener");
  } catch (e) {
    console.error("openReceiptWindow failed", e);
    alert("تعذر فتح سند القبض");
  }
};

  }

  // Global safety net: if a click on any save button happens, reveal the receipt button after a moment
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if(!t) return;
    var isSave = (t.id === 'savePay') || (String(t.textContent||'').trim().includes('حفظ'));
    if(isSave) setTimeout(showReceiptBtn, 80);
  }, true);

  // Observe DOM for modal changes
  var mo = new MutationObserver(function(){
    patchOpenModal();
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});

  // Initial
  patchOpenModal();
})();
// --- end injected v2 ---
</script>

</body></html>';
    var bootstrap = "<script>window.__PAYLOAD__=" + JSON.stringify(data) + ";</" + "script>";
    var html = tpl.replace("</head>", "</head>" + bootstrap);
    var blob = new Blob([html], {type:"text/html;charset=utf-8"});
    var url = URL.createObjectURL(blob);
    window.open(url, "_blank", "noopener");
    setTimeout(function(){ URL.revokeObjectURL(url); }, 60000);
  } catch(e) {
    console.error("openReceiptWindow failed", e);
    alert("تعذر فتح سند القبض");
  }
};
// --- end injected ---
</script>





<script>
// --- injected v2: robust alignment + show-after-save ---
(function(){
  function findSaveBtn(){
    // Try by id
    var btn = document.getElementById('savePay');
    if(btn) return btn;
    // Fallback: search in open modal for a button contains 'حفظ'
    var modals = document.querySelectorAll('.modal, [role="dialog"], .swal2-popup');
    for (var m of modals){
      var cand = Array.from(m.querySelectorAll('button, .btn')).find(b=>String(b.textContent||'').trim().includes('حفظ'));
      if(cand) return cand;
    }
    // Global search
    return Array.from(document.querySelectorAll('button, .btn')).find(b=>String(b.textContent||'').trim().includes('حفظ'));
  }

  function ensureButtonsRow(save){
    // Create or find row
    var row = save && save.closest('.buttons-row');
    if(!row){
      row = document.createElement('div');
      row.className = 'buttons-row';
      var host = (save && (save.closest('.row') || save.parentElement)) || document.body;
      if(host && host.parentElement){
        host.parentElement.insertBefore(row, host.nextSibling);
      }else{
        document.body.appendChild(row);
      }
      if(save) row.appendChild(save);
    }
    // Create or move receipt button
    var btn = document.getElementById('issueReceiptBtn');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'issueReceiptBtn';
      btn.type = 'button';
      btn.className = 'btn primary btn--sm hidden';
      btn.textContent = '🧾 إصدار إيصال';
    }else{
      btn.classList.remove('block','full','w-100');
      btn.classList.add('btn','primary','btn--sm');
    }
    row.appendChild(btn);
    // Click handler for opening receipt
    if(!btn.__bound){
      btn.__bound = true;
      btn.addEventListener('click', function(){
        try{
          var amountNote = (document.getElementById('payNote')?.value || '').trim();
          // Try to parse a number from note
          var amtMatch = amountNote.match(/\d+(?:[.,]\d+)?/);
          var amount = amtMatch ? parseFloat(amtMatch[0].replace(',','.')) : 0;
          var tenantName = window.currentTenant?.name || window.currentTenant?.tenantName || '';
          var unitLabel = window.currentTenant?.unit?.number ? ('شقة ' + window.currentTenant.unit.number) : (window.currentTenant?.unit || '');
          var ym = window.selectedYearMonth || '';
          var buildingName = window.currentBuilding?.name || '';
          if(typeof openReceiptWindow === 'function'){
            openReceiptWindow({tenantName, amount, unitLabel, ym, buildingName, print:true});
          }else{
            alert('تم حفظ الدفع. (لا توجد دالة openReceiptWindow)');
          }
        }catch(e){ console.warn(e); }
      });
    }
    return btn;
  }

  function showReceiptBtn(){
    var save = findSaveBtn();
    if(!save) return;
    var btn = ensureButtonsRow(save);
    btn.classList.remove('hidden');
  }

  // Hook to openModal if available & also use MutationObserver for safety
  var patched = false;
  function patchOpenModal(){
    if(patched) return;
    var _om = window.openModal;
    if(!_om) return;
    patched = true;
    window.openModal = function(title, html){
      var ret = _om.apply(this, arguments);
      try{
        if(/تسجيل\s*دفع/i.test(String(title)) || /pay/i.test(String(title))){
          // Wait a tick for DOM to render
          setTimeout(function(){
            var save = findSaveBtn();
            if(save){
              ensureButtonsRow(save);
              // on click show the receipt button (even if save handler is async)
              save.addEventListener('click', function(){
                setTimeout(showReceiptBtn, 50);
              }, true);
            }
          }, 0);
        }
      }catch(e){}
      return ret;
    };
  }

  // Global safety net: if a click on any save button happens, reveal the receipt button after a moment
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if(!t) return;
    var isSave = (t.id === 'savePay') || (String(t.textContent||'').trim().includes('حفظ'));
    if(isSave) setTimeout(showReceiptBtn, 80);
  }, true);

  // Observe DOM for modal changes
  var mo = new MutationObserver(function(){
    patchOpenModal();
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});

  // Initial
  patchOpenModal();
})();
// --- end injected v2 ---
</script>

</body>
</html>

<script>
window.addEventListener('load', function(){
  if(typeof __attachBuildingSearch==='function') __attachBuildingSearch();
});
</script>
