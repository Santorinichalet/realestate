<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª â€” v31f (ØªÙ‚Ø±ÙŠØ± ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯ + Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV)</title>
<style>
  :root{ --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --fg:#0f172a; --accent:#2563eb; --danger:#ef4444; --success:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(#f8fafc,#eef2f7);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic","Tahoma",sans-serif;color:var(--fg)}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
  .container{max-width:1120px;margin:0 auto;padding:14px}
  .brand{display:flex;gap:8px;align-items:center;font-weight:700}
  .brand img{height:42px;width:auto;border-radius:6px;object-fit:contain}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  .btn.icon{padding:8px 12px;border-radius:14px}
  .btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
  main{padding:14px}
  .grid{display:grid;gap:12px}
  @media(min-width:960px){.grid.cols-3{grid-template-columns:repeat(3,1fr)}}
  @media(min-width:640px){.grid.cols-2{grid-template-columns:repeat(2,1fr)}}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card-h{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .card-c{padding:10px 12px}
  .muted{color:#6b7280}
  .icon-card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border:1px solid var(--border);border-radius:16px;background:#fff;cursor:pointer;transition:transform .1s ease, box-shadow .2s ease}
  .icon-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .circle{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;background:#e0e7ff;border:1px solid #c7d2fe;font-size:24px}
  .stat{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:8px}
  .hidden{display:none !important}
  .badge{font-size:12px;border-radius:999px;padding:4px 8px;display:inline-block}
  .badge.success{background:#dcfce7;color:#166534}
  table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb}
  th,td{border:1px solid #e5e7eb;padding:6px}
  thead{background:#f8fafc}

  /* Year/Month bar */
  .ymbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .ymbar select{min-width:110px}

  /* Modal */
  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
  .modal-wrap.show{display:flex}
  .modal-wrap .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25)}
  .modal-wrap .modal{position:relative;background:#fff;border-radius:16px;border:1px solid var(--border);width:min(720px,92vw);max-height:85vh;overflow:auto}
  .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
  .modal .body{padding:12px}
  .row{display:grid;gap:10px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  label{display:block;font-size:12px;color:#374151;margin-bottom:4px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img src="https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png" alt="Logo" onerror="this.style.display='none'">
      <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª</span>
    </div>
    <div class="toolbar">
      <button type="button" class="btn icon primary" onclick="openAddBuildingModal()">â• Ù…Ø¨Ù†Ù‰</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="ymbar">
    <div>Ø§Ù„Ø³Ù†Ø©</div>
    <select id="yearSel"></select>
    <div>Ø§Ù„Ø´Ù‡Ø±</div>
    <select id="monthSel"></select>
  </div>

  <section id="view-dashboard">
    <h2>Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</h2>
    <div id="buildingsIcons" class="grid cols-3"></div>
    <div id="emptyBuildings" class="card" style="display:none">
      <div class="card-c muted" style="text-align:center;padding:24px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù†Ù â€” Ø£Ø¶Ù Ù…Ø¨Ù†Ù‰ Ù…Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© (â• Ù…Ø¨Ù†Ù‰) Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>
    </div>
  </section>

  <section id="view-building" class="hidden">
    <div class="card">
      <div class="card-h">
        <h2 id="buildingTitle"></h2>
        <div style="display:flex;gap:8px">
          <button type="button" class="btn" onclick="renderDashboard()">Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
          <button type="button" class="btn" onclick="openImportCSV()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (CSV)</button>
          <button type="button" class="btn" onclick="openExpensesModal()">ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
          <button type="button" class="btn" onclick="renderReport()">ğŸ“Š ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
      <div class="card-c">
        <div class="grid cols-3">
          <div class="stat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: <b id="stTotal">0</b></div>
          <div class="stat">Ø´Ù‚Ù‚: <b id="stApt">0</b></div>
          <div class="stat">Ù…Ø­Ù„Ø§Øª/Ù…Ø¹Ø§Ø±Ø¶: <b id="stShop">0</b></div>
          <div class="stat">Ù…Ø´ØºÙˆÙ„Ø©: <b id="stOcc">0</b></div>
          <div class="stat">Ø´Ø§ØºØ±Ø©: <b id="stVac">0</b></div>
          <div class="stat">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹ (â‰¤30 ÙŠÙˆÙ…): <b id="stExpSoon">0</b></div>
        </div>
        <div class="grid cols-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª</b></div>
            <div class="card-c" id="unitsList"><span class="muted">â€”</span></div>
          </div>
          <div class="card">
            <div class="card-h"><b>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ†</b></div>
            <div class="card-c" id="tenantsList"><span class="muted">â€”</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modalWrap" class="modal-wrap" aria-hidden="true">
  <div class="backdrop" onclick="closeModal()"></div>
  <div class="modal" role="dialog" aria-modal="true">
    <div class="head">
      <h3 id="modalTitle">Ø¹Ù†ÙˆØ§Ù†</h3>
      <button type="button" class="btn icon" onclick="closeModal()">âœ•</button>
    </div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// --- Firebase init (compat) ---
const firebaseConfig = {
  apiKey: "AIzaSyDE5ko6yQW5npxKWn0GUiz2NryqdOJUhOo",
  authDomain: "realestate-6b48f.firebaseapp.com",
  projectId: "realestate-6b48f",
  storageBucket: "realestate-6b48f.firebasestorage.app",
  messagingSenderId: "807500202227",
  appId: "1:807500202227:web:8333a119554122a36db786"
};
try { firebase.initializeApp(firebaseConfig); } catch(e){}
const db = firebase.firestore();

// Helpers
const $ = (sel, p=document)=>p.querySelector(sel);
const fmtDate = d => d ? new Date(d).toLocaleDateString('ar-OM') : '';
const todayIso = () => new Date().toISOString().slice(0,10);
const startOfMonth = (y,m)=> new Date(Date.UTC(y, m-1, 1));
const endOfMonth = (y,m)=> new Date(Date.UTC(y, m, 0, 23,59,59));
const prevMonthEnd = (y,m)=> (m===1? endOfMonth(y-1,12): endOfMonth(y,m-1));
const isActiveDuring = (s,e,ms,me)=> new Date(s) <= me && new Date(e) >= ms;
let activeBuildingId = null;
let selYear = new Date().getFullYear();
let selMonth = new Date().getMonth()+1;

// YM
function populateYM(){
  const ys = $('#yearSel'), ms = $('#monthSel');
  ys.innerHTML=''; ms.innerHTML='';
  for(let y=2018; y<=2036; y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===selYear) o.selected=true; ys.appendChild(o); }
  const months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
  months.forEach((nm,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=nm; if(i+1===selMonth) o.selected=true; ms.appendChild(o); });
  ys.onchange = ()=>{ selYear = Number(ys.value); renderDashboard(); if(activeBuildingId) renderBuilding(); };
  ms.onchange = ()=>{ selMonth = Number(ms.value); renderDashboard(); if(activeBuildingId) renderBuilding(); };
}

// Modal
function openModal(title, bodyHtml){ $('#modalTitle').textContent=title; $('#modalBody').innerHTML=bodyHtml; const w=$('#modalWrap'); w.classList.add('show'); w.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';}
function closeModal(){ const w=$('#modalWrap'); w.classList.remove('show'); w.setAttribute('aria-hidden','true'); document.body.style.overflow=''; const b=$('#modalBody'); if(b) b.scrollTop=0;}
window.closeModal = closeModal;

// Firestore CRUD
async function listBuildings(){ const snap = await db.collection('buildings').get(); return snap.docs.map(d=>({ id:d.id, ...d.data() })); }
async function createBuilding(name, notes, counts){ const ref = await db.collection('buildings').add({name, notes:notes||'', counts:counts||{apartments:0,shops:0,showrooms:0,basements:0}, createdAt:new Date().toISOString()}); return ref.id; }
async function removeBuilding(id){ await db.collection('buildings').doc(id).delete(); }
async function listTenants(bid){ const snap = await db.collection('buildings').doc(bid).collection('tenants').get(); return snap.docs.map(d=>({id:d.id, ...d.data()})); }
async function addTenantFS(bid, data){ const ref = await db.collection('buildings').doc(bid).collection('tenants').add(data); return ref.id; }
async function updateTenantFS(bid, id, patch){ await db.collection('buildings').doc(bid).collection('tenants').doc(id).update(patch); }
async function deleteTenantFS(bid, id){ await db.collection('buildings').doc(bid).collection('tenants').doc(id).delete(); }
async function listExpenses(bid){ const snap = await db.collection('buildings').doc(bid).collection('expenses').get(); return snap.docs.map(d=>({id:d.id, ...d.data()})); }
async function addExpenseFS(bid, data){ const ref = await db.collection('buildings').doc(bid).collection('expenses').add(data); return ref.id; }
async function deleteExpenseFS(bid, id){ await db.collection('buildings').doc(bid).collection('expenses').doc(id).delete(); }
window.deleteExpenseRow = async function(id){ await deleteExpenseFS(activeBuildingId, id); await renderExpensesTable(); };

// Dashboard
async function renderDashboard(){ 
  $('#view-dashboard').classList.remove('hidden'); $('#view-building').classList.add('hidden');
  const el = document.getElementById('buildingsIcons');
  el.innerHTML='';
  try{ 
    const buildings = await listBuildings();
    document.getElementById('emptyBuildings').style.display = buildings.length? 'none':'block';
    buildings.forEach(b=>{ 
      const card = document.createElement('div'); card.className='icon-card';
      card.innerHTML = `
        <div class="circle">ğŸ¢</div>
        <div style="font-weight:700">${b.name}</div>
        <div class="muted" style="font-size:12px">${b.notes||''}</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button type="button" class="btn icon" data-act="open">ÙØªØ­</button>
          <button type="button" class="btn icon" data-act="add">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±</button>
          <button type="button" class="btn icon" data-act="del">Ø­Ø°Ù</button>
        </div>`;
      card.querySelector('[data-act="open"]').onclick = async ()=>{ activeBuildingId=b.id; await renderBuilding(); };
      card.querySelector('[data-act="add"]').onclick = async ()=>{ activeBuildingId=b.id; openAddTenantModal(); };
      card.querySelector('[data-act="del"]').onclick = async ()=>{ if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰ØŸ')){ await removeBuilding(b.id); renderDashboard(); } };
      el.appendChild(card);
    });
  }catch(err){ console.error(err); document.getElementById('emptyBuildings').style.display='block'; document.querySelector('#emptyBuildings .card-c').textContent='ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ. ØªØ£ÙƒØ¯ Ù…Ù† Firestore ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.'; }
}
window.renderDashboard = renderDashboard;

// Add Building
function openAddBuildingModal(){ 
  openModal('Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù†Ù‰', `
    <div class="row">
      <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input id="mbName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø³ÙŠÙØ©"></div>
      <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="mbNotes" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea></div>
      <div class="row cols-2">
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚</label><input id="mbApt" type="number" min="0" value="0"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª</label><input id="mbShop" type="number" min="0" value="0"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶</label><input id="mbShow" type="number" min="0" value="0"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø¨Ùˆ</label><input id="mbBase" type="number" min="0" value="0"></div>
      </div>
    </div>
    <div class="row" style="grid-template-columns:auto auto;justify-content:flex-end">
      <button type="button" class="btn primary" id="saveB">Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù†Ù‰</button>
    </div>`);
  document.getElementById('saveB').onclick = async ()=>{ 
    const name=(document.getElementById('mbName').value||'').trim(); 
    const notes=(document.getElementById('mbNotes').value||'').trim(); 
    const counts={
      apartments:Number(document.getElementById('mbApt').value||0),
      shops:Number(document.getElementById('mbShop').value||0),
      showrooms:Number(document.getElementById('mbShow').value||0),
      basements:Number(document.getElementById('mbBase').value||0),
    };
    if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰');
    await createBuilding(name, notes, counts); closeModal(); renderDashboard();
  };
}
window.openAddBuildingModal = openAddBuildingModal;

// Building View
async function renderBuilding(){ 
  $('#view-dashboard').classList.add('hidden'); const wrap=$('#view-building'); wrap.classList.remove('hidden');
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()}; $('#buildingTitle').textContent=b.name;
  const tenantsAll = await listTenants(b.id);
  const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const tenants = tenantsAll.filter(t=> isActiveDuring(t.startDate,t.endDate, ms, me) );
  const counts = (b.counts)||{apartments:0,shops:0,showrooms:0,basements:0};
  const totalUnits = Number(counts.apartments||0)+Number(counts.shops||0)+Number(counts.showrooms||0)+Number(counts.basements||0);
  $('#stTotal').textContent = totalUnits;
  $('#stApt').textContent = counts.apartments||0;
  $('#stShop').textContent = (Number(counts.shops||0)+Number(counts.showrooms||0));
  $('#stOcc').textContent = tenants.length; 
  $('#stVac').textContent = Math.max(0, totalUnits - tenants.length);
  $('#stExpSoon').textContent = tenants.filter(t=> new Date(t.endDate) <= endOfMonth(selYear, selMonth+1)).length;

  const tenantsBox = $('#tenantsList'); tenantsBox.innerHTML='';
  if(!tenants.length) tenantsBox.innerHTML='<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>';
  tenants.forEach(t=>{ 
    const row=document.createElement('div');
    row.style.cssText=`border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;background:#ecfdf5`;
    row.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div>
          <div style="font-weight:600">${t.tenantName} <span class="muted">(${t.unitNumber||'â€”'})</span></div>
          <div class="muted" style="font-size:12px">${(t.kind==='apartment'?'Ø´Ù‚Ø©':(t.kind==='shop'?'Ù…Ø­Ù„':(t.kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')))} â€¢ Ø¥ÙŠØ¬Ø§Ø±: ${t.rent} â€¢ Ù‡Ø§ØªÙ: ${t.phone||'â€”'}</div>
          <div class="muted" style="font-size:12px">Ù…Ù† ${fmtDate(t.startDate)} Ø¥Ù„Ù‰ ${fmtDate(t.endDate)}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button type="button" class="btn icon" data-edit>ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
          <button type="button" class="btn icon danger" data-del>Ø­Ø°Ù Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
        </div>
      </div>
      ${t.notes? `<div class="muted" style="font-size:12px;margin-top:4px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${t.notes}</div>`:''}
    `;
    row.querySelector('[data-del]').onclick = async ()=>{
      const mStart = startOfMonth(selYear, selMonth); const pEnd = prevMonthEnd(selYear, selMonth);
      if(new Date(t.startDate) < mStart){
        await updateTenantFS(b.id, t.id, { endDate: pEnd.toISOString().slice(0,10) });
      }else{
        await deleteTenantFS(b.id, t.id);
      }
      renderBuilding();
    };
    row.querySelector('[data-edit]').onclick = ()=>{
      openModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± (Ø³Ø§Ø±ÙŠ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)', `
        <div class="row cols-2">
          <div><label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <select id="etKind">
              <option value="apartment" ${'${'}t.kind==='apartment'?'selected':''{'}'}>Ø´Ù‚Ø©</option>
              <option value="shop" ${'${'}t.kind==='shop'?'selected':''{'}'}>Ù…Ø­Ù„</option>
              <option value="showroom" ${'${'}t.kind==='showroom'?'selected':''{'}'}>Ù…Ø¹Ø±Ø¶</option>
              <option value="basement" ${'${'}t.kind==='basement'?'selected':''{'}'}>Ù‚Ø¨Ùˆ</option>
            </select>
          </div>
          <div><label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©/Ø§Ù„Ù…Ø­Ù„</label><input id="etUnit" value="${'${'}t.unitNumber||''{'}'}"></div>
          <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label><input id="etName" value="${'${'}t.tenantName||''{'}'}"></div>
          <div><label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)</label><input id="etRent" type="number" step="0.001" value="${'${'}t.rent||0{'}'}"></div>
          <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="etPhone" type="tel" value="${'${'}t.phone||''{'}'}"></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input id="etEnd" type="date" value="${'${'}t.endDate||''{'}'}"></div>
          <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="etNotes" rows="3">${'${'}t.notes || ''{'}'}</textarea></div>
        </div>
        <div class="row" style="grid-template-columns:1fr auto"><div></div>
          <button type="button" class="btn primary" id="etSave">Ø­ÙØ¸</button>
        </div>`);
      document.getElementById('etSave').onclick = async ()=>{
        const patch={ kind:$('#etKind').value, unitNumber:$('#etUnit').value.trim(), tenantName:$('#etName').value.trim(), rent:Number($('#etRent').value||0), phone:$('#etPhone').value.trim(), notes:$('#etNotes').value.trim(), endDate:$('#etEnd').value };
        const mStart = startOfMonth(selYear, selMonth).toISOString().slice(0,10);
        if(new Date(t.startDate) < startOfMonth(selYear, selMonth)){
          await updateTenantFS(b.id, t.id, { endDate: prevMonthEnd(selYear, selMonth).toISOString().slice(0,10) });
          await addTenantFS(b.id, { ...patch, startDate: mStart });
        }else{
          await updateTenantFS(b.id, t.id, { ...patch });
        }
        closeModal(); renderBuilding();
      };
    };
    tenantsBox.appendChild(row);
  });

  const unitsBox = $('#unitsList'); unitsBox.innerHTML='';
  tenants.forEach(t=>{ 
    const li=document.createElement('div');
    li.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:8px';
    li.innerHTML = `<div>Ø§Ù„ÙˆØ­Ø¯Ø© <b>${'${'}t.unitNumber||'â€”'{'}'}</b> â€” ${(t.kind==='apartment'?'Ø´Ù‚Ø©':(t.kind==='shop'?'Ù…Ø­Ù„':(t.kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')))}</div><div><span class="badge success">Ù…Ø´ØºÙˆÙ„Ø©</span></div>`;
    unitsBox.appendChild(li);
  });
}

// Add Tenant
function openAddTenantModal(){ 
  openModal('Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±', `
    <div class="row cols-2">
      <div><label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <select id="tKind">
          <option value="apartment">Ø´Ù‚Ø©</option>
          <option value="shop">Ù…Ø­Ù„</option>
          <option value="showroom">Ù…Ø¹Ø±Ø¶</option>
          <option value="basement">Ù‚Ø¨Ùˆ</option>
        </select>
      </div>
      <div><label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©/Ø§Ù„Ù…Ø­Ù„</label><input id="tUnit" placeholder="Ù…Ø«Ø§Ù„: 203"></div>
      <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label><input id="tName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø¯ÙŠ"></div>
      <div><label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)</label><input id="tRent" type="number" step="0.001" placeholder="Ù…Ø«Ø§Ù„: 180"></div>
      <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="tPhone" type="tel" placeholder="9xxxxxxx"></div>
      <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</label><input id="tStart" type="date" value="${todayIso()}"></div>
      <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input id="tEnd" type="date" value="${todayIso()}"></div>
      <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="tNotes" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea></div>
    </div>
    <div class="row" style="grid-template-columns:1fr auto"><div></div>
      <button type="button" class="btn primary" id="saveT">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</button>
    </div>`);
  document.getElementById('saveT').onclick = async ()=>{ if(!activeBuildingId) return alert('Ø§Ø®ØªØ± Ù…Ø¨Ù†Ù‰ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©');
    const data={ kind:$('#tKind').value, unitNumber:($('#tUnit').value||'').trim(), tenantName:($('#tName').value||'').trim(), rent:Number(($('#tRent').value||0)), phone:($('#tPhone').value||'').trim(), startDate:$('#tStart').value, endDate:$('#tEnd').value, notes:($('#tNotes').value||'').trim() };
    if(!data.unitNumber || !data.tenantName) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
    await addTenantFS(activeBuildingId, data); closeModal(); renderBuilding();
  };
}
window.openAddTenantModal = openAddTenantModal;

// Expenses
function numberFromInputLocal(v){ if(!v) return NaN; v=String(v).replace(/[Ù -Ù©]/g,ch=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(ch)).replace(/,/g,'.').replace(/[^\d.]/g,''); return Number(v); }
async function openExpensesModal(){ 
  if(!activeBuildingId) return alert('Ø§ÙØªØ­ Ù…Ø¨Ù†Ù‰ Ø£ÙˆÙ„Ø§Ù‹');
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()};
  openModal(`Ù…ØµØ±ÙˆÙØ§Øª â€” ${b.name}`, `
    <div class="row cols-2">
      <div id="typeList"><label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
        <select id="exType" onchange="if(this.value==='Ø£Ø®Ø±Ù‰'){document.getElementById('typeList').style.display='none';document.getElementById('typeCustom').style.display='block';document.getElementById('exTypeCustom').focus();}">
          <option value="">Ø§Ø®ØªØ±</option>
          <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>Ù…Ø§Ø¡</option><option>Ø±ÙˆØ§ØªØ¨</option><option>ØªÙ†Ø¸ÙŠÙ</option><option>Ø§Ù†ØªØ±Ù†Øª</option><option>ØµÙŠØ§Ù†Ø©</option><option>Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div id="typeCustom" style="display:none"><label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
        <div style="display:flex;gap:8px"><input id="exTypeCustom" placeholder="Ø§ÙƒØªØ¨ Ù†ÙˆØ¹Ù‹Ø§"> <button type="button" class="btn" onclick="document.getElementById('typeCustom').style.display='none';document.getElementById('typeList').style.display='block';">Ø±Ø¬ÙˆØ¹</button></div>
      </div>
      <div><label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</label><input id="exAmount" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 20"></div>
      <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="exDate" type="date" value="${'${'}selYear{'}'}-${'${'}String(selMonth).padStart(2,'0'){'}'}-01"></div>
      <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª <span class="hint">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span></label><textarea id="exNotes" rows="2" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea></div>
    </div>
    <div id="exError" class="muted" style="color:#b91c1c;margin-top:4px"></div>
    <div class="row" style="grid-template-columns:1fr auto auto">
      <div></div>
      <button type="button" class="btn primary" id="exSave">Ø­ÙØ¸</button>
      <button type="button" class="btn danger" id="exClear">ØªÙØ±ÙŠØº</button>
    </div>
    <div style="height:1px;background:#e5e7eb;margin:12px 0"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
        <tbody id="expensesTbody"></tbody>
        <tfoot><tr><td style="text-align:left">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</td><td id="expensesTotalCell" style="font-weight:700"></td><td colspan="3"></td></tr></tfoot>
      </table>
    </div>`);
  document.getElementById('exClear').onclick = ()=>{ ['exType','exTypeCustom','exAmount','exNotes'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';}); const d=document.getElementById('exDate'); if(d) d.value=`${selYear}-${String(selMonth).padStart(2,'0')}-01`; document.getElementById('exError').textContent=''; };
  document.getElementById('exSave').onclick = async ()=>{ 
    let type=''; const custom=document.getElementById('typeCustom');
    if(custom && custom.style.display==='block') type = (document.getElementById('exTypeCustom')?.value||'').trim(); else { type = (document.getElementById('exType')?.value||'').trim(); if(type==='Ø£Ø®Ø±Ù‰') type=''; }
    const amount = numberFromInputLocal(document.getElementById('exAmount')?.value); const date = (document.getElementById('exDate')?.value)||`${selYear}-${String(selMonth).padStart(2,'0')}-01`; const notes = (document.getElementById('exNotes')?.value)||'';
    if(!type || !isFinite(amount) || amount<=0) return document.getElementById('exError').textContent='Ø£ÙƒÙ…Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº';
    const y = Number(date.slice(0,4)); const m = Number(date.slice(5,7)); const period = `${y}-${String(m).padStart(2,'0')}`;
    await addExpenseFS(activeBuildingId, {type, amount, date, notes, year:y, month:m, period});
    document.getElementById('exError').textContent='ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“'; document.getElementById('exDate').value = `${selYear}-${String(selMonth).padStart(2,'0')}-01`; renderExpensesTable();
  };
  await renderExpensesTable();
}
window.openExpensesModal = openExpensesModal;

async function renderExpensesTable(){ 
  const rowsAll = await listExpenses(activeBuildingId); const tbody=document.getElementById('expensesTbody'); const totalCell=document.getElementById('expensesTotalCell'); if(!tbody) return;
  const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const rows = rowsAll.filter(r=> isActiveDuring(r.date,r.date, ms, me) );
  if(rows.length===0){ tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`; if(totalCell) totalCell.textContent='0.00 Ø±.Ø¹'; return; }
  tbody.innerHTML = rows.map(r=>`<tr><td>${r.type}</td><td>${Number(r.amount).toFixed(2)}</td><td>${fmtDate(r.date)}</td><td>${r.notes||''}</td><td><button type="button" class="btn danger" onclick="deleteExpenseRow('${'${'}r.id{'}'}')">Ø­Ø°Ù</button></td></tr>`).join('');
  const total = rows.reduce((s,r)=>s+Number(r.amount||0),0); if(totalCell) totalCell.textContent = total.toFixed(2)+' Ø±.Ø¹';
}

// Report (open in new tab with payload)
async function renderReport(){ 
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()};
  const tenantsAll = await listTenants(b.id); const expensesAll = await listExpenses(b.id);
  const yyyy = selYear; const mm = String(selMonth).padStart(2,'0'); const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const tenants = tenantsAll.filter(t=> isActiveDuring(t.startDate,t.endDate, ms, me) );
  const apartments = tenants.filter(t=>t.kind==='apartment');
  const shops = tenants.filter(t=>t.kind==='shop' || t.kind==='showroom');
  const expenses = expensesAll.filter(e=> isActiveDuring(e.date,e.date, ms, me) );
  const payload = {
    buildingName: b.name || '',
    year: yyyy,
    month: mm,
    apartments: apartments.map(t=>({unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', notes:t.notes||''})),
    shops: shops.map(t=>({unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', notes:t.notes||''})),
    expenses: expenses.map(e=>({type:e.type||'', amount:+(e.amount||0), date:e.date||'', notes:e.notes||''}))
  };
  try{ localStorage.setItem('pm_report_payload', JSON.stringify(payload)); }catch(e){ console.warn('localStorage error', e); }
  const reportURL = new URL('property_report_integrated.html', location.href).href;
  try{
    const html = await fetch(reportURL).then(r=>r.text());
    const w = window.open('', '_blank');
    w.document.open(); w.document.write(html); w.document.close();
  }catch(e){
    window.open(reportURL, '_blank');
  }
}

// ---- CSV Importer (button already added) ----
function toEN(numStr){ if(!numStr) return ''; return String(numStr).replace(/[Ù -Ù©]/g, d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)); }
function parseDateFlex(s){
  if(!s) return '';
  s = s.trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = toEN(s).match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
  if(m){ const d=String(m[1]).padStart(2,'0'); const mo=String(m[2]).padStart(2,'0'); const y=m[3]; return `${y}-${mo}-${d}`; }
  return s;
}
function csvParseLine(raw){
  const out=[]; let cur='', q=false;
  for(const ch of raw){ if(ch==='"'){ q=!q; continue; } if(ch===',' && !q){ out.push(cur); cur=''; continue; } cur+=ch; }
  out.push(cur); return out;
}
async function openImportCSV(){
  if(!activeBuildingId){ alert('Ø§Ø®ØªØ± Ù…Ø¨Ù†Ù‰ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.csv,text/csv'; inp.onchange=()=>{
    const f=inp.files&&inp.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=async ()=>{
      try{
        const lines=String(fr.result).split(/\r?\n/).filter(l=>l.trim().length);
        let added=0, failed=0;
        for(let i=0;i<lines.length;i++){
          const cols=csvParseLine(lines[i]).map(c=>c.trim());
          if(i===0 && cols.join(' ').includes('Ø§Ø³Ù…')) continue;
          const unit = cols[1]||'';
          const name = cols[2]||'';
          const rent = Number(toEN(cols[3]||'0'));
          const start = parseDateFlex(cols[4]||'');
          const end   = parseDateFlex(cols[5]||'');
          const phone = toEN(cols[6]||'').trim();
          const note  = cols[7]||'';
          let kind = (cols[8]||'').trim();
          if(/(Ø´Ù‚Ø©|apartment)/i.test(kind)) kind='apartment';
          else if(/(Ù…Ø­Ù„|shop)/i.test(kind)) kind='shop';
          else if(/(Ù…Ø¹Ø±Ø¶|showroom)/i.test(kind)) kind='showroom';
          else if(/(Ù‚Ø¨Ùˆ|basement)/i.test(kind)) kind='basement';
          else kind='apartment';
          if(!unit || !name){ failed++; continue; }
          try{
            await addTenantFS(activeBuildingId,{kind,unitNumber:unit,tenantName:name,rent,startDate:start,endDate:end,phone,notes:note});
            added++;
          }catch(e){ console.warn(e); failed++; }
        }
        alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${added} â€¢ ÙØ´Ù„: ${failed}`);
        renderBuilding();
      }catch(e){ console.error(e); alert('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© CSV'); }
    };
    fr.readAsText(f,'utf-8');
  };
  inp.click();
}

populateYM();
renderDashboard();
</script>
</body>
</html>
