<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>إدارة الممتلكات — v31f (تقرير في تبويب جديد + استيراد CSV)</title>
<style>
  :root{ --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --fg:#0f172a; --accent:#2563eb; --danger:#ef4444; --success:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(#f8fafc,#eef2f7);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic","Tahoma",sans-serif;color:var(--fg)}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
  .container{max-width:1120px;margin:0 auto;padding:14px}
  .brand{display:flex;gap:8px;align-items:center;font-weight:700}
  .brand img{height:42px;width:auto;border-radius:6px;object-fit:contain}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  .btn.icon{padding:8px 12px;border-radius:14px}
  .btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
  main{padding:14px}
  .grid{display:grid;gap:12px}
  @media(min-width:960px){.grid.cols-3{grid-template-columns:repeat(3,1fr)}}
  @media(min-width:640px){.grid.cols-2{grid-template-columns:repeat(2,1fr)}}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card-h{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .card-c{padding:10px 12px}
  .muted{color:#6b7280}
  .icon-card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border:1px solid var(--border);border-radius:16px;background:#fff;cursor:pointer;transition:transform .1s ease, box-shadow .2s ease}
  .icon-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .circle{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;background:#e0e7ff;border:1px solid #c7d2fe;font-size:24px}
  .stat{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:8px}
  .hidden{display:none !important}
  .badge{font-size:12px;border-radius:999px;padding:4px 8px;display:inline-block}
  .badge.success{background:#dcfce7;color:#166534}
  table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb}
  th,td{border:1px solid #e5e7eb;padding:6px}
  thead{background:#f8fafc}

  /* Year/Month bar */
  .ymbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .ymbar select{min-width:110px}

  /* Modal */
  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
  .modal-wrap.show{display:flex}
  .modal-wrap .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25)}
  .modal-wrap .modal{position:relative;background:#fff;border-radius:16px;border:1px solid var(--border);width:min(720px,92vw);max-height:85vh;overflow:auto}
  .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
  .modal .body{padding:12px}
  .row{display:grid;gap:10px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  label{display:block;font-size:12px;color:#374151;margin-bottom:4px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img src="https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png" alt="Logo" onerror="this.style.display='none'">
      <span>إدارة الممتلكات</span>
    </div>
    <div class="toolbar">
      <button type="button" class="btn icon primary" onclick="openAddBuildingModal()">➕ مبنى</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="ymbar">
    <div>السنة</div>
    <select id="yearSel"></select>
    <div>الشهر</div>
    <select id="monthSel"></select>
  </div>

  <section id="view-dashboard">
    <h2>المباني</h2>
    <div id="buildingsIcons" class="grid cols-3"></div>
    <div id="emptyBuildings" class="card" style="display:none">
      <div class="card-c muted" style="text-align:center;padding:24px">لا يوجد مبانٍ — أضف مبنى من أيقونة (➕ مبنى) بالأعلى.</div>
    </div>
  </section>

  <section id="view-building" class="hidden">
    <div class="card">
      <div class="card-h">
        <h2 id="buildingTitle"></h2>
        <div style="display:flex;gap:8px">
          <button type="button" class="btn" onclick="renderDashboard()">الرجوع</button>
          <button type="button" class="btn" onclick="openImportCSV()">📥 استيراد مستأجرين (CSV)</button>
          <button type="button" class="btn" onclick="openExpensesModal()">💰 المصروفات</button>
          <button type="button" class="btn" onclick="renderReport()">📊 تقرير</button>
        </div>
      </div>
      <div class="card-c">
        <div class="grid cols-3">
          <div class="stat">إجمالي الوحدات: <b id="stTotal">0</b></div>
          <div class="stat">شقق: <b id="stApt">0</b></div>
          <div class="stat">محلات/معارض: <b id="stShop">0</b></div>
          <div class="stat">مشغولة: <b id="stOcc">0</b></div>
          <div class="stat">شاغرة: <b id="stVac">0</b></div>
          <div class="stat">تنتهي قريباً (≤30 يوم): <b id="stExpSoon">0</b></div>
        </div>
        <div class="grid cols-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><b>قائمة الوحدات</b></div>
            <div class="card-c" id="unitsList"><span class="muted">—</span></div>
          </div>
          <div class="card">
            <div class="card-h"><b>المستأجرون</b></div>
            <div class="card-c" id="tenantsList"><span class="muted">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modalWrap" class="modal-wrap" aria-hidden="true">
  <div class="backdrop" onclick="closeModal()"></div>
  <div class="modal" role="dialog" aria-modal="true">
    <div class="head">
      <h3 id="modalTitle">عنوان</h3>
      <button type="button" class="btn icon" onclick="closeModal()">✕</button>
    </div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// --- Firebase init (compat) ---
const firebaseConfig = {
  apiKey: "AIzaSyDE5ko6yQW5npxKWn0GUiz2NryqdOJUhOo",
  authDomain: "realestate-6b48f.firebaseapp.com",
  projectId: "realestate-6b48f",
  storageBucket: "realestate-6b48f.firebasestorage.app",
  messagingSenderId: "807500202227",
  appId: "1:807500202227:web:8333a119554122a36db786"
};
try { firebase.initializeApp(firebaseConfig); } catch(e){}
const db = firebase.firestore();

// Helpers
const $ = (sel, p=document)=>p.querySelector(sel);
const fmtDate = d => d ? new Date(d).toLocaleDateString('ar-OM') : '';
const todayIso = () => new Date().toISOString().slice(0,10);
const startOfMonth = (y,m)=> new Date(Date.UTC(y, m-1, 1));
const endOfMonth = (y,m)=> new Date(Date.UTC(y, m, 0, 23,59,59));
const prevMonthEnd = (y,m)=> (m===1? endOfMonth(y-1,12): endOfMonth(y,m-1));
const isActiveDuring = (s,e,ms,me)=> new Date(s) <= me && new Date(e) >= ms;
let activeBuildingId = null;
let selYear = new Date().getFullYear();
let selMonth = new Date().getMonth()+1;

// YM
function populateYM(){
  const ys = $('#yearSel'), ms = $('#monthSel');
  ys.innerHTML=''; ms.innerHTML='';
  for(let y=2018; y<=2036; y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===selYear) o.selected=true; ys.appendChild(o); }
  const months=['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
  months.forEach((nm,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=nm; if(i+1===selMonth) o.selected=true; ms.appendChild(o); });
  ys.onchange = ()=>{ selYear = Number(ys.value); renderDashboard(); if(activeBuildingId) renderBuilding(); };
  ms.onchange = ()=>{ selMonth = Number(ms.value); renderDashboard(); if(activeBuildingId) renderBuilding(); };
}

// Modal
function openModal(title, bodyHtml){ $('#modalTitle').textContent=title; $('#modalBody').innerHTML=bodyHtml; const w=$('#modalWrap'); w.classList.add('show'); w.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';}
function closeModal(){ const w=$('#modalWrap'); w.classList.remove('show'); w.setAttribute('aria-hidden','true'); document.body.style.overflow=''; const b=$('#modalBody'); if(b) b.scrollTop=0;}
window.closeModal = closeModal;

// Firestore CRUD
async function listBuildings(){ const snap = await db.collection('buildings').get(); return snap.docs.map(d=>({ id:d.id, ...d.data() })); }
async function createBuilding(name, notes, counts){ const ref = await db.collection('buildings').add({name, notes:notes||'', counts:counts||{apartments:0,shops:0,showrooms:0,basements:0}, createdAt:new Date().toISOString()}); return ref.id; }
async function removeBuilding(id){ await db.collection('buildings').doc(id).delete(); }
async function listTenants(bid){ const snap = await db.collection('buildings').doc(bid).collection('tenants').get(); return snap.docs.map(d=>({id:d.id, ...d.data()})); }
async function addTenantFS(bid, data){ const ref = await db.collection('buildings').doc(bid).collection('tenants').add(data); return ref.id; }
async function updateTenantFS(bid, id, patch){ await db.collection('buildings').doc(bid).collection('tenants').doc(id).update(patch); }
async function deleteTenantFS(bid, id){ await db.collection('buildings').doc(bid).collection('tenants').doc(id).delete(); }
async function listExpenses(bid){ const snap = await db.collection('buildings').doc(bid).collection('expenses').get(); return snap.docs.map(d=>({id:d.id, ...d.data()})); }
async function addExpenseFS(bid, data){ const ref = await db.collection('buildings').doc(bid).collection('expenses').add(data); return ref.id; }
async function deleteExpenseFS(bid, id){ await db.collection('buildings').doc(bid).collection('expenses').doc(id).delete(); }
window.deleteExpenseRow = async function(id){ await deleteExpenseFS(activeBuildingId, id); await renderExpensesTable(); };

// Dashboard
async function renderDashboard(){ 
  $('#view-dashboard').classList.remove('hidden'); $('#view-building').classList.add('hidden');
  const el = document.getElementById('buildingsIcons');
  el.innerHTML='';
  try{ 
    const buildings = await listBuildings();
    document.getElementById('emptyBuildings').style.display = buildings.length? 'none':'block';
    buildings.forEach(b=>{ 
      const card = document.createElement('div'); card.className='icon-card';
      card.innerHTML = `
        <div class="circle">🏢</div>
        <div style="font-weight:700">${b.name}</div>
        <div class="muted" style="font-size:12px">${b.notes||''}</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button type="button" class="btn icon" data-act="open">فتح</button>
          <button type="button" class="btn icon" data-act="add">إضافة مستأجر</button>
          <button type="button" class="btn icon" data-act="del">حذف</button>
        </div>`;
      card.querySelector('[data-act="open"]').onclick = async ()=>{ activeBuildingId=b.id; await renderBuilding(); };
      card.querySelector('[data-act="add"]').onclick = async ()=>{ activeBuildingId=b.id; openAddTenantModal(); };
      card.querySelector('[data-act="del"]').onclick = async ()=>{ if(confirm('حذف المبنى؟')){ await removeBuilding(b.id); renderDashboard(); } };
      el.appendChild(card);
    });
  }catch(err){ console.error(err); document.getElementById('emptyBuildings').style.display='block'; document.querySelector('#emptyBuildings .card-c').textContent='تعذر تحميل المباني. تأكد من Firestore والاتصال بالإنترنت.'; }
}
window.renderDashboard = renderDashboard;

// Add Building
function openAddBuildingModal(){ 
  openModal('إضافة مبنى', `
    <div class="row">
      <div><label>اسم المبنى</label><input id="mbName" placeholder="مثال: مبنى السيفة"></div>
      <div><label>ملاحظات</label><textarea id="mbNotes" rows="3" placeholder="تفاصيل إضافية"></textarea></div>
      <div class="row cols-2">
        <div><label>عدد الشقق</label><input id="mbApt" type="number" min="0" value="0"></div>
        <div><label>عدد المحلات</label><input id="mbShop" type="number" min="0" value="0"></div>
        <div><label>عدد المعارض</label><input id="mbShow" type="number" min="0" value="0"></div>
        <div><label>عدد القبو</label><input id="mbBase" type="number" min="0" value="0"></div>
      </div>
    </div>
    <div class="row" style="grid-template-columns:auto auto;justify-content:flex-end">
      <button type="button" class="btn primary" id="saveB">حفظ المبنى</button>
    </div>`);
  document.getElementById('saveB').onclick = async ()=>{ 
    const name=(document.getElementById('mbName').value||'').trim(); 
    const notes=(document.getElementById('mbNotes').value||'').trim(); 
    const counts={
      apartments:Number(document.getElementById('mbApt').value||0),
      shops:Number(document.getElementById('mbShop').value||0),
      showrooms:Number(document.getElementById('mbShow').value||0),
      basements:Number(document.getElementById('mbBase').value||0),
    };
    if(!name) return alert('أدخل اسم المبنى');
    await createBuilding(name, notes, counts); closeModal(); renderDashboard();
  };
}
window.openAddBuildingModal = openAddBuildingModal;

// Building View
async function renderBuilding(){ 
  $('#view-dashboard').classList.add('hidden'); const wrap=$('#view-building'); wrap.classList.remove('hidden');
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()}; $('#buildingTitle').textContent=b.name;
  const tenantsAll = await listTenants(b.id);
  const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const tenants = tenantsAll.filter(t=> isActiveDuring(t.startDate,t.endDate, ms, me) );
  const counts = (b.counts)||{apartments:0,shops:0,showrooms:0,basements:0};
  const totalUnits = Number(counts.apartments||0)+Number(counts.shops||0)+Number(counts.showrooms||0)+Number(counts.basements||0);
  $('#stTotal').textContent = totalUnits;
  $('#stApt').textContent = counts.apartments||0;
  $('#stShop').textContent = (Number(counts.shops||0)+Number(counts.showrooms||0));
  $('#stOcc').textContent = tenants.length; 
  $('#stVac').textContent = Math.max(0, totalUnits - tenants.length);
  $('#stExpSoon').textContent = tenants.filter(t=> new Date(t.endDate) <= endOfMonth(selYear, selMonth+1)).length;

  const tenantsBox = $('#tenantsList'); tenantsBox.innerHTML='';
  if(!tenants.length) tenantsBox.innerHTML='<div class="muted">لا يوجد مستأجرون في هذا الشهر.</div>';
  tenants.forEach(t=>{ 
    const row=document.createElement('div');
    row.style.cssText=`border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;background:#ecfdf5`;
    row.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div>
          <div style="font-weight:600">${t.tenantName} <span class="muted">(${t.unitNumber||'—'})</span></div>
          <div class="muted" style="font-size:12px">${(t.kind==='apartment'?'شقة':(t.kind==='shop'?'محل':(t.kind==='showroom'?'معرض':'قبو')))} • إيجار: ${t.rent} • هاتف: ${t.phone||'—'}</div>
          <div class="muted" style="font-size:12px">من ${fmtDate(t.startDate)} إلى ${fmtDate(t.endDate)}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button type="button" class="btn icon" data-edit>تعديل من هذا الشهر</button>
          <button type="button" class="btn icon danger" data-del>حذف من هذا الشهر</button>
        </div>
      </div>
      ${t.notes? `<div class="muted" style="font-size:12px;margin-top:4px">ملاحظات: ${t.notes}</div>`:''}
    `;
    row.querySelector('[data-del]').onclick = async ()=>{
      const mStart = startOfMonth(selYear, selMonth); const pEnd = prevMonthEnd(selYear, selMonth);
      if(new Date(t.startDate) < mStart){
        await updateTenantFS(b.id, t.id, { endDate: pEnd.toISOString().slice(0,10) });
      }else{
        await deleteTenantFS(b.id, t.id);
      }
      renderBuilding();
    };
    row.querySelector('[data-edit]').onclick = ()=>{
      openModal('تعديل المستأجر (ساري من هذا الشهر)', `
        <div class="row cols-2">
          <div><label>نوع الوحدة</label>
            <select id="etKind">
              <option value="apartment" ${'${'}t.kind==='apartment'?'selected':''{'}'}>شقة</option>
              <option value="shop" ${'${'}t.kind==='shop'?'selected':''{'}'}>محل</option>
              <option value="showroom" ${'${'}t.kind==='showroom'?'selected':''{'}'}>معرض</option>
              <option value="basement" ${'${'}t.kind==='basement'?'selected':''{'}'}>قبو</option>
            </select>
          </div>
          <div><label>رقم الشقة/المحل</label><input id="etUnit" value="${'${'}t.unitNumber||''{'}'}"></div>
          <div><label>اسم المستأجر</label><input id="etName" value="${'${'}t.tenantName||''{'}'}"></div>
          <div><label>الإيجار الشهري (ر.ع)</label><input id="etRent" type="number" step="0.001" value="${'${'}t.rent||0{'}'}"></div>
          <div><label>الهاتف</label><input id="etPhone" type="tel" value="${'${'}t.phone||''{'}'}"></div>
          <div><label>تاريخ الانتهاء</label><input id="etEnd" type="date" value="${'${'}t.endDate||''{'}'}"></div>
          <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="etNotes" rows="3">${'${'}t.notes || ''{'}'}</textarea></div>
        </div>
        <div class="row" style="grid-template-columns:1fr auto"><div></div>
          <button type="button" class="btn primary" id="etSave">حفظ</button>
        </div>`);
      document.getElementById('etSave').onclick = async ()=>{
        const patch={ kind:$('#etKind').value, unitNumber:$('#etUnit').value.trim(), tenantName:$('#etName').value.trim(), rent:Number($('#etRent').value||0), phone:$('#etPhone').value.trim(), notes:$('#etNotes').value.trim(), endDate:$('#etEnd').value };
        const mStart = startOfMonth(selYear, selMonth).toISOString().slice(0,10);
        if(new Date(t.startDate) < startOfMonth(selYear, selMonth)){
          await updateTenantFS(b.id, t.id, { endDate: prevMonthEnd(selYear, selMonth).toISOString().slice(0,10) });
          await addTenantFS(b.id, { ...patch, startDate: mStart });
        }else{
          await updateTenantFS(b.id, t.id, { ...patch });
        }
        closeModal(); renderBuilding();
      };
    };
    tenantsBox.appendChild(row);
  });

  const unitsBox = $('#unitsList'); unitsBox.innerHTML='';
  tenants.forEach(t=>{ 
    const li=document.createElement('div');
    li.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:8px';
    li.innerHTML = `<div>الوحدة <b>${'${'}t.unitNumber||'—'{'}'}</b> — ${(t.kind==='apartment'?'شقة':(t.kind==='shop'?'محل':(t.kind==='showroom'?'معرض':'قبو')))}</div><div><span class="badge success">مشغولة</span></div>`;
    unitsBox.appendChild(li);
  });
}

// Add Tenant
function openAddTenantModal(){ 
  openModal('إضافة مستأجر', `
    <div class="row cols-2">
      <div><label>نوع الوحدة</label>
        <select id="tKind">
          <option value="apartment">شقة</option>
          <option value="shop">محل</option>
          <option value="showroom">معرض</option>
          <option value="basement">قبو</option>
        </select>
      </div>
      <div><label>رقم الشقة/المحل</label><input id="tUnit" placeholder="مثال: 203"></div>
      <div><label>اسم المستأجر</label><input id="tName" placeholder="مثال: علي السعدي"></div>
      <div><label>الإيجار الشهري (ر.ع)</label><input id="tRent" type="number" step="0.001" placeholder="مثال: 180"></div>
      <div><label>الهاتف</label><input id="tPhone" type="tel" placeholder="9xxxxxxx"></div>
      <div><label>تاريخ التسجيل</label><input id="tStart" type="date" value="${todayIso()}"></div>
      <div><label>تاريخ الانتهاء</label><input id="tEnd" type="date" value="${todayIso()}"></div>
      <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="tNotes" rows="3" placeholder="تفاصيل إضافية"></textarea></div>
    </div>
    <div class="row" style="grid-template-columns:1fr auto"><div></div>
      <button type="button" class="btn primary" id="saveT">حفظ المستأجر</button>
    </div>`);
  document.getElementById('saveT').onclick = async ()=>{ if(!activeBuildingId) return alert('اختر مبنى أولاً من الشبكة');
    const data={ kind:$('#tKind').value, unitNumber:($('#tUnit').value||'').trim(), tenantName:($('#tName').value||'').trim(), rent:Number(($('#tRent').value||0)), phone:($('#tPhone').value||'').trim(), startDate:$('#tStart').value, endDate:$('#tEnd').value, notes:($('#tNotes').value||'').trim() };
    if(!data.unitNumber || !data.tenantName) return alert('أكمل الحقول المطلوبة');
    await addTenantFS(activeBuildingId, data); closeModal(); renderBuilding();
  };
}
window.openAddTenantModal = openAddTenantModal;

// Expenses
function numberFromInputLocal(v){ if(!v) return NaN; v=String(v).replace(/[٠-٩]/g,ch=>'٠١٢٣٤٥٦٧٨٩'.indexOf(ch)).replace(/,/g,'.').replace(/[^\d.]/g,''); return Number(v); }
async function openExpensesModal(){ 
  if(!activeBuildingId) return alert('افتح مبنى أولاً');
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()};
  openModal(`مصروفات — ${b.name}`, `
    <div class="row cols-2">
      <div id="typeList"><label>نوع المصروف</label>
        <select id="exType" onchange="if(this.value==='أخرى'){document.getElementById('typeList').style.display='none';document.getElementById('typeCustom').style.display='block';document.getElementById('exTypeCustom').focus();}">
          <option value="">اختر</option>
          <option>كهرباء</option><option>ماء</option><option>رواتب</option><option>تنظيف</option><option>انترنت</option><option>صيانة</option><option>أخرى</option>
        </select>
      </div>
      <div id="typeCustom" style="display:none"><label>نوع المصروف</label>
        <div style="display:flex;gap:8px"><input id="exTypeCustom" placeholder="اكتب نوعًا"> <button type="button" class="btn" onclick="document.getElementById('typeCustom').style.display='none';document.getElementById('typeList').style.display='block';">رجوع</button></div>
      </div>
      <div><label>المبلغ (ر.ع)</label><input id="exAmount" inputmode="decimal" placeholder="مثال: 20"></div>
      <div><label>التاريخ</label><input id="exDate" type="date" value="${'${'}selYear{'}'}-${'${'}String(selMonth).padStart(2,'0'){'}'}-01"></div>
      <div style="grid-column:1/-1"><label>ملاحظات <span class="hint">اختياري</span></label><textarea id="exNotes" rows="2" placeholder="تفاصيل إضافية"></textarea></div>
    </div>
    <div id="exError" class="muted" style="color:#b91c1c;margin-top:4px"></div>
    <div class="row" style="grid-template-columns:1fr auto auto">
      <div></div>
      <button type="button" class="btn primary" id="exSave">حفظ</button>
      <button type="button" class="btn danger" id="exClear">تفريغ</button>
    </div>
    <div style="height:1px;background:#e5e7eb;margin:12px 0"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>النوع</th><th>المبلغ (ر.ع)</th><th>التاريخ</th><th>ملاحظات</th><th>إجراء</th></tr></thead>
        <tbody id="expensesTbody"></tbody>
        <tfoot><tr><td style="text-align:left">المجموع:</td><td id="expensesTotalCell" style="font-weight:700"></td><td colspan="3"></td></tr></tfoot>
      </table>
    </div>`);
  document.getElementById('exClear').onclick = ()=>{ ['exType','exTypeCustom','exAmount','exNotes'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';}); const d=document.getElementById('exDate'); if(d) d.value=`${selYear}-${String(selMonth).padStart(2,'0')}-01`; document.getElementById('exError').textContent=''; };
  document.getElementById('exSave').onclick = async ()=>{ 
    let type=''; const custom=document.getElementById('typeCustom');
    if(custom && custom.style.display==='block') type = (document.getElementById('exTypeCustom')?.value||'').trim(); else { type = (document.getElementById('exType')?.value||'').trim(); if(type==='أخرى') type=''; }
    const amount = numberFromInputLocal(document.getElementById('exAmount')?.value); const date = (document.getElementById('exDate')?.value)||`${selYear}-${String(selMonth).padStart(2,'0')}-01`; const notes = (document.getElementById('exNotes')?.value)||'';
    if(!type || !isFinite(amount) || amount<=0) return document.getElementById('exError').textContent='أكمل نوع المصروف والمبلغ';
    const y = Number(date.slice(0,4)); const m = Number(date.slice(5,7)); const period = `${y}-${String(m).padStart(2,'0')}`;
    await addExpenseFS(activeBuildingId, {type, amount, date, notes, year:y, month:m, period});
    document.getElementById('exError').textContent='تم الحفظ ✓'; document.getElementById('exDate').value = `${selYear}-${String(selMonth).padStart(2,'0')}-01`; renderExpensesTable();
  };
  await renderExpensesTable();
}
window.openExpensesModal = openExpensesModal;

async function renderExpensesTable(){ 
  const rowsAll = await listExpenses(activeBuildingId); const tbody=document.getElementById('expensesTbody'); const totalCell=document.getElementById('expensesTotalCell'); if(!tbody) return;
  const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const rows = rowsAll.filter(r=> isActiveDuring(r.date,r.date, ms, me) );
  if(rows.length===0){ tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:10px">لا توجد مصروفات في هذا الشهر.</td></tr>`; if(totalCell) totalCell.textContent='0.00 ر.ع'; return; }
  tbody.innerHTML = rows.map(r=>`<tr><td>${r.type}</td><td>${Number(r.amount).toFixed(2)}</td><td>${fmtDate(r.date)}</td><td>${r.notes||''}</td><td><button type="button" class="btn danger" onclick="deleteExpenseRow('${'${'}r.id{'}'}')">حذف</button></td></tr>`).join('');
  const total = rows.reduce((s,r)=>s+Number(r.amount||0),0); if(totalCell) totalCell.textContent = total.toFixed(2)+' ر.ع';
}

// Report (open in new tab with payload)
async function renderReport(){ 
  const bRef = await db.collection('buildings').doc(activeBuildingId).get(); const b={id:bRef.id, ...bRef.data()};
  const tenantsAll = await listTenants(b.id); const expensesAll = await listExpenses(b.id);
  const yyyy = selYear; const mm = String(selMonth).padStart(2,'0'); const ms = startOfMonth(selYear, selMonth), me=endOfMonth(selYear, selMonth);
  const tenants = tenantsAll.filter(t=> isActiveDuring(t.startDate,t.endDate, ms, me) );
  const apartments = tenants.filter(t=>t.kind==='apartment');
  const shops = tenants.filter(t=>t.kind==='shop' || t.kind==='showroom');
  const expenses = expensesAll.filter(e=> isActiveDuring(e.date,e.date, ms, me) );
  const payload = {
    buildingName: b.name || '',
    year: yyyy,
    month: mm,
    apartments: apartments.map(t=>({unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', notes:t.notes||''})),
    shops: shops.map(t=>({unitNumber:t.unitNumber||'', tenantName:t.tenantName||'', rent:+(t.rent||0), startDate:t.startDate, endDate:t.endDate, phone:t.phone||'', notes:t.notes||''})),
    expenses: expenses.map(e=>({type:e.type||'', amount:+(e.amount||0), date:e.date||'', notes:e.notes||''}))
  };
  try{ localStorage.setItem('pm_report_payload', JSON.stringify(payload)); }catch(e){ console.warn('localStorage error', e); }
  const reportURL = new URL('property_report_integrated.html', location.href).href;
  try{
    const html = await fetch(reportURL).then(r=>r.text());
    const w = window.open('', '_blank');
    w.document.open(); w.document.write(html); w.document.close();
  }catch(e){
    window.open(reportURL, '_blank');
  }
}

// ---- CSV Importer (button already added) ----
function toEN(numStr){ if(!numStr) return ''; return String(numStr).replace(/[٠-٩]/g, d=>'٠١٢٣٤٥٦٧٨٩'.indexOf(d)); }
function parseDateFlex(s){
  if(!s) return '';
  s = s.trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = toEN(s).match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
  if(m){ const d=String(m[1]).padStart(2,'0'); const mo=String(m[2]).padStart(2,'0'); const y=m[3]; return `${y}-${mo}-${d}`; }
  return s;
}
function csvParseLine(raw){
  const out=[]; let cur='', q=false;
  for(const ch of raw){ if(ch==='"'){ q=!q; continue; } if(ch===',' && !q){ out.push(cur); cur=''; continue; } cur+=ch; }
  out.push(cur); return out;
}
async function openImportCSV(){
  if(!activeBuildingId){ alert('اختر مبنى أولاً'); return; }
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.csv,text/csv'; inp.onchange=()=>{
    const f=inp.files&&inp.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=async ()=>{
      try{
        const lines=String(fr.result).split(/\r?\n/).filter(l=>l.trim().length);
        let added=0, failed=0;
        for(let i=0;i<lines.length;i++){
          const cols=csvParseLine(lines[i]).map(c=>c.trim());
          if(i===0 && cols.join(' ').includes('اسم')) continue;
          const unit = cols[1]||'';
          const name = cols[2]||'';
          const rent = Number(toEN(cols[3]||'0'));
          const start = parseDateFlex(cols[4]||'');
          const end   = parseDateFlex(cols[5]||'');
          const phone = toEN(cols[6]||'').trim();
          const note  = cols[7]||'';
          let kind = (cols[8]||'').trim();
          if(/(شقة|apartment)/i.test(kind)) kind='apartment';
          else if(/(محل|shop)/i.test(kind)) kind='shop';
          else if(/(معرض|showroom)/i.test(kind)) kind='showroom';
          else if(/(قبو|basement)/i.test(kind)) kind='basement';
          else kind='apartment';
          if(!unit || !name){ failed++; continue; }
          try{
            await addTenantFS(activeBuildingId,{kind,unitNumber:unit,tenantName:name,rent,startDate:start,endDate:end,phone,notes:note});
            added++;
          }catch(e){ console.warn(e); failed++; }
        }
        alert(`تم الاستيراد: ${added} • فشل: ${failed}`);
        renderBuilding();
      }catch(e){ console.error(e); alert('تعذر قراءة CSV'); }
    };
    fr.readAsText(f,'utf-8');
  };
  inp.click();
}

populateYM();
renderDashboard();
</script>
</body>
</html>
