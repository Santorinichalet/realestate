<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª â€” Ù†Ø³Ø®Ø© Ù…Ù†Ø¸Ù…Ø© (v8) â€” Fixed</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#f7f9fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --border:#e5e7eb; --accent:#1f6fff; --accent-2:#1558d6; --success:#16a34a; --danger:#ef4444; --kpi:#f8fafc; }
html,body{ background:linear-gradient(180deg,#fbfcfe 0%,#f2f5f9 100%); }
body{ margin:0; direction:rtl; text-align:right; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-family:"Tajawal","Noto Naskh Arabic",system-ui,-apple-system,"Segoe UI",Roboto,"Tahoma",sans-serif; color:var(--fg); font-size:15px; line-height:1.6; }
*,*:before,*:after{ box-sizing:border-box; }
.container{ max-width:1200px; margin:0 auto; padding:14px; }
.grid{ display:grid; gap:12px; }
@media(min-width:960px){ .cols-3{ grid-template-columns:repeat(3,1fr);} }
@media(min-width:640px){ .cols-2{ grid-template-columns:repeat(2,1fr);} }
.hidden{ display:none !important; }
.kv{ display:flex; flex-wrap:wrap; gap:12px; color:#374151; }
header{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,.85); backdrop-filter:blur(8px); border-bottom:1px solid var(--border); }
.brand{ display:flex; align-items:center; gap:8px; font-weight:700; }
.brand img{ height:42px; width:auto; border-radius:6px; object-fit:contain; }
.toolbar{ display:flex; gap:8px; flex-wrap:wrap; }
.btn{ display:inline-flex; align-items:center; justify-content:center; gap:6px; border:1px solid var(--border); background:#fff; color:#0f172a; border-radius:10px; padding:10px 14px; cursor:pointer; transition:all .15s; font-size:14px; }
.btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.06); }
.btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 2px 6px rgba(31,111,255,.25); }
.btn.danger{ background:var(--danger); color:#fff; border-color:var(--danger); box-shadow:0 2px 6px rgba(239,68,68,.25); }
.card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); overflow:hidden; }
.card-h{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
.card-c{ padding:12px 14px; }
.muted{ color:var(--muted); }
.stat{ background:var(--kpi); border:1px solid var(--border); border-radius:12px; padding:12px 14px; display:flex; align-items:center; gap:10px; }
.icon-card{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; transition:transform .12s, box-shadow .18s; }
.icon-card:hover{ transform:translateY(-2px); box-shadow:0 10px 28px rgba(0,0,0,.07); }
.circle{ width:54px; height:54px; border-radius:50%; display:grid; place-items:center; background:#e0e7ff; border:1px solid #c7d2fe; font-size:22px; }
input,select,textarea{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff; transition:border-color .15s, box-shadow .15s; }
input:focus,select:focus,textarea:focus{ outline:none; border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
label{ color:#374151; font-size:12px; margin-bottom:6px; display:block; }
.filters{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.chip{ border:1px solid var(--border); padding:6px 12px; border-radius:999px; cursor:pointer; background:#fff; transition:all .15s; }
.chip.active{ background:#eef2ff; border-color:#c7d2fe; }
table{ width:100%; border-collapse:collapse; border:1px solid var(--border); background:#fff; }
th,td{ border:1px solid var(--border); padding:8px 10px; }
thead{ background:#f8fafc; }
.modal-wrap{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:100; }
.modal-wrap.show{ display:flex; }
.modal-wrap .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.25) }
.modal-wrap .modal{ position:relative; background:#fff; border-radius:18px; border:1px solid var(--border); width:min(820px,94vw); max-height:88vh; overflow:auto; }
.modal .head{ padding:14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; }
.modal .body{ padding:14px; }
.modal .buttons-row{ display:flex; align-items:center; gap:8px; justify-content:flex-end; margin-top:10px; }
@media print{ header,.toolbar,.filters,.modal-wrap{ display:none !important; } }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; }
.badge.success{ background:#ecfdf5; border-color:#bbf7d0; }
.badge.gray{ background:#f3f4f6; border-color:#e5e7eb; }
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img src="https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png" alt="Logo" onerror="this.style.display='none'">
      <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª</span>
    </div>
    <div class="toolbar">
      <button type="button" class="btn primary" id="btnAddBuilding">â• Ù…Ø¨Ù†Ù‰</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="ymbar" style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
    <div>Ø§Ù„Ø³Ù†Ø©</div>
    <select id="yearSel"></select>
    <div>Ø§Ù„Ø´Ù‡Ø±</div>
    <select id="monthSel"></select>
  </div>

  <section class="grid cols-3" id="kpis">
    <div class="stat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯): <b id="kpiIncome">0</b> Ø±.Ø¹</div>
    <div class="stat">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯): <b id="kpiExpenses">0</b> Ø±.Ø¹</div>
    <div class="stat">Ø§Ù„ØµØ§ÙÙŠ: <b id="kpiNet">0</b> Ø±.Ø¹</div>
  </section>

  <section id="view-dashboard" style="margin-top:10px">
    <div id="bizTabs" class="filters" style="margin:8px 0">
      <div class="chip active" data-biz="Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</div>
      <div class="chip" data-biz="Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ">Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ</div>
    </div>

    <div class="topbar" style="display:flex;gap:8px;align-items:center;margin:6px 0 2px 0">
      <input id="bizSearchInput" type="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù…Ø§Ù„Ùƒ / Ø§Ù„Ù…ÙˆÙ‚Ø¹" aria-label="Ø¨Ø­Ø«" style="flex:1;min-width:220px" />
    </div>

    <h2 style="margin:6px 0">Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</h2>
    <div id="buildingsGrid" class="grid cols-3" data-buildings-grid></div>
    <div id="emptyBuildings" class="card" style="display:none">
      <div class="card-c muted" style="text-align:center;padding:24px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù†Ù â€” Ø£Ø¶Ù Ù…Ø¨Ù†Ù‰ Ù…Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© (â• Ù…Ø¨Ù†Ù‰) Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>
    </div>
  </section>

  <section id="view-building" class="hidden">
    <div class="card">
      <div class="card-h">
        <div>
          <h2 id="buildingTitle" style="margin:0 0 4px"></h2>
          <div id="buildingMeta" class="kv" style="font-size:13px"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button type="button" class="btn" id="btnBack">Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
          <button type="button" class="btn" id="btnEditBuilding">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰</button>
          <button type="button" class="btn" id="btnImportCSV">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (CSV)</button>
          <button type="button" class="btn primary" id="btnAddTenant">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±</button>
          <button type="button" class="btn" id="btnExpenses">ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
          <button type="button" class="btn" id="btnReport">ğŸ“Š ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>

      <div class="card-c">
        <div class="grid cols-3" style="margin-bottom:8px">
          <div class="stat">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ø´Ù‡Ø±): <b id="bkIncome">0</b> Ø±.Ø¹</div>
          <div class="stat">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ø´Ù‡Ø±): <b id="bkExpenses">0</b> Ø±.Ø¹</div>
          <div class="stat">Ø§Ù„ØµØ§ÙÙŠ (Ø§Ù„Ø´Ù‡Ø±): <b id="bkNet">0</b> Ø±.Ø¹</div>
        </div>

        <div class="grid cols-3">
          <div class="stat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: <b id="stTotal">0</b></div>
          <div class="stat">Ø´Ù‚Ù‚: <b id="stApt">0</b></div>
          <div class="stat">Ù…Ø­Ù„Ø§Øª/Ù…Ø¹Ø§Ø±Ø¶: <b id="stShop">0</b></div>
          <div class="stat">Ù…Ø´ØºÙˆÙ„Ø©: <b id="stOcc">0</b></div>
          <div class="stat">Ø´Ø§ØºØ±Ø©: <b id="stVac">0</b></div>
          <div class="stat">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹ (â‰¤30 ÙŠÙˆÙ…): <b id="stExpSoon">0</b></div>
        </div>

        <div class="filters" style="margin:12px 0">
          <input id="searchBox" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙˆØ­Ø¯Ø©/Ø§Ù„Ù‡Ø§ØªÙ/Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" style="max-width:260px">
          <div class="chip" data-ft="all">Ø§Ù„ÙƒÙ„</div>
          <div class="chip" data-ft="apartment">Ø´Ù‚Ù‚</div>
          <div class="chip" data-ft="shop">Ù…Ø­Ù„Ø§Øª</div>
          <div class="chip" data-ft="showroom">Ù…Ø¹Ø§Ø±Ø¶</div>
          <div class="chip" data-ft="basement">Ù‚Ø¨Ùˆ</div>
          <div class="chip" data-status="occupied">Ù…Ø´ØºÙˆÙ„Ø©</div>
          <div class="chip" data-status="vacant">Ø´Ø§ØºØ±Ø©</div>
        </div>

        <div class="grid cols-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª</b></div>
            <div class="card-c" id="unitsList"><span class="muted">â€”</span></div>
          </div>
          <div class="card">
            <div class="card-h"><b>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ†</b></div>
            <div class="card-c" id="tenantsList"><span class="muted">â€”</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modalWrap" class="modal-wrap" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="modal" role="dialog" aria-modal="true">
    <div class="head">
      <h3 id="modalTitle">Ø¹Ù†ÙˆØ§Ù†</h3>
      <button type="button" class="btn" data-close>âœ•</button>
    </div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
const App = (()=>{
  const State = {
    activeBuildingId: null,
    selYear: (new Date()).getFullYear(),
    selMonth: (new Date()).getMonth()+1,
    chipsState: { kind:'all', status:null },
    bizTab: 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ',
    bizSearchQuery: '',
    cachedBuildings: []
  };

  const firebaseConfig = {
    apiKey:"AIzaSyDE5ko6yQW5npxKWn0GUiz2NryqdOJUhOo",
    authDomain:"realestate-6b48f.firebaseapp.com",
    projectId:"realestate-6b48f",
    storageBucket:"realestate-6b48f.firebasestorage.app",
    messagingSenderId:"807500202227",
    appId:"1:807500202227:web:8333a119554122a36db786"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();

  const $  = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const todayIso = ()=> new Date().toISOString().slice(0,10);
  const fmtDate  = d => d ? new Date(d).toLocaleDateString('ar-OM') : '';

  // Robust month helpers
  const startOfMonth = (y,m)=> new Date(Date.UTC(y, m-1, 1));
  const endOfMonth   = (y,m)=> new Date(Date.UTC(y, m, 0, 23,59,59));
  const prevMonthEnd = (y,m)=> (m===1? endOfMonth(y-1,12) : endOfMonth(y, m-1));

  // Treat empty endDate as open-ended
  const parseDate = (v)=> v ? new Date(v) : null;
  const isActiveDuring = (s,e,ms,me)=>{
    const sd = parseDate(s) || new Date(0);
    const ed = parseDate(e) || new Date('9999-12-31');
    return sd <= me && ed >= ms;
  };

  const num   = v => Number(v||0);
  const ymKey = (y,m)=> String(y).padStart(4,'0') + '-' + String(m).padStart(2,'0');

  const monthsSinceStartIncl = (startY, startM, y, m)=> (y*12+m) - (startY*12+startM) + 1;

  const FB = {
    listBuildings: async()=> (await db.collection('buildings').get()).docs.map(d=>({id:d.id, ...d.data()})),
    createBuilding: async(data)=> (await db.collection('buildings').add(data)).id,
    updateBuilding: async(id,patch)=> db.collection('buildings').doc(id).update(patch),
    removeBuilding: async(id)=> db.collection('buildings').doc(id).delete(),
    listTenants: async(bid)=> (await db.collection('buildings').doc(bid).collection('tenants').get()).docs.map(d=>({id:d.id, ...d.data()})),
    addTenant: async(bid,data)=> (await db.collection('buildings').doc(bid).collection('tenants').add(data)).id,
    updateTenant: async(bid,id,patch)=> db.collection('buildings').doc(bid).collection('tenants').doc(id).update(patch),
    deleteTenant: async(bid,id)=> db.collection('buildings').doc(bid).collection('tenants').doc(id).delete(),
    listExpenses: async(bid)=> (await db.collection('buildings').doc(bid).collection('expenses').get()).docs.map(d=>({id:d.id, ...d.data()})),
    addExpense: async(bid,data)=> (await db.collection('buildings').doc(bid).collection('expenses').add(data)).id,
    updateExpense: async(bid,id,patch)=> db.collection('buildings').doc(bid).collection('expenses').doc(id).update(patch),
    deleteExpense: async(bid,id)=> db.collection('buildings').doc(bid).collection('expenses').doc(id).delete(),
  };

  const UI = {
    openModal(title, html){ $('#modalTitle').textContent = title||''; $('#modalBody').innerHTML = html||''; $('#modalWrap').classList.add('show'); },
    closeModal(){ $('#modalWrap').classList.remove('show'); $('#modalBody').innerHTML=''; },
    confirm(msg){ return window.confirm(msg||'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ'); },
    toast(msg){ alert(msg); }
  };
  $('#modalWrap').addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) UI.closeModal(); });

  // Sorting helpers (fixed Arabic digits regex)
  const normalizeDigits = (s) => String(s).replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d => {
    const code = d.charCodeAt(0);
    const base = (code >= 0x06F0) ? 0x06F0 : 0x0660;
    return String(code - base);
  });
  const naturalKey = (val) => {
    const s = normalizeDigits(val || '');
    const parts = s.match(/\d+|\D+/g) || [];
    return parts.map(p => /^\d+$/.test(p) ? parseInt(p, 10) : p.trim().toLowerCase());
  };
  const cmpNatural = (a, b) => {
    const ka = naturalKey(a), kb = naturalKey(b);
    const n = Math.max(ka.length, kb.length);
    for (let i = 0; i < n; i++) {
      const xa = ka[i], xb = kb[i];
      if (xa === undefined) return -1;
      if (xb === undefined) return 1;
      const na = typeof xa === 'number', nb = typeof xb === 'number';
      if (na && nb) { if (xa !== xb) return xa - xb; }
      else { const sa = String(xa), sb = String(xb); if (sa !== sb) return sa.localeCompare(sb, 'ar'); }
    }
    return 0;
  };

  const Render = {
    populateYM(){
      const ys = $('#yearSel'), ms = $('#monthSel');
      ys.innerHTML=''; ms.innerHTML='';
      for(let y=2018; y<=2036; y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===State.selYear) o.selected=true; ys.appendChild(o); }
      const months = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
      months.forEach((nm,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=nm; if(i+1===State.selMonth) o.selected=true; ms.appendChild(o); });
      ys.onchange = ()=>{ State.selYear = Number(ys.value); Render.dashboard(); if(State.activeBuildingId) Render.building(); };
      ms.onchange = ()=>{ State.selMonth= Number(ms.value); Render.dashboard(); if(State.activeBuildingId) Render.building(); };
    },

    async dashboard(){
      $('#view-dashboard').classList.remove('hidden');
      $('#view-building').classList.add('hidden');
      const grid = $('#buildingsGrid'); grid.innerHTML='';

      const tabs = $('#bizTabs');
      tabs.onclick = (e)=>{
        const chip = e.target.closest('.chip[data-biz]'); if(!chip) return;
        $$('#bizTabs .chip').forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        State.bizTab = chip.getAttribute('data-biz') || 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ';
        Render.dashboard();
      };
      const inp = $('#bizSearchInput'); let tmo;
      inp.oninput = ()=>{ clearTimeout(tmo); tmo = setTimeout(()=>{ State.bizSearchQuery = inp.value || ''; Render.dashboard(); }, 150); };

      try{
        const buildings = await FB.listBuildings();
        State.cachedBuildings = buildings;

        // Update counts on tabs
        const cAdmin = buildings.filter(b => (b.bizType || 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ') === 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ').length;
        const cOwners = buildings.filter(b => (b.bizType || 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ') === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ').length;
        const adminChip = document.querySelector('#bizTabs .chip[data-biz="Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ"]');
        const ownersChip = document.querySelector('#bizTabs .chip[data-biz="Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ"]');
        if (adminChip) adminChip.textContent = `Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ (${cAdmin})`;
        if (ownersChip) ownersChip.textContent = `Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ (${cOwners})`;

        let filtered = buildings.filter(b => (b.bizType || 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ') === State.bizTab);
        const q = (State.bizSearchQuery||'').trim().toLowerCase();
        if(q){ filtered = filtered.filter(b => ( ((b.name||'')+' '+(b.owner||'')+' '+(b.location||'')+' '+(b.contact||'')).toLowerCase().includes(q) )); }

        $('#emptyBuildings').style.display = filtered.length ? 'none' : 'block';

        filtered.forEach(b=>{
          const counts = b.counts || {};
          const card = document.createElement('div');
          card.className = 'icon-card';
          card.innerHTML = `
            <div class="circle">ğŸ¢</div>
            <div style="font-weight:700">${b.name||''}</div>
            <div class="muted" style="font-size:12px">${b.owner? 'ğŸ‘¤ Ø§Ù„Ù…Ø§Ù„Ùƒ: '+b.owner : ''}</div>
            <div class="muted" style="font-size:12px">${b.location? 'ğŸ“ '+b.location : ''}</div>
            <div class="muted" style="font-size:12px">${b.contact? 'â˜ï¸ '+b.contact : ''}</div>
            ${b.notes? `<div class="muted" style="font-size:12px">${b.notes}</div>`:''}
            <div class="muted" style="font-size:12px">
              Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${(Number(counts.apartments||0)+Number(counts.shops||0)+Number(counts.showrooms||0)+Number(counts.basements||0)) || 0}
            </div>
            <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
              <button type="button" class="btn" data-act="open">ÙØªØ­</button>
              <button type="button" class="btn" data-act="addTenant">${(b.bizType||'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ')==='Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ'?'Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ':'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±'}</button>
              <button type="button" class="btn" data-act="edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button type="button" class="btn danger" data-act="delete">Ø­Ø°Ù</button>
            </div>`;
          card.addEventListener('click', async (e)=>{
            const btn = e.target.closest('[data-act]'); if(!btn) return;
            if(btn.dataset.act==='open'){ State.activeBuildingId=b.id; await Render.building(); }
            else if(btn.dataset.act==='addTenant'){ State.activeBuildingId=b.id; Actions.openAddTenant(); }
            else if(btn.dataset.act==='edit'){ Actions.openEditBuilding(b); }
            else if(btn.dataset.act==='delete'){ if(UI.confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰ØŸ')){ await FB.removeBuilding(b.id); Render.dashboard(); } }
          });
          grid.appendChild(card);
        });

        // KPIs (global)
        let income=0, expenses=0;
        const ms = startOfMonth(State.selYear, State.selMonth);
        const me = endOfMonth(State.selYear, State.selMonth);
        for(const b of buildings){
          const tenants = await FB.listTenants(b.id);
          const activeTenants = tenants.filter(t=> isActiveDuring(t.startDate, t.endDate, ms, me));
          // exclude grace-period months from income
          const incT = activeTenants.filter(t=>{
            const sd = new Date(t.startDate);
            const mSince = monthsSinceStartIncl(sd.getUTCFullYear(), sd.getUTCMonth()+1, State.selYear, State.selMonth);
            return !(t.graceEnabled && Number(t.graceMonths||0) >= mSince);
          }).reduce((s,t)=> s + num(t.rent), 0);
          income += incT;
          const exps = await FB.listExpenses(b.id);
          expenses += exps.filter(e=> isActiveDuring(e.date, e.date, ms, me)).reduce((s,e)=> s + num(e.amount), 0);
        }
        $('#kpiIncome').textContent = income.toFixed(2);
        $('#kpiExpenses').textContent = expenses.toFixed(2);
        $('#kpiNet').textContent = (income-expenses).toFixed(2);
      }catch(err){
        console.error(err);
        $('#emptyBuildings').style.display='block';
        $('#emptyBuildings .card-c').textContent='ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ.';
      }
    },

    async building(){
      $('#view-dashboard').classList.add('hidden');
      $('#view-building').classList.remove('hidden');

      const ref = await firebase.firestore().collection('buildings').doc(State.activeBuildingId).get();
      const b = { id: ref.id, ...(ref.data()||{}) };

      const isOA = (b.bizType === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
      const tSing = isOA ? 'Ù…Ø§Ù„Ùƒ' : 'Ù…Ø³ØªØ£Ø¬Ø±';
      const tPlural = isOA ? 'Ø§Ù„Ù…Ù„Ø§Ùƒ' : 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ†';
      const tImport = isOA ? 'ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ø§Ùƒ (CSV)' : 'ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (CSV)';
      const addBtn = document.getElementById('btnAddTenant'); if (addBtn) addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© ' + tSing;
      const impBtn = document.getElementById('btnImportCSV'); if (impBtn) impBtn.textContent = tImport;
      const tenantsHeaderEl = document.querySelector('#view-building .grid.cols-2 .card:nth-child(2) .card-h b');
      if (tenantsHeaderEl) tenantsHeaderEl.textContent = tPlural;

      $('#buildingTitle').textContent = b.name || '';
      $('#buildingMeta').innerHTML = [
        b.owner? `ğŸ‘¤ <span>${b.owner}</span>` : '',
        b.location? `ğŸ“ <span>${b.location}</span>` : '',
        b.contact? `â˜ï¸ <span>${b.contact}</span>` : '',
        b.notes? `ğŸ“ <span>${b.notes}</span>` : '',
        b.electricAccount? `âš¡ <span>${b.electricAccount}</span>` : '',
        b.internetNumber? `ğŸŒ <span>${b.internetNumber}</span>` : '',
        b.guardPhone? `ğŸ‘® <span>${b.guardPhone}</span>` : '',
        b.sewageTruckPhone? `ğŸš› <span>${b.sewageTruckPhone}</span>` : '',
      ].filter(Boolean).map(x=>`<div>${x}</div>`).join('');

      const ms = startOfMonth(State.selYear, State.selMonth);
      const me = endOfMonth(State.selYear, State.selMonth);
      const tenantsAll = await FB.listTenants(b.id);
      let tenants = tenantsAll.filter(t=> isActiveDuring(t.startDate, t.endDate, ms, me));
      const expensesAll = await FB.listExpenses(b.id);
      const expenses = expensesAll.filter(e=> isActiveDuring(e.date, e.date, ms, me));

      // compute total units and stats
      const counts = b.counts || {};
      const totalUnits = (counts.apartments||0) + (counts.shops||0) + (counts.showrooms||0) + (counts.basements||0);

      // Sorting for tenants
      function normalizeDigits2(s) {
        return String(s||'').replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d => {
          const code = d.charCodeAt(0);
          const base = (code >= 0x06F0) ? 0x06F0 : 0x0660;
          return String(code - base);
        });
      }
      function naturalKey2(val){
        const s = normalizeDigits2(val||'');
        const parts = s.match(/\d+|\D+/g) || [];
        return parts.map(p => /^\d+$/.test(p) ? parseInt(p,10) : p.trim().toLowerCase());
      }
      function cmpNatural2(a,b){
        const ka = naturalKey2(a), kb = naturalKey2(b);
        const n = Math.max(ka.length, kb.length);
        for(let i=0;i<n;i++){
          const xa = ka[i], xb = kb[i];
          if(xa===undefined) return -1;
          if(xb===undefined) return 1;
          const na = typeof xa==='number', nb = typeof xb==='number';
          if(na && nb){ if(xa!==xb) return xa-xb; }
          else { const sa=String(xa), sb=String(xb); if(sa!==sb) return sa.localeCompare(sb,'ar'); }
        }
        return 0;
      }
      function normKind(k){
        const s = String(k||'').toLowerCase();
        if (/Ø´Ù‚Ø©|apartment/.test(s)) return 'apartment';
        if (/Ù…Ø­Ù„|shop/.test(s))     return 'shop';
        if (/Ù…Ø¹Ø±Ø¶|showroom/.test(s))return 'showroom';
        if (/Ù‚Ø¨Ùˆ|Ù‚Ø¨|basement/.test(s)) return 'basement';
        return 'apartment';
      }
      function unitCore(u){
        return String(u||'').replace(/^\s*(Ø´Ù‚Ø©|Ù…Ø­Ù„|Ù…Ø¹Ø±Ø¶|Ù‚Ø¨Ùˆ)\s*/i,'');
      }

      tenants.sort((a,b)=>{
        const order = {apartment:1, shop:2, showroom:3, basement:4};
        const ka = order[normKind(a && a.kind)] || 99;
        const kb = order[normKind(b && b.kind)] || 99;
        if (ka !== kb) return ka - kb;
        const c  = cmpNatural2(unitCore(a && a.unitNumber), unitCore(b && b.unitNumber));
        if (c) return c;
        const ta = (a && a.tenantName || '').toString().trim();
        const tb = (b && b.tenantName || '').toString().trim();
        return ta.localeCompare(tb, 'ar', {sensitivity:'base', numeric:true});
      });

      searchBox.oninput = ()=> renderLists();

      function applyFilters(base){
        const q=(searchBox.value||'').trim().toLowerCase();
        return base.filter(t=>{
          if(State.chipsState.kind!=='all'){
            if(State.chipsState.kind==='shop'){
              if(!(t.kind==='shop' || t.kind==='showroom')) return false;
            } else if(t.kind!==State.chipsState.kind){ return false; }
          }
          const bag = `${t.unitNumber||''} ${t.tenantName||''} ${t.phone||''} ${t.nationalId||''}`.toLowerCase();
          return !q || bag.includes(q);
        });
      }

      function labelKind(kind){ return kind==='apartment'?'Ø´Ù‚Ø©':(kind==='shop'?'Ù…Ø­Ù„':(kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')); }

      function renderLists(){
        const filtered = applyFilters(tenants);
        const tenantsBox = $('#tenantsList'); tenantsBox.innerHTML='';
        if(!filtered.length){ tenantsBox.innerHTML='<div class="muted">'+(isOA?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ùƒ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙÙŠØ©.':'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ØªØµÙÙŠØ©.')+'</div>'; }
        filtered.forEach(t=>{
          const row = document.createElement('div');
          row.style.cssText='border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;background:#ecfdf5';
          const natPart = t.nationalId ? (' â€¢ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: '+t.nationalId) : '';
          const ym = ymKey(State.selYear, State.selMonth);
          const paidMark = (t.payments && t.payments[ym]) ? '<span style="color:#22bb33;font-weight:bold;font-size:16px">âœ”ï¸</span>' : '';
          const payNote = (t.payments && t.payments[ym]) ? `<div class="muted" style="font-size:12px;margin-top:4px;color:#1558d6">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¯ÙØ¹: ${t.payments[ym]}</div>` : '';

          const ptLabel = t.paymentType==='delayed' ? 'Ù…Ø¤Ø®Ø±Ø§Ù‹' : 'Ù…Ù‚Ø¯Ù…Ø§Ù‹';
          const graceLabel = (t.graceEnabled && Number(t.graceMonths||0)>0) ? ` â€¢ ÙØªØ±Ø© Ø³Ù…Ø§Ø­: ${Number(t.graceMonths)} Ø´Ù‡Ø±` : '';

          row.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
              <div>
                <div style="font-weight:600"><span data-tenant-name>${t.tenantName}</span> ${paidMark} <span class="muted">(<span data-unit>${t.unitNumber||'â€”'}</span>)</span> <span class="badge success">Ù…Ø´ØºÙˆÙ„Ø©</span></div>
                <div class="muted" style="font-size:12px">${labelKind(t.kind)} â€¢ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: <span data-rent>${t.rent}</span> Ø±.Ø¹ â€¢ Ø§Ù„Ø¯ÙØ¹: ${ptLabel}${graceLabel} â€¢ Ù‡Ø§ØªÙ: <span data-phone>${t.phone||'â€”'}</span>${natPart?`<span data-id>${natPart}</span>`:''}</div>
                <div class="muted" style="font-size:12px">Ù…Ù† <span data-start>${fmtDate(t.startDate)}</span> Ø¥Ù„Ù‰ <span data-end>${fmtDate(t.endDate)}</span></div>
              </div>
              <div style="display:flex;gap:6px;justify-content:flex-end;align-items:flex-start">
                <div class="tenant-actions" style="display:flex;flex-direction:column;gap:6px">
                  <button type="button" class="btn primary" data-edit>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                  <button type="button" class="btn" data-pay>ğŸ’³ Ø¯ÙØ¹</button>
                  <button type="button" class="btn" data-receipt
                          data-tenant-name="${t.tenantName||t.name||''}"
                          data-unit="${t.unitNumber||t.unit||''}"
                          data-rent="${t.rent||t.amount||0}"
                          data-kind="${t.kind||''}"
                          data-phone="${t.phone||''}"
                          data-id="${t.nationalId||t.id||''}"
                          data-paydate="${t.payDate||''}">ğŸ§¾ Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„</button>
                  <button type="button" class="btn" data-contract
                          data-tenant-name="${t.tenantName||t.name||''}"
                          data-unit="${t.unitNumber||t.unit||''}"
                          data-rent="${t.rent||t.amount||0}"
                          data-kind="${t.kind||''}"
                          data-phone="${t.phone||''}"
                          data-id="${t.nationalId||t.id||''}"
                          data-paydate="${t.payDate||''}">ğŸ“ƒ Ø¥ØµØ¯Ø§Ø± Ø¹Ù‚Ø¯</button>
                </div>
                <button type="button" class="btn danger" data-del>ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </div>
            </div>
            ${payNote}
            ${t.notes? `<div class="muted" style="font-size:12px;margin-top:4px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${t.notes}</div>`:''}
          `;
          // dataset for report
          row.setAttribute('data-tenant-row','');
          row.dataset.unit       = t.unitNumber || '';
          row.dataset.tenantName = t.tenantName || '';
          row.dataset.id         = t.nationalId || '';
          row.dataset.rent       = t.rent || '';
          row.dataset.phone      = t.phone || '';
          row.dataset.start      = t.startDate || '';
          row.dataset.end        = t.endDate || '';
          row.dataset.notes      = (t.payments && t.payments[ym]) ? t.payments[ym] : (t.notes || '');
          row.dataset.kind       = t.kind || '';

          // delete
          row.querySelector('[data-del]').onclick = async (ev)=>{
            ev.stopPropagation();
            if(!UI.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ ' + (isOA?'Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±') + 'ØŸ')) return;
            const mStart = startOfMonth(State.selYear, State.selMonth);
            const pEnd = prevMonthEnd(State.selYear, State.selMonth);
            if(new Date(t.startDate) < mStart){
              await FB.updateTenant(b.id, t.id, { endDate: pEnd.toISOString().slice(0,10) });
            }else{
              await FB.deleteTenant(b.id, t.id);
            }
            Render.building();
          };

          // pay
          row.querySelector('[data-pay]').onclick = async (ev)=>{
            ev.stopPropagation();
            const ym = ymKey(State.selYear, State.selMonth);
            UI.openModal('ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹', `
              <div class="row">
                <div style="grid-column:1/-1">
                  <label>Ù…Ù„Ø§Ø­Ø¸Ø©/Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹ (${ym})</label>
                  <textarea id="payNote" rows="3" placeholder="Ù…Ø«Ø§Ù„: 280 Ù…Ù‚Ø¯Ù‘Ù… Ø£Ùˆ 200 Ù…Ø¤Ø®Ø±"></textarea>
                </div>
              </div>
              <div class="buttons-row">
                <button type="button" class="btn primary" id="savePay">Ø­ÙØ¸</button>
              </div>
            `);
            try{
              const tdoc = await firebase.firestore().collection('buildings').doc(b.id).collection('tenants').doc(t.id).get();
              const tdata = tdoc.exists ? tdoc.data() : {};
              const prev = tdata && tdata.payments && tdata.payments[ym];
              if(prev) document.getElementById('payNote').value = prev;
            }catch(e){}
            document.getElementById('savePay').onclick = async ()=>{
              const note = (document.getElementById('payNote').value||'').trim();
              const field = {}; field['payments.'+ym] = note || null;
              await FB.updateTenant(b.id, t.id, field);
              UI.closeModal();
              Render.building();
            };
          };

          // edit
          row.querySelector('[data-edit]').onclick = (ev)=>{
            ev.stopPropagation();
            UI.openModal('ØªØ¹Ø¯ÙŠÙ„ ' + (isOA?'Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±') + ' (Ø³Ø§Ø±ÙŠ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)', `
              <div class="grid cols-2">
                <div>
                  <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                  <select id="etKind">
                    <option value="apartment" ${t.kind==='apartment'?'selected':''}>Ø´Ù‚Ø©</option>
                    <option value="shop" ${t.kind==='shop'?'selected':''}>Ù…Ø­Ù„</option>
                    <option value="showroom" ${t.kind==='showroom'?'selected':''}>Ù…Ø¹Ø±Ø¶</option>
                    <option value="basement" ${t.kind==='basement'?'selected':''}>Ù‚Ø¨Ùˆ</option>
                  </select>
                </div>
                <div><label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©/Ø§Ù„Ù…Ø­Ù„</label><input id="etUnit" value="${t.unitNumber||''}"></div>
                <div><label>${isOA?'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'}</label><input id="etName" value="${t.tenantName||''}"></div>
                <div><label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)</label><input id="etRent" type="number" step="0.001" value="${t.rent||0}"></div>
                <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="etPhone" type="tel" value="${t.phone||''}"></div>
                <div><label>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label><input id="etNatId" value="${t.nationalId||''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"></div>
                <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input id="etEnd" type="date" value="${t.endDate||''}"></div>
                <div>
                  <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
                  <select id="etPaymentType">
                    <option value="advance" ${t.paymentType!=='delayed'?'selected':''}>Ù…Ù‚Ø¯Ù…Ø§Ù‹</option>
                    <option value="delayed" ${t.paymentType==='delayed'?'selected':''}>Ù…Ø¤Ø®Ø±Ø§Ù‹</option>
                  </select>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <label style="margin:0">ÙØªØ±Ø© Ø³Ù…Ø§Ø­ØŸ</label>
                  <input id="etGraceEnabled" type="checkbox" ${t.graceEnabled?'checked':''} />
                </div>
                <div><label>Ù…Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø­ (Ø£Ø´Ù‡Ø±)</label><input id="etGraceMonths" type="number" min="0" step="1" value="${Number(t.graceMonths||0)}"></div>
                <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="etNotes" rows="3">${t.notes||''}</textarea></div>
              </div>
              <div class="buttons-row">
                <button type="button" class="btn primary" id="etSave">Ø­ÙØ¸</button>
              </div>
            `);
            document.getElementById('etSave').onclick = async ()=>{
              const patch = {
                kind: document.getElementById('etKind').value,
                unitNumber: document.getElementById('etUnit').value.trim(),
                tenantName: document.getElementById('etName').value.trim(),
                rent: Number(document.getElementById('etRent').value||0),
                phone: document.getElementById('etPhone').value.trim(),
                nationalId: document.getElementById('etNatId').value.trim(),
                notes: document.getElementById('etNotes').value.trim(),
                endDate: document.getElementById('etEnd').value,
                paymentType: document.getElementById('etPaymentType').value,
                graceEnabled: document.getElementById('etGraceEnabled').checked,
                graceMonths: Number(document.getElementById('etGraceMonths').value||0)
              };
              if(new Date(t.startDate) < startOfMonth(State.selYear, State.selMonth)){
                await FB.updateTenant(b.id, t.id, { endDate: prevMonthEnd(State.selYear, State.selMonth).toISOString().slice(0,10) });
                await FB.addTenant(b.id, { ...patch, startDate: startOfMonth(State.selYear, State.selMonth).toISOString().slice(0,10) });
              }else{
                await FB.updateTenant(b.id, t.id, { ...patch });
              }
              UI.closeModal();
              Render.building();
            };
          };

          document.getElementById('tenantsList').appendChild(row);
        });

        // Units list
        const unitsBox = $('#unitsList'); unitsBox.innerHTML='';
        const filteredUnits = applyFilters(tenants);
        filteredUnits.forEach(t=>{
          const li = document.createElement('div');
          li.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:8px';
          li.innerHTML = `<div>Ø§Ù„ÙˆØ­Ø¯Ø© <b>${t.unitNumber||'â€”'}</b> â€” ${labelKind(t.kind)}</div><div><span class="badge success">Ù…Ø´ØºÙˆÙ„Ø©</span></div>`;
          unitsBox.appendChild(li);
        });
        const vacant = Math.max(0, (Number(totalUnits)||0) - tenants.length);
        const liVac = document.createElement('div');
        liVac.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--border);border-radius:10px;padding:8px;margin-bottom:8px;background:#fff';
        liVac.innerHTML = `<div>ÙˆØ­Ø¯Ø§Øª Ø´Ø§ØºØ±Ø©</div><div><span class="badge gray">${vacant}</span></div>`;
        unitsBox.appendChild(liVac);
      }
      renderLists();

      document.getElementById('btnBack').onclick = ()=> Render.dashboard();
      document.getElementById('btnEditBuilding').onclick = ()=> Actions.openEditBuilding(b);
      document.getElementById('btnAddTenant').onclick = ()=> Actions.openAddTenant();
      document.getElementById('btnExpenses').onclick = ()=> Actions.openExpenses();

      const reportBtn = document.getElementById('btnReport');
      if (reportBtn) {
        reportBtn.onclick = null;
        reportBtn.removeAttribute('data-report');
        reportBtn.addEventListener('click', function (ev) {
          ev.preventDefault();
          ev.stopPropagation?.();
          try {
            openBuildingReport({
              name:     b.name || '',
              location: b.location || '',
              phone:    b.contact || '',
              owner:    b.owner || '',
              workType: b.bizType || '',
            });
          } catch (e) {
            console.error('openBuildingReport ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ©ØŸ', e);
            alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±. ØªØ£ÙƒØ¯ Ø£Ù† ÙƒØªÙ„Ø© "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ù†Ù‰" Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.');
          }
        });
      }
      document.getElementById('btnImportCSV').onclick = ()=> Actions.openImportCSV();
    },
  };

  function labelKind(kind){ return kind==='apartment'?'Ø´Ù‚Ø©':(kind==='shop'?'Ù…Ø­Ù„':(kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')); }

  const Actions = {
    openAddBuilding(){ openUpsertBuildingModal('add'); },
    openEditBuilding(existing){ openUpsertBuildingModal('edit', existing); },
    async openAddTenant(){
      const bDoc = await firebase.firestore().collection('buildings').doc(State.activeBuildingId).get();
      const isOA2 = (bDoc.data()||{}).bizType === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';
      UI.openModal('Ø¥Ø¶Ø§ÙØ© ' + (isOA2?'Ù…Ø§Ù„Ùƒ':'Ù…Ø³ØªØ£Ø¬Ø±'), `
        <div class="grid cols-2">
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <select id="tKind">
              <option value="apartment">Ø´Ù‚Ø©</option>
              <option value="shop">Ù…Ø­Ù„</option>
              <option value="showroom">Ù…Ø¹Ø±Ø¶</option>
              <option value="basement">Ù‚Ø¨Ùˆ</option>
            </select>
          </div>
          <div><label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©/Ø§Ù„Ù…Ø­Ù„</label><input id="tUnit" placeholder="Ù…Ø«Ø§Ù„: 203"></div>
          <div><label>${isOA2?'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'}</label><input id="tName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø¯ÙŠ"></div>
          <div><label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)</label><input id="tRent" type="number" step="0.001" placeholder="Ù…Ø«Ø§Ù„: 180"></div>
          <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="tPhone" type="tel" placeholder="9xxxxxxx"></div>
          <div><label>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label><input id="tNatId" inputmode="numeric" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</label><input id="tStart" type="date" value="${todayIso()}"></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input id="tEnd" type="date" value="${todayIso()}"></div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
            <select id="tPaymentType">
              <option value="advance">Ù…Ù‚Ø¯Ù…Ø§Ù‹</option>
              <option value="delayed">Ù…Ø¤Ø®Ø±Ø§Ù‹</option>
            </select>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <label style="margin:0">ÙØªØ±Ø© Ø³Ù…Ø§Ø­ØŸ</label>
            <input id="tGraceEnabled" type="checkbox" />
          </div>
          <div>
            <label>Ù…Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø­ (Ø£Ø´Ù‡Ø±)</label>
            <input id="tGraceMonths" type="number" min="0" step="1" value="0">
          </div>
          <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="tNotes" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea></div>
        </div>
        <div class="buttons-row">
          <button type="button" class="btn primary" id="tSave">Ø­ÙØ¸</button>
        </div>
      `);
      document.getElementById('tSave').onclick = async ()=>{
        const payload = {
          kind: document.getElementById('tKind').value,
          unitNumber: document.getElementById('tUnit').value.trim(),
          tenantName: document.getElementById('tName').value.trim(),
          rent: Number(document.getElementById('tRent').value||0),
          phone: document.getElementById('tPhone').value.trim(),
          nationalId: document.getElementById('tNatId').value.trim(),
          startDate: document.getElementById('tStart').value,
          endDate: document.getElementById('tEnd').value,
          paymentType: document.getElementById('tPaymentType').value,
          graceEnabled: document.getElementById('tGraceEnabled').checked,
          graceMonths: Number(document.getElementById('tGraceMonths').value||0),
          notes: document.getElementById('tNotes').value.trim(),
          payments: {}
        };
        if(!payload.tenantName){ UI.toast(isOA2?'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'); return; }
        await FB.addTenant(State.activeBuildingId, payload);
        UI.closeModal();
        App.Render.building();
      };
    },
    async openExpenses(){
      const bid = State.activeBuildingId;
      const draw = async ()=>{
        const exps = await FB.listExpenses(bid);
        UI.openModal('Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', `
          <div class="grid cols-2">
            <div><label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label><input id="exType"></div>
            <div><label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</label><input id="exAmount" type="number" step="0.001"></div>
            <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="exDate" type="date" value="${todayIso()}"></div>
            <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="exNotes" rows="2"></textarea></div>
          </div>
          <div class="buttons-row">
            <button type="button" class="btn primary" id="exAdd">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
          <div style="margin-top:12px">
            <table>
              <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="exRows">
                ${exps.map(e=>`
                  <tr data-id="${e.id}">
                    <td>${e.type||''}</td>
                    <td>${Number(e.amount||0).toFixed(3)}</td>
                    <td>${e.date||''}</td>
                    <td>${e.notes||''}</td>
                    <td style="white-space:nowrap">
                      <button class="btn" data-edit>ØªØ¹Ø¯ÙŠÙ„</button>
                      <button class="btn danger" data-del>Ø­Ø°Ù</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `);
        document.getElementById('exAdd').onclick = async ()=>{
          const payload = {
            type: document.getElementById('exType').value.trim(),
            amount: Number(document.getElementById('exAmount').value||0),
            date: document.getElementById('exDate').value,
            notes: document.getElementById('exNotes').value.trim()
          };
          if(!payload.type){ UI.toast('Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ'); return; }
          await FB.addExpense(bid, payload);
          draw();
        };
        document.getElementById('exRows').onclick = async (e)=>{
          const row = e.target.closest('tr[data-id]'); if(!row) return;
          const id = row.getAttribute('data-id');
          if(e.target.matches('[data-del]')){
            if(UI.confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')){ await FB.deleteExpense(bid, id); draw(); }
          }else if(e.target.matches('[data-edit]')){
            const doc = await firebase.firestore().collection('buildings').doc(bid).collection('expenses').doc(id).get();
            const ex = {id: doc.id, ...(doc.data()||{})};
            UI.openModal('ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ', `
              <div class="grid cols-2">
                <div><label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label><input id="edType" value="${ex.type||''}"></div>
                <div><label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</label><input id="edAmount" type="number" step="0.001" value="${Number(ex.amount||0)}"></div>
                <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="edDate" type="date" value="${(ex.date||'').slice(0,10)}"></div>
                <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="edNotes" rows="2">${ex.notes||''}</textarea></div>
              </div>
              <div class="buttons-row">
                <button type="button" class="btn primary" id="edSave">Ø­ÙØ¸</button>
              </div>
            `);
            document.getElementById('edSave').onclick = async ()=>{
              const patch = {
                type: document.getElementById('edType').value.trim(),
                amount: Number(document.getElementById('edAmount').value||0),
                date: document.getElementById('edDate').value,
                notes: document.getElementById('edNotes').value.trim()
              };
              await FB.updateExpense(bid, id, patch);
              Actions.openExpenses();
            };
          }
        };
      };
      await draw();
    },
    renderReport(){ UI.toast('Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†.'); },
    openImportCSV(){ UI.toast('Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†.'); }
  };

  function openUpsertBuildingModal(mode, existing){
    const isEdit = mode === 'edit';
    const b = existing || {};
    const counts = b.counts || {apartments:0,shops:0,showrooms:0,basements:0};
    const bizType = b.bizType || 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ';
    const feeType = b.feeType || 'percentage';
    const feeValue = (b.feeValue!=null ? b.feeValue : '');
    const electricAccount = b.electricAccount || '';
    const internetNumber = b.internetNumber || '';
    const guardPhone = b.guardPhone || '';
    const sewageTruckPhone = b.sewageTruckPhone || '';

    UI.openModal(isEdit? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù†Ù‰', `
      <div class="grid cols-2">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</label>
          <select id="mbBizType">
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ" ${bizType==='Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ'?'selected':''}>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ</option>
            <option value="Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ" ${bizType==='Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ'?'selected':''}>Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ</option>
          </select>
        </div>
        <div>
          <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø¬Ø±Ø©</label>
          <select id="mbFeeType">
            <option value="percentage" ${feeType==='percentage'?'selected':''}>Ù†Ø³Ø¨Ø©</option>
            <option value="salary" ${feeType==='salary'?'selected':''}>Ø±Ø§ØªØ¨</option>
          </select>
        </div>
        <div style="grid-column:1/-1">
          <label id="mbFeeLabel">${feeType==='salary'?'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)':'Ø§Ù„Ù†Ø³Ø¨Ø© (%)'}</label>
          <input id="mbFeeValue" type="number" inputmode="decimal" step="0.01" value="${feeValue}" placeholder="${feeType==='salary'?'Ù…Ø«Ø§Ù„: 150 (Ø±.Ø¹)':'Ù…Ø«Ø§Ù„: 15 (Ùª)'}">
        </div>
        <div style="grid-column:1/-1"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input id="mbName" value="${b.name||''}" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø³ÙŠÙØ©"></div>
        <div><label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><input id="mbLocation" value="${b.location||''}" placeholder="Ù…Ø«Ø§Ù„: ÙˆÙ„Ø§ÙŠØ© ØµÙˆØ± - Ø§Ù„Ø³ÙŠÙØ©"></div>
        <div><label>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</label><input id="mbContact" inputmode="tel" value="${b.contact||''}" placeholder="9xxxxxxx"></div>
        <div style="grid-column:1/-1"><label>Ø§Ù„Ù…Ø§Ù„Ùƒ</label><input id="mbOwner" value="${b.owner||''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ"></div>
        <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="mbNotes" rows="2" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©">${b.notes||''}</textarea></div>

        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚</label><input id="mbApt" type="number" min="0" value="${Number(counts.apartments||0)}"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª</label><input id="mbShop" type="number" min="0" value="${Number(counts.shops||0)}"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶</label><input id="mbShow" type="number" min="0" value="${Number(counts.showrooms||0)}"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø¨Ùˆ</label><input id="mbBase" type="number" min="0" value="${Number(counts.basements||0)}"></div>

        <div><label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</label><input id="mbElectric" value="${electricAccount}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"></div>
        <div><label>Ø±Ù‚Ù… Ø§Ù†ØªØ±Ù†Øª Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</label><input id="mbInternet" value="${internetNumber}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ/Ø§Ù„Ø­Ø³Ø§Ø¨"></div>
        <div><label>Ø±Ù‚Ù… Ø­Ø§Ø±Ø³ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</label><input id="mbGuard" value="${guardPhone}" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø­Ø§Ø±Ø³"></div>
        <div><label>Ø±Ù‚Ù… Ø³Ø§Ø¦Ù‚ Ù†Ø§Ù‚Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ</label><input id="mbSewage" value="${sewageTruckPhone}" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚"></div>
      </div>
      <div class="buttons-row">
        <button type="button" class="btn primary" id="saveB">${isEdit?'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':'Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù†Ù‰'}</button>
      </div>
    `);

    // Bank field for Owners Association
    (function(){
      const sel = document.getElementById('mbBizType');
      if(!sel) return;
      const grid = sel.closest('.grid') || sel.closest('[style*="grid"]') || (document.querySelector('.grid.cols-2'));
      let holder = document.getElementById('oaBankHolder');
      if(!holder){
        holder = document.createElement('div');
        holder.id = 'oaBankHolder';
        holder.style.gridColumn = '1 / -1';
        holder.innerHTML = '<label id="oaBankWrap" style="display:none">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ù„Ù„Ø¬Ù…Ø¹ÙŠØ©'
          + '<input id="oaBank" value="'+(b.oaBank||'')+'" placeholder="Ù…Ø«Ø§Ù„: OMxx xxxx xxxx xxxx" style="width:100%"></label>';
        (grid||document.body).appendChild(holder);
      }
      function apply(){
        const isOA = ((sel.value||'') === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
        const label = document.getElementById('oaBankWrap');
        if (label) label.style.display = isOA ? 'block' : 'none';
        if (!isOA) {
          const inp = document.getElementById('oaBank');
          if (inp) inp.value = '';
        }
      }
      sel.addEventListener('change', apply);
      apply();
    })();

    const feeSel = document.getElementById('mbFeeType');
    if(feeSel){
      feeSel.onchange = function(){
        const isSalary = this.value==='salary';
        document.getElementById('mbFeeLabel').textContent = isSalary ? 'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)' : 'Ø§Ù„Ù†Ø³Ø¨Ø© (%)';
        const iv = document.getElementById('mbFeeValue');
        if(iv){ iv.placeholder = isSalary ? 'Ù…Ø«Ø§Ù„: 150 (Ø±.Ø¹)' : 'Ù…Ø«Ø§Ù„: 15 (Ùª)'; }
      };
    }

    document.getElementById('saveB').onclick = async ()=>{
      const payload = {
        bizType: document.getElementById('mbBizType').value,
        feeType: document.getElementById('mbFeeType').value,
        feeValue: Number(document.getElementById('mbFeeValue').value||0),
        name: (document.getElementById('mbName').value||'').trim(),
        location: (document.getElementById('mbLocation').value||'').trim(),
        contact: (document.getElementById('mbContact').value||'').trim(),
        owner: (document.getElementById('mbOwner').value||'').trim(),
        notes: (document.getElementById('mbNotes').value||'').trim(),
        counts: {
          apartments: Number(document.getElementById('mbApt').value||0),
          shops: Number(document.getElementById('mbShop').value||0),
          showrooms: Number(document.getElementById('mbShow').value||0),
          basements: Number(document.getElementById('mbBase').value||0),
        },
        electricAccount: (document.getElementById('mbElectric').value||'').trim(),
        internetNumber: (document.getElementById('mbInternet').value||'').trim(),
        guardPhone: (document.getElementById('mbGuard').value||'').trim(),
        sewageTruckPhone: (document.getElementById('mbSewage').value||'').trim(),
        oaBank: (document.getElementById('oaBank')?.value||'').trim(),
      };

      if(!payload.name){ UI.toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰'); return; }

      if(isEdit){
        const id = (b && b.id) || State.activeBuildingId;
        await FB.updateBuilding(id, payload);
      }else{
        await FB.createBuilding(Object.assign({createdAt: new Date().toISOString()}, payload));
      }
      UI.closeModal();
      Render.dashboard();
      if(State.activeBuildingId) Render.building();
    };
  }

  function bindHeader(){ document.getElementById('btnAddBuilding').onclick = ()=> Actions.openAddBuilding(); }

  return { State, FB, UI, Render, Actions, utils:{ $, $$, todayIso, ymKey } };
})();

function labelKind(kind){ return kind==='apartment'?'Ø´Ù‚Ø©':(kind==='shop'?'Ù…Ø­Ù„':(kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')); }

(function init(){
  document.getElementById('btnAddBuilding').onclick = ()=> App.Actions.openAddBuilding();
  App.Render.populateYM();
  App.Render.dashboard();
})();


</script>

<!-- ========================= Ø¥ØµØ¯Ø§Ø± Ø¹Ù‚Ø¯ (ØªÙ„Ù‚Ø§Ø¦ÙŠ + Ø·Ø¨Ø§Ø¹Ø©) ========================= -->
<script>
(function(){
  const LOGO_URL  = "https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png";
  const STAMP_URL = "https://i.ibb.co/VWRwKDXy/signature.png";

  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯
  window.openContract = function openContract(t){
    // Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ Ù…Ù† Ø§Ù„Ø²Ø±/Ø§Ù„Ø³Ø·Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù…Ø§ ÙˆØµÙ„ØªÙ†Ø§ Ù‚ÙŠÙ…
    function autoFromDOM(){
      try{
        const btn = document.activeElement?.closest?.('[data-contract]');
        const row = btn?.closest?.('[data-tenant-row], .tenant-row');
        const read = sel => row?.querySelector(sel)?.textContent.trim();
        return {
          tenantName : btn?.dataset.tenantName || read('[data-tenant-name]') || '',
          unitNumber : btn?.dataset.unit       || read('[data-unit]')        || '',
          rent       : parseFloat(btn?.dataset.rent || (read('[data-rent]')||'').replace(/[^\d.]/g,'')) || 0,
          kind       : btn?.dataset.kind       || row?.getAttribute('data-kind') || '',
          phone      : btn?.dataset.phone      || read('[data-phone]') || '',
          idNumber   : btn?.dataset.id         || read('[data-id]')    || '',
          payDate    : btn?.dataset.paydate    || ''
        };
      }catch{ return {}; }
    }
    t = Object.assign(autoFromDOM(), t||{});

    const buildingName = (document.getElementById('buildingTitle')?.textContent || '').trim();
    const today  = new Date().toISOString().slice(0,10);
    const startD = today;
    const endD   = new Date(new Date().setFullYear(new Date().getFullYear()+1)).toISOString().slice(0,10);
    const payD   = t.payDate || today;
    const rentOMR= Number(t.rent||0).toFixed(3);

    // Ø§ØºÙ„ÙÙ‚ Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù‚Ø¯ÙŠÙ…Ø©
    document.getElementById('ctOverlay')?.remove();

    // Ø§Ù„ØºØ·Ø§Ø¡ + Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
    const overlay = document.createElement('div');
    overlay.id = 'ctOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:#0006;display:flex;align-items:center;justify-content:center;z-index:9999';
    document.body.appendChild(overlay);

    const box = document.createElement('div');
    box.style.cssText = 'direction:rtl;background:#fff;width:min(980px,96%);border-radius:16px;overflow:hidden;font-family:Tajawal,system-ui,sans-serif;color:#111';
    box.innerHTML = `
      <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:#f8fafc">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div>
            <div style="font-weight:800;font-size:22px">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</div>
            <div style="color:#6b7280">Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</div>
          </div>
          <img src="${LOGO_URL}" alt="" style="height:48px" onerror="this.style.display='none'">
        </div>
      </div>

      <div style="padding:22px 20px">
        <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <label>ØªØ§Ø±ÙŠØ® ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø¯<input id="ctDate" type="date" value="${today}" style="width:100%"></label>
          <label>Ø§Ù„ÙˆØ­Ø¯Ø©<input id="ctUnit" value="${(t.unitNumber||'')}" style="width:100%"></label>

          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±<input id="ctTenant" value="${(t.tenantName||'')}" style="width:100%"></label>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©<input id="ctId" value="${(t.idNumber||'')}" style="width:100%"></label>

          <label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)<input id="ctRent" type="number" step="0.001" value="${rentOMR}" style="width:100%"></label>
          <label>ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±<input id="ctPayDate" type="date" value="${payD}" style="width:100%"></label>

          <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯<input id="ctStart" type="date" value="${startD}" style="width:100%"></label>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡<input id="ctEnd" type="date" value="${endD}" style="width:100%"></label>

          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ<input id="ctPhone" value="${(t.phone||'')}" style="width:100%"></label>
          <label>Ù…Ù‚Ø± Ø§Ù„Ø¹Ù…Ù„<input id="ctWork" value="Ù…Ø³Ù‚Ø·" style="width:100%"></label>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
          <button id="ctPrint" class="btn" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù‚Ø¯</button>
          <button id="ctClose" class="btn" style="background:#f3f4f6;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    `;
    overlay.appendChild(box);

    box.querySelector('#ctClose').onclick = ()=> overlay.remove();

    box.querySelector('#ctPrint').onclick = function(){
      const data = {
        logo: LOGO_URL,
        stamp: STAMP_URL,
        building: buildingName,
        date:   box.querySelector('#ctDate').value || today,
        unit:   box.querySelector('#ctUnit').value || t.unitNumber || '',
        tenant: box.querySelector('#ctTenant').value || t.tenantName || '',
        id:     box.querySelector('#ctId').value || '',
        rent:   Number(box.querySelector('#ctRent').value || t.rent || 0).toFixed(3),
        payday: box.querySelector('#ctPayDate').value || payD,
        start:  box.querySelector('#ctStart').value || startD,
        end:    box.querySelector('#ctEnd').value || endD,
        phone:  box.querySelector('#ctPhone').value || '',
        work:   box.querySelector('#ctWork').value || 'Ù…Ø³Ù‚Ø·',
      };

      const html = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8">
  <title>Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± - Lease Agreement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    @page { size: A4; margin: 10mm; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #fff; color: #111; }
    .contract {
      width: 100%;
      max-width: 170mm;
      margin: 0 auto;
      border: 1.5px solid #222;
      border-radius: 12px;
      padding: 10mm;
      font-family: "Tajawal","Segoe UI",Tahoma,Arial,sans-serif;
      line-height: 1.9;
    }
    .header { display: grid; grid-template-columns: 1fr 120px 1fr; align-items: start; gap: 10px; margin-bottom: 8mm; }
    .header .right { text-align: right; line-height: 1.6; font-size: 13.5px; direction: rtl; white-space: pre-line; font-weight: 700; }
    .header .left  { text-align: left;  line-height: 1.6; font-size: 13.5px; direction: ltr; white-space: pre-line; font-family: "Poppins","Segoe UI",Tahoma,Arial,sans-serif; font-weight: 600; }
    .header .logo  { display: flex; align-items: center; justify-content: center; height: 100%; }
    .header .logo img { max-width: 110px; max-height: 110px; object-fit: contain; }
    .title-wrap { text-align: center; margin-bottom: 8mm; }
    .title-frame {
      display: inline-block;
      border: 2px solid #111;
      border-radius: 12px;
      padding: 4mm 6mm;
      text-align: center;
    }
    .title-frame .ar { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: .2px; }
    .title-frame .en { font-size: 14px; font-weight: 700; margin: 0; letter-spacing: .2px; }
    .title-frame hr { border: none; border-top: 1px solid #111; margin: 2.5mm 0; }
    .meta { font-size: 13px; color: #444; margin-bottom: 6mm; display: grid; grid-template-columns: 1fr 1fr; gap: 6mm; }
    .meta b { color: #111; }
    .sec  { margin-top: 6mm; font-size: 14px; color: #111; }
    .clause{ margin: 8px 0; }
    .signs{ display:flex; gap:28px; margin-top: 16mm; }
    .sign { flex:1; border:1px dashed #cbd5e1; border-radius:12px; padding:12px; }
    .stamp{ height:70px; object-fit:contain; }
    @media print { body { padding: 0; } }
  </style>
</head>
<body>
  <div class="contract">
    <div class="header">
      <div class="right">
Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø©
Ø³.Øª: 1294875
Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†
Ù‡Ø§ØªÙ: 90929600
      </div>
      <div class="logo">
        <img src="${data.logo}" alt="Logo">
      </div>
      <div class="left">
Mashare'a Madinat AlEbda'a Almtamayeza
CR No.: 1294875
Sultanate of Oman
Tel: 90929600
      </div>
    </div>

    <div class="title-wrap">
      <div class="title-frame">
        <p class="ar">Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</p>
        <hr>
        <p class="en">Lease Agreement</p>
      </div>
    </div>

    <div class="meta">
      <div>Ø§Ù„Ù…Ø¨Ù†Ù‰: <b>${data.building || 'â€”'}</b></div>
      <div>Ø§Ù„ÙˆØ­Ø¯Ø©: <b>${data.unit || 'â€”'}</b></div>
      <div>ØªØ§Ø±ÙŠØ® ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø¯: <b>${data.date}</b></div>
      <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: <b>${data.end}</b></div>
    </div>

    <div class="sec">
      <div>Ø£Ø¨Ø±Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ØªØ§Ø±ÙŠØ®: <b>${data.date}</b></div>
      <div class="clause">Ø¨ÙŠÙ† ÙƒÙ„Ø§ Ù…Ù†:</div>
      <div>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø£ÙØ§Ø¶Ù„/ <b>Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø©</b></div>
      <div>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±): Ø§Ù„ÙØ§Ø¶Ù„ / <b>${data.tenant || '__________'}</b></div>
      <div>Ø¨Ø·Ø§Ù‚Ø© Ø´Ø®ØµÙŠØ© Ø±Ù‚Ù… / <b>${data.id || 'â€”'}</b></div>
      <div>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ / <b>${data.rent}</b> Ø±.Ø¹ &nbsp;&nbsp; ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: <b>${data.payday}</b></div>
      <div>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ØªØ§Ø±ÙŠØ®: <b>${data.start}</b> &nbsp;&nbsp; ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†ØªÙ‡Ø§Ø¡: <b>${data.end}</b></div>
      <div>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: <b>${data.phone || 'â€”'}</b> &nbsp;&nbsp; Ù…Ù‚Ø± Ø§Ù„Ø¹Ù…Ù„: <b>${data.work}</b></div>

      <div class="clause" style="margin-top:12px"><b>ØªÙ…Ù‡ÙŠØ¯</b></div>
      <div>
        Ø­ÙŠØ« Ø£Ù† Ø§Ù„ÙØ§Ø¶Ù„ (Ø§Ù„Ù…Ø§Ù„Ùƒ) Ù„Ù…Ø¨Ù†Ù‰ Ù‚Ø§Ù… Ø¨Ø§Ù„ØªØ¹Ø§Ù‚Ø¯ Ù…Ø¹ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© Ù„ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†Ù‡ ÙÙŠ Ø§Ù„Ù…Ø¨Ù†Ù‰. 
        ÙˆØ­ÙŠØ« Ø£Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ÙŠÙ† Ø§Ù„ÙØ§Ø¶Ù„ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© ÙŠØªØ¶Ù…Ù† Ø¨Ù†Ø¯Ø§Ù‹ ÙŠÙ„Ø²Ù… Ù…Ø¤Ø³Ø³Ø© Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© Ø¨ØªÙˆÙ‚ÙŠØ¹ Ø¹Ù‚ÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø¨Ù†Ù‰ØŒ
        ÙˆØ¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„ÙŠÙ‡ Ù‚Ø¯ Ø£Ø¨Ø±Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ† ÙˆØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠÙ„ÙŠ:
      </div>

      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø£ÙˆÙ„:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¯ÙØ¹ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ø§Ù‹ Ø±Ø¦ÙŠØ³ÙŠØ§Ù‹ Ù„Ø§ ØªØ£Ø®ÙŠØ± Ø£Ùˆ ØªØ£Ø¬ÙŠÙ„ ÙÙŠÙ‡ØŒ ÙÙŠ Ù…Ø­Ù„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¯ÙØ¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø± Ø¨Ù†Ø¸Ø§Ù… Ø´ÙŠÙƒØ§Øª ØªÙˆØ¯Ø¹ ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù„Ø«:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¯ÙØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø®Ù„Ø§Ù„ ÙØªØ±Ø© Ø£Ù‚ØµØ§Ù‡Ø§ 10 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø±Ø§Ø¨Ø¹:</b> ÙÙŠ Ø­Ø§Ù„Ø© Ø¥Ø®Ù„Ø§Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ ÙÙŠ Ø³Ø¯Ø§Ø¯ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠØŒ ÙŠØ­Ù‚ Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø¹Ù„Ù‰ Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø´Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ ÙØªØ±Ø© Ø£Ù‚ØµØ§Ù‡Ø§ 10 Ø£ÙŠØ§Ù….</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø®Ø§Ù…Ø³:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ØºØ¨Ø© ÙÙŠ ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙŠ ÙØªØ±Ø© Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 30 ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ³Ø®.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¯Ø³:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¥ØµØ¯Ø§Ø± Ø´ÙŠÙƒ Ø¶Ù…Ø§Ù† Ù…Ù‚Ø¯Ù…Ø§Ù‹ Ø¹Ù†Ø¯ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ‚Ø¯Ø±Ù‡ (<b>${data.rent}</b>) Ø±ÙŠØ§Ù„Ø§Ù‹ Ø¹Ù…Ø§Ù†ÙŠØ§Ù‹ Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ø£Ùˆ ÙØ³Ø®Ù‡ Ù…Ù† (Ø·Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†ØŒ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ©ØŒ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ø®Ø´Ø¨ÙŠØ© ÙˆØ§Ù„Ø£Ù„Ù…Ù†ÙŠÙˆÙ… Ø£Ùˆ Ø£ÙŠ ØªÙ„Ù Ø¬Ø³ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‚Ø©). ÙˆÙÙŠ Ø­Ø§Ù„Ø© Ø£Ù† Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØªØ­Ù…Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø´ÙŠÙƒ Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¨Ø¹:</b> ÙŠØ­Ù‚ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ÙÙŠ Ø­Ø§Ù„Ø© ØªØ¹Ø¯ÙŠ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¨Ù†Ù‰ Ø£Ùˆ Ø¥Ø³Ø§Ø¡Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù…Ù†:</b> ÙŠØ¨Ù‚Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ Ø·Ø§Ù„Ù…Ø§ Ø¨Ù‚ÙŠ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠÙ† Ø§Ù„ÙØ§Ø¶Ù„ (Ø§Ù„Ù…Ø§Ù„Ùƒ) ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ØŒ ÙˆÙÙŠ Ø­Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø°Ù„Ùƒ ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø°Ù„Ùƒ ÙˆØ¨ØªØ§Ø±ÙŠØ® ØªÙˆÙ‚ÙÙ‡ Ø¹Ù† ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù‚Ø¨Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ØªØ§Ø³Ø¹:</b> ÙÙŠ Ø­Ø§Ù„Ø© Ù†Ø´ÙˆØ¡ Ø£ÙŠ Ø®Ù„Ø§Ù Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ† Ù†Ø§ØªØ¬ Ø£Ùˆ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ„Ù… ÙŠØªÙ… Ø­Ù„Ù‡ ÙˆØ¯ÙŠØ§Ù‹ ÙÙŠÙ…ÙƒÙ† Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ù„Ø§Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§ÙƒÙ… Ø§Ù„Ù…Ø®ØªØµØ© ÙÙŠ Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† Ù„Ù„ÙØµÙ„ ÙÙŠÙ‡.</div>

      <div class="signs">
        <div class="sign">
          <div><b>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„:</b></div>
          <div>Ø§Ù„Ø£ÙØ§Ø¶Ù„ / Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø©</div>
          <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: Ø³Ø¹ÙˆØ¯ Ø¨Ù† Ø¬Ù…Ø§Ù„ Ø¨Ù† Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø¹ÙˆÙ„ÙŠ</div>
          <div style="margin-top:8px">Ø§Ù„Ø®ØªÙ…:</div>
          <img src="${data.stamp}" class="stamp" onerror="this.style.display='none'">
        </div>
        <div class="sign">
          <div><b>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ:</b></div>
          <div>Ø§Ù„ÙØ§Ø¶Ù„: ${data.tenant || '__________'}</div>
          <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: __________________</div>
        </div>
      </div>
    </div>
  </div>

  <div class="noprint" style="text-align:center;margin:16px 0">
    <button onclick="window.print()" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</body>
</html>`;

      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      setTimeout(()=>w.print(), 120);
      overlay.remove();
    };
  };

  // ØªÙÙˆÙŠØ¶ Ø¹Ø§Ù… Ù„Ø²Ø± [data-contract]
  document.addEventListener('click', function(ev){
    const b = ev.target.closest?.('[data-contract]');
    if(!b) return;
    ev.stopPropagation();
    ev.stopImmediatePropagation?.();
    openContract({
      tenantName: b.dataset.tenantName || '',
      unitNumber: b.dataset.unit || '',
      rent: parseFloat(b.dataset.rent||'0') || 0,
      kind: b.dataset.kind || '',
      phone: b.dataset.phone || '',
      idNumber: b.dataset.id || '',
      payDate: b.dataset.paydate || ''
    });
  }, {capture:true});
})();
</script>

function tableHTML(title, unitHeader, list){
  if (!list.length) return "";
  return `
    <h2 class="sec-title">${H(title)}</h2>
    <div class="table-wrap">
      <table>
        <colgroup>
          <col style="width:11%">
          <col style="width:17%">
          <col style="width:17%"> <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£ÙƒØ¨Ø± -->
          <col style="width:8%">
          <col style="width:10%"> <!-- Ø§Ù„Ù‡Ø§ØªÙ Ø£ØµØºØ± -->
          <col style="width:11%">
          <col style="width:11%">
          <col style="width:15%"> <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø¶ÙŠÙ‚ -->
        </colgroup>
        <thead>
          <tr>
            <th>${H(unitHeader)}</th>
            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
            <th>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</th>
            <th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
            <th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹</th>
          </tr>
        </thead>
        <tbody>
          ${list.map(r=>`
            <tr>
              <td class="split2 big-unit">${splitTwoLines(r.unit)}</td>
              <td class="wrap">${H(r.tenant)}</td>
              <td class="big-id nowrap">${H(r.id)}</td>
              <td>${formatOMR(r.rent)}</td>
              <td class="wrap phone-xs">${H(r.phone)}</td>
              <td>${H(r.start)}</td>
              <td>${H(r.end)}</td>
              <td class="wrap small-notes">${H(r.notes)}</td>
            </tr>`).join("")}
        </tbody>
      </table>
    </div>`;
}
<!-- ========================= Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„ (Ø³Ù†Ø¯ Ù‚Ø¨Ø¶) â€” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ========================= -->
<script>
(function(){
  const LOGO_URL  = "https://i.ibb.co/C3rc2mkL/file-00000000637c62308240e62f076360cc.png";
  const STAMP_URL = "https://i.ibb.co/VWRwKDXy/signature.png";

  // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø­Ø±ÙˆÙ (Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ) â€” Ù„Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­Ø©
  function amountWordsAR(n){
    n = Math.floor(Math.abs(Number(n)||0));
    if(n===0) return 'ØµÙØ±';
    const ones = ['','ÙˆØ§Ø­Ø¯','Ø§Ø«Ù†Ø§Ù†','Ø«Ù„Ø§Ø«Ø©','Ø£Ø±Ø¨Ø¹Ø©','Ø®Ù…Ø³Ø©','Ø³ØªØ©','Ø³Ø¨Ø¹Ø©','Ø«Ù…Ø§Ù†ÙŠØ©','ØªØ³Ø¹Ø©'];
    const teens = ['Ø¹Ø´Ø±Ø©','Ø£Ø­Ø¯ Ø¹Ø´Ø±','Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±','Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±','Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±','Ø®Ù…Ø³Ø© Ø¹Ø´Ø±','Ø³ØªØ© Ø¹Ø´Ø±','Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±','Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±','ØªØ³Ø¹Ø© Ø¹Ø´Ø±'];
    const tens = ['','Ø¹Ø´Ø±Ø©','Ø¹Ø´Ø±ÙˆÙ†','Ø«Ù„Ø§Ø«ÙˆÙ†','Ø£Ø±Ø¨Ø¹ÙˆÙ†','Ø®Ù…Ø³ÙˆÙ†','Ø³ØªÙˆÙ†','Ø³Ø¨Ø¹ÙˆÙ†','Ø«Ù…Ø§Ù†ÙˆÙ†','ØªØ³Ø¹ÙˆÙ†'];
    const hundreds = ['','Ù…Ø§Ø¦Ø©','Ù…Ø§Ø¦ØªØ§Ù†','Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©','Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©','Ø®Ù…Ø³Ù…Ø§Ø¦Ø©','Ø³ØªÙ…Ø§Ø¦Ø©','Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©','Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©','ØªØ³Ø¹Ù…Ø§Ø¦Ø©'];
    function underThousand(x){
      let s = '', h = Math.floor(x/100), t = Math.floor((x%100)/10), o = x%10;
      if(h) s += hundreds[h];
      if(t>1){
        if(s) s+=' Ùˆ ';
        s += (o ? (ones[o] + ' Ùˆ ' + tens[t]) : tens[t]);
      } else if(t===1){
        if(s) s+=' Ùˆ ';
        s += teens[o];
      } else if(o){
        if(s) s+=' Ùˆ ';
        s += (o===1?'ÙˆØ§Ø­Ø¯':o===2?'Ø§Ø«Ù†Ø§Ù†':ones[o]);
      }
      return s;
    }
    const thousands = Math.floor(n/1000), rest = n%1000;
    let res = '';
    if(thousands){
      if(thousands===1) res = 'Ø£Ù„Ù';
      else if(thousands===2) res = 'Ø£Ù„ÙØ§Ù†';
      else if(thousands>=3 && thousands<=10) res = underThousand(thousands) + ' Ø¢Ù„Ø§Ù';
      else res = underThousand(thousands) + ' Ø£Ù„Ù';
    }
    if(rest){
      if(res) res += ' Ùˆ ';
      res += underThousand(rest);
    }
    return res;
  }

  function genRcNo(){
    const d = new Date();
    const YY = String(d.getFullYear()).slice(-2);
    const MM = String(d.getMonth()+1).padStart(2,'0');
    const DD = String(d.getDate()).padStart(2,'0');
    const rnd = Math.floor(1000 + Math.random()*9000);
    return YY+MM+DD+String(rnd);
  }

  // ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø«Ù… ÙŠØ·Ø¨Ø¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„
  window.openReceipt = function openReceipt(t){
    t = t || {};
    // Ù‚Ø±Ø§Ø¡Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù† Ø§Ù„ØµÙ/Ø§Ù„Ø²Ø± Ù„Ùˆ Ø§Ø³ØªØ¯Ø¹ÙŠÙ†Ø§ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    function autoFromDOM(){
      try{
        const btn = document.activeElement?.closest?.('[data-receipt]');
        const row = btn?.closest?.('[data-tenant-row], .tenant-row');
        const read = sel => row?.querySelector(sel)?.textContent.trim();
        return {
          tenantName : btn?.dataset.tenantName || read?.('[data-tenant-name]') || '',
          unitNumber : btn?.dataset.unit       || read?.('[data-unit]')        || '',
          rent       : parseFloat(btn?.dataset.rent || (read?.('[data-rent]')||'').replace(/[^\d.]/g,'')) || 0,
          kind       : btn?.dataset.kind       || row?.getAttribute('data-kind') || '',
          phone      : btn?.dataset.phone      || read?.('[data-phone]') || '',
          idNumber   : btn?.dataset.id         || read?.('[data-id]')    || '',
          payDate    : btn?.dataset.paydate    || ''
        };
      }catch{ return {}; }
    }
    t = Object.assign(autoFromDOM(), t || {});

    const buildingName = (document.getElementById('buildingTitle')?.textContent || '').trim();
    const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const payer = (t.tenantName || '').trim();
    const unit  = (t.tenantUnit || t.unitNumber || '').toString();
    const kind  = (typeof window.labelKind==='function' ? labelKind(t.kind) : (t.kind||''));
    const amountNum = Number(t.rent || t.amount || 0);
    const amount = amountNum.toFixed(3);
    const noteDefault = (kind ? (kind + ' ') : '') + (unit ? ('Ø±Ù‚Ù… ' + unit) : '');

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù‚Ø¯ÙŠÙ…Ø©
    document.getElementById('rcOverlay')?.remove();

    // Ø§Ù„Ù€ Overlay + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const overlay = document.createElement('div');
    overlay.id = 'rcOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:#0006;display:flex;align-items:center;justify-content:center;z-index:9999';
    document.body.appendChild(overlay);

    const box = document.createElement('div');
    box.style.cssText = 'direction:rtl;background:#fff;width:min(920px,96%);border-radius:16px;overflow:hidden;font-family:Tajawal,system-ui,sans-serif;color:#111';
    box.innerHTML = `
      <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:#f8fafc">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div>
            <div style="font-weight:800;font-size:22px">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</div>
            <div style="color:#6b7280">(Receipt Voucher) Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</div>
          </div>
          <img src="${LOGO_URL}" alt="" style="height:48px" onerror="this.style.display='none'">
        </div>
        <div style="display:flex;gap:24px;margin-top:14px;font-weight:600">
          <div>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯: <input id="rcNo" style="border:0;border-bottom:1px solid #cbd5e1;outline:0;padding:0 4px;width:140px" value="${genRcNo()}"></div>
          <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <input id="rcDate" type="date" style="border:0;border-bottom:1px solid #cbd5e1;outline:0;padding:0 4px" value="${today}"></div>
        </div>
      </div>

      <div style="padding:22px 20px">
        <div style="display:grid;grid-template-columns:220px 1fr;row-gap:16px;column-gap:14px;align-items:center">
          <div style="color:#6b7280">Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„ÙØ§Ø¶Ù„:</div>
          <div><input id="rcPayer" value="${payer}" style="width:100%;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</div>
          <div><input id="rcAmountWords" value="${amountWordsAR(amountNum)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ" style="width:100%;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">(Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)</div>
          <div>Ø±Ø¹ <input id="rcAmount" type="number" step="0.001" value="${amount}" style="width:200px;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</div>
          <div style="border:1px solid #cbd5e1;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:14px">
            <label><input type="radio" name="rcPayMethod" value="cash" checked> Ù†Ù‚Ø¯Ù‹Ø§</label>
            <label><input type="radio" name="rcPayMethod" value="cheque"> Ø´ÙŠÙƒ Ø±Ù‚Ù…</label>
            <label><input type="radio" name="rcPayMethod" value="transfer"> ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ Ø±Ù‚Ù…</label>
            <span id="rcPayNumWrap" style="display:none;margin-inline-start:10px;display:inline-flex;align-items:center;gap:8px">
              <input id="rcPayNum" placeholder="â€”" style="width:220px;border:1px solid #cbd5e1;border-radius:10px;padding:6px 10px">
            </span>
          </div>

          <div style="color:#6b7280">Ø¨ØªØ§Ø±ÙŠØ®:</div>
          <div><input id="rcPaidOn" type="date" value="${today}" style="border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">ÙˆØ°Ù„Ùƒ Ø¹Ù†:</div>
          <div><input id="rcFor" value="${(kind||'Ø¥ÙŠØ¬Ø§Ø±')} ${noteDefault}" style="width:100%;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;margin-top:26px">
          <div style="border-top:1px solid #e5e7eb;width:52%"></div>
        </div>
        <div style="text-align:left;font-weight:700;margin-top:10px">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
      </div>

      <div style="padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-start">
        <button id="rcPrint" class="btn" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="rcClose" class="btn" style="margin-inline-start:10px;background:#f3f4f6;color:#111;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    `;
    overlay.appendChild(box);

    function updatePayUI(){
      const method = box.querySelector('input[name=rcPayMethod]:checked')?.value;
      const wrap = box.querySelector('#rcPayNumWrap');
      const inp  = box.querySelector('#rcPayNum');
      if(method==='cash'){ wrap.style.display='none'; if(inp) inp.value=''; }
      else {
        wrap.style.display='inline-flex';
        if(inp) inp.placeholder = (method==='cheque'?'Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ':'Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ');
      }
    }
    box.querySelectorAll('input[name=rcPayMethod]').forEach(el => el.addEventListener('change', updatePayUI));
    updatePayUI();

    box.querySelector('#rcClose').onclick = () => overlay.remove();
    box.querySelector('#rcAmount').addEventListener('input', e=>{
      box.querySelector('#rcAmountWords').value = amountWordsAR(e.target.value) + ' Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ';
    });

    // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    box.querySelector('#rcPrint').onclick = function(){
      const data = {
        building  : buildingName,
        rcNo      : box.querySelector('#rcNo').value || genRcNo(),
        dateHeader: box.querySelector('#rcDate').value || today,
        payer     : box.querySelector('#rcPayer').value || '',
        amount    : Number(box.querySelector('#rcAmount').value || 0).toFixed(3),
        amountWords: (box.querySelector('#rcAmountWords').value || '').trim(),
        payMethod : box.querySelector('input[name=rcPayMethod]:checked')?.value || 'cash',
        payNum    : box.querySelector('#rcPayNum')?.value || '',
        paidOn    : box.querySelector('#rcPaidOn').value || today,
        theFor    : box.querySelector('#rcFor').value || '',
        unit      : unit,
        kindLabel : kind
      };

      const payRow = (data.payMethod==='cash') ? '' : `
        <tr><th>${data.payMethod==='cheque'?'Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ':'Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ'}</th><td>${data.payNum || 'â€”'}</td></tr>
      `;

      const html = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8">
<title>Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ - Receipt Voucher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">

<style>
  @page { size: A4; margin: 10mm; }
  * { box-sizing: border-box; }
  body { margin: 0; padding: 0; background: #fff; color: #111; }
  .receipt {
    width: 100%;
    max-width: 170mm;
    margin: 0 auto;
    border: 1.5px solid #222;
    border-radius: 12px;
    padding: 10mm;
    font-family: "Tajawal","Segoe UI",Tahoma,Arial,sans-serif;
    line-height: 1.8;
  }
  .header { display: grid; grid-template-columns: 1fr 120px 1fr; align-items: start; gap: 10px; margin-bottom: 8mm; }
  .header .right{ text-align:right; line-height:1.6; font-size:13.5px; direction:rtl; white-space:pre-line; font-weight:700 }
  .header .left { text-align:left;  line-height:1.6; font-size:13.5px; direction:ltr; white-space:pre-line; font-family:"Poppins","Segoe UI",Tahoma,Arial,sans-serif; font-weight:600 }
  .header .logo{ display:flex;align-items:center;justify-content:center; height:100% }
  .header .logo img{ max-width:110px; max-height:110px; object-fit:contain }
  .title-wrap { text-align:center; margin-bottom: 8mm; }
  .title-frame {
    display:inline-block; border:2px solid #111; border-radius:12px;
    padding:4mm 6mm; text-align:center;
  }
  .title-frame .ar { font-size:22px; font-weight:800; margin:0; letter-spacing:.2px }
  .title-frame .en { font-size:14px; font-weight:700; margin:0; letter-spacing:.2px }
  .title-frame hr { border:none; border-top:1px solid #111; margin:2.5mm 0 }
  .meta { font-size:13px; color:#444; margin-bottom:6mm; display:grid; grid-template-columns:1fr 1fr; gap:6mm }
  .meta div b { color:#111 }
  table{ width:100%; border-collapse:collapse }
  th,td{ border:1px solid #000; padding:8px; font-size:13.5px; text-align:right }
  th{ white-space:nowrap }
  .sign{ margin-top:14mm; display:flex; flex-direction:column; align-items:center; gap:14mm }
  .sig-block{ display:flex; flex-direction:column; align-items:center }
  .sig-block .label{ font-weight:800; margin-bottom:6px }
  .sig-block img{ height:70px; width:auto; object-fit:contain }
  .sig-block .line{ border-top:1px solid #111; width:60%; height:0; margin-top:8mm }
  @media print{ body{ padding:0 } }
</style>
</head>
<body>
  <div class="receipt">
    <div class="header">
      <div class="right">
Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø©
Ø³.Øª: 1294875
Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†
Ù‡Ø§ØªÙ: 90929600
      </div>
      <div class="logo"><img src="${LOGO_URL}" alt="Logo"></div>
      <div class="left">
Mashare'a Madinat AlEbda'a Almtamayeza
CR No.: 1294875
Sultanate of Oman
Tel: 90929600
      </div>
    </div>

    <div class="title-wrap">
      <div class="title-frame">
        <p class="ar">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</p>
        <hr>
        <p class="en">Receipt Voucher</p>
      </div>
    </div>

    <div class="meta">
      <div>Ø§Ù„Ù…Ø¨Ù†Ù‰: <b>${data.building || 'â€”'}</b></div>
      <div>Ø§Ù„ÙˆØ­Ø¯Ø©: <b>${data.unit || 'â€”'}</b> (${data.kindLabel || 'â€”'})</div>
      <div>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„: <b>${data.rcNo}</b></div>
      <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>${data.dateHeader}</b></div>
    </div>

    <table>
      <tr><th>Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„ÙØ§Ø¶Ù„</th><td>${data.payer || 'â€”'}</td></tr>
      <tr><th>Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡</th><td>${data.amountWords || (amountWordsAR(data.amount) + ' Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ')}</td></tr>
      <tr><th>(Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)</th><td>Ø±Ø¹ ${data.amount}</td></tr>
      <tr><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><td>${data.payMethod==='cheque'?'Ø´ÙŠÙƒ':(data.payMethod==='transfer'?'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ':'Ù†Ù‚Ø¯Ù‹Ø§')}</td></tr>
      ${payRow}
      <tr><th>Ø¨ØªØ§Ø±ÙŠØ®</th><td>${data.paidOn}</td></tr>
      <tr><th>ÙˆØ°Ù„Ùƒ Ø¹Ù†</th><td>${data.theFor}</td></tr>
    </table>

    <div class="sign">
      <div class="sig-block">
        <div class="label">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
        <img src="${STAMP_URL}" alt="signature" onerror="this.style.display='none'">
        <div class="line"></div>
      </div>
    </div>
  </div>
</body>
</html>`;

      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      setTimeout(()=>{ try{ w.print(); }catch(e){} }, 120);
      overlay.remove();
    };
  };

  // ØªÙÙˆÙŠØ¶ Ø¹Ø§Ù… Ù„Ø²Ø± [data-receipt]
  document.addEventListener('click', function(ev){
    const b = ev.target.closest?.('[data-receipt]');
    if(!b) return;
    ev.stopPropagation();
    ev.stopImmediatePropagation?.();
    openReceipt({
      tenantName: b.dataset.tenantName || '',
      unitNumber: b.dataset.unit || '',
      rent: parseFloat(b.dataset.rent||'0') || 0,
      kind: b.dataset.kind || '',
      phone: b.dataset.phone || '',
      idNumber: b.dataset.id || '',
      payDate: b.dataset.paydate || ''
    });
  }, {capture:true});
})();
</script>

</body>
</html>
